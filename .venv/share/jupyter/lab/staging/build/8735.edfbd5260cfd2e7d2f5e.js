"use strict";(self["webpackChunk_jupyterlab_application_top"]=self["webpackChunk_jupyterlab_application_top"]||[]).push([[8735],{64556:(e,t)=>{Object.defineProperty(t,"__esModule",{value:true});t.CellContextTracker=void 0;class n{constructor(e,t){this.activeCellEditorNode=null;this.lastCellContext=null;this._isDisposed=false;this.handleEditorEvent=e=>{try{const e=this.notebookTracker.activeCell;if(!e||!e.editor)return;const t=e.editor;const n=t.editor;if(!n)return;this.lastCellContext=this.getCmContext(n)}catch(t){console.error("Error in editor event handler:",t)}};this.notebookTracker=t;this.setupTrackers()}get isDisposed(){return this._isDisposed}setupTrackers(){this.notebookTracker.activeCellChanged.connect(this.setupCellListeners,this);this.notebookTracker.currentChanged.connect(this.handleNotebookChange,this)}handleNotebookChange(e,t){this.cleanupPreviousListeners();if(t&&t.content){const n=t.content.activeCell;this.setupCellListeners(e,n)}}setupCellListeners(e,t){if(!t)return;this.cleanupPreviousListeners();if(t.editor){try{const e=t.node;const n=e.querySelector(".jp-Editor")||e.querySelector(".jp-InputArea-editor");if(n){this.activeCellEditorNode=n;n.addEventListener("keydown",this.handleEditorEvent);n.addEventListener("mouseup",this.handleEditorEvent);const e=t.editor.editor;if(e){this.lastCellContext=this.getCmContext(e)}}}catch(n){console.error("Error setting up cell listeners:",n)}}}cleanupPreviousListeners(){if(this.activeCellEditorNode){this.activeCellEditorNode.removeEventListener("keydown",this.handleEditorEvent);this.activeCellEditorNode.removeEventListener("mouseup",this.handleEditorEvent);this.activeCellEditorNode=null}}getCmContext(e){const t=e.state;const n=t.selection.main.head;const o=t.doc.toString();const s=t.doc.lineAt(n);const i={line:s.number-1,column:n-s.from,offset:n};const r=100;const a=Math.max(0,n-r);const l=Math.min(o.length,n+r);return{text:o,position:i,contextBefore:o.substring(a,n),contextAfter:o.substring(n,l)}}getCurrentCellContext(){return this.lastCellContext}dispose(){if(this._isDisposed){return}this._isDisposed=true;this.cleanupPreviousListeners();this.notebookTracker.activeCellChanged.disconnect(this.setupCellListeners,this);this.notebookTracker.currentChanged.disconnect(this.handleNotebookChange,this)}}t.CellContextTracker=n},22485:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:true});t.registerCommands=i;const o=n(75037);const s=o.LabIcon.resolve({icon:"ui-components:jupyterlab"});function i(e,t,n,o){e.commands.addCommand("simple-extension:toggle-sidebar",{label:"Toggle AI Assistant Sidebar",icon:s,execute:()=>{if(o.isAttached){o.parent=null}else{e.shell.add(o,"left",{rank:9999})}}});t.addItem({command:"simple-extension:toggle-sidebar",category:"Extension"});n.add({command:"simple-extension:toggle-sidebar",category:"Other",rank:9999})}},72083:(e,t)=>{Object.defineProperty(t,"__esModule",{value:true});t.ApiClient=void 0;class n{constructor(e="http://localhost:8000"){this.baseUrl=e}async streamChat(e,t=null,n,o,s){try{const s=await fetch(`${this.baseUrl}/chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:e,context:t})});if(!s.ok){throw new Error(`API error: ${s.statusText}`)}if(!s.body){throw new Error("ReadableStream not supported in this browser.")}const i=s.body.getReader();const r=new TextDecoder;let a=false;while(!a){const{value:e,done:t}=await i.read();a=t;if(e){const t=r.decode(e,{stream:!a});n(t)}}o()}catch(i){s(i instanceof Error?i:new Error(String(i)))}}async healthCheck(){try{const e=await fetch(`${this.baseUrl}/health`);return e.ok}catch(e){console.error("API health check failed:",e);return false}}}t.ApiClient=n},40095:(e,t)=>{Object.defineProperty(t,"__esModule",{value:true});t.globals=void 0;t.initGlobals=n;t.globals={};function n(e,n){t.globals.app=e;t.globals.notebookTracker=n}},52061:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:true});t.extensionIcon=void 0;const o=n(75037);const s='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chat-left-text" viewBox="0 0 16 16">'+'<path d="M14 1a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H4.414A2 2 0 0 0 3 11.586l-2 2V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v12.793a.5.5 0 0 0 .854.353l2.853-2.853A1 1 0 0 1 4.414 12H14a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"/>'+'<path d="M3 3.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zM3 6a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9A.5.5 0 0 1 3 6zm0 2.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5z"/>'+"</svg>";t.extensionIcon=new o.LabIcon({name:"simple:icon",svgstr:s})},73595:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:true});t.HistoryHandler=void 0;const o=n(3233);class s{constructor(e,t,n,o){this.isHistoryViewActive=false;this.chatState=e;this.uiManager=t;this.callbacks=n;this.rendererCallbacks=o;this.historyContainer=this.uiManager.getUIElements().historyContainer}toggleHistoryView(){this.isHistoryViewActive=!this.isHistoryViewActive;if(this.isHistoryViewActive){this.uiManager.showHistoryView();this.renderChatHistory()}else{this.uiManager.showChatView();const e=this.chatState.getCurrentChat();if(e){this.callbacks.updateTitleInput(e.title)}}}renderChatHistory(){this.historyContainer.innerHTML="";const e=this.chatState.getChatHistory();const t=this.chatState.getCurrentChatId();if(e.length===0){this.historyContainer.innerHTML='<div class="jp-llm-ext-history-empty">No chat history yet.</div>';return}const n=document.createElement("ul");n.className="jp-llm-ext-history-list";e.forEach((e=>{const o=document.createElement("li");o.className="jp-llm-ext-history-item";if(e.id===t){o.classList.add("jp-llm-ext-active")}const s=document.createElement("div");s.className="jp-llm-ext-history-item-title";s.textContent=e.title||"Untitled Chat";o.appendChild(s);o.addEventListener("click",(()=>this.loadChat(e.id)));n.appendChild(o)}));this.historyContainer.appendChild(n)}loadChat(e){const t=this.chatState.getChatById(e);if(!t){console.error(`Chat with ID ${e} not found.`);return}this.chatState.setCurrentChatId(e);this.callbacks.updateTitleInput(t.title);this.callbacks.clearMessageContainer();t.messages.forEach((e=>{let t;if(e.sender==="user"){t=(0,o.renderUserMessage)(e.text,{isMarkdown:e.isMarkdown},this.rendererCallbacks)}else{t=(0,o.renderBotMessage)(e.text,{isMarkdown:e.isMarkdown},this.rendererCallbacks)}this.callbacks.addRenderedMessage(t)}));if(this.isHistoryViewActive){this.toggleHistoryView()}else{this.uiManager.scrollToBottom()}}}t.HistoryHandler=s},53508:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:true});t.InputHandler=void 0;const o=n(20281);const s=n(40095);class i{constructor(e,t){this.codeRefMap=new Map;this.nextRefId=1;this.hasAtSymbol=false;this.isMarkdownMode=false;this.isInputExpanded=false;this._handleKeyPress=e=>{if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();let t=this.chatInput.textContent||"";t=t.trim();if(t){this.callbacks.handleSendMessage(t)}}};this._handleInput=()=>{const e=this.chatInput.textContent||"";this.hasAtSymbol=e.includes("@")};this.chatInput=e;this.callbacks=t;this.chatInput.addEventListener("keypress",this._handleKeyPress);this.chatInput.addEventListener("input",this._handleInput)}dispose(){this.chatInput.removeEventListener("keypress",this._handleKeyPress);this.chatInput.removeEventListener("input",this._handleInput)}appendToInput(e){try{this.chatInput.focus();const t=window.getSelection();if(!t||t.rangeCount===0){console.error("Cannot append to input: No selection found.");this.chatInput.textContent=(this.chatInput.textContent||"")+e;return}const n=t.getRangeAt(0);const{startContainer:s,startOffset:i}=n;let r=this.chatInput.textContent||"";let a=(0,o.getCaretPosition)(this.chatInput);if(a>0&&r[a-1]==="@"){const t=r.slice(0,a-1);const n=r.slice(a);this.chatInput.textContent=t+e+n;(0,o.setCaretPosition)(this.chatInput,a-1+e.length)}else{const t=r.slice(0,a);const n=r.slice(a);this.chatInput.textContent=t+e+n;(0,o.setCaretPosition)(this.chatInput,a+e.length)}this.chatInput.dispatchEvent(new Event("input",{bubbles:true,cancelable:true}))}catch(t){console.error("Error appending to input:",t)}}clearInput(){this.chatInput.textContent="";this.resetCodeReferences();this.chatInput.style.height="";this.hasAtSymbol=false;if(this.isInputExpanded){this.toggleInputExpansion(false)}this.chatInput.dispatchEvent(new Event("input",{bubbles:true,cancelable:true}))}setMarkdownMode(e){this.isMarkdownMode=e;this.callbacks.updatePlaceholder(this.isMarkdownMode)}toggleInputExpansion(e){this.isInputExpanded=e!==undefined?e:!this.isInputExpanded;if(this.isInputExpanded){this.chatInput.style.height="200px";this.chatInput.style.resize="vertical";this.chatInput.style.overflowY="auto"}else{this.chatInput.style.height="";this.chatInput.style.resize="none";this.chatInput.style.overflowY="hidden"}this.callbacks.toggleInputExpansionUI(this.isInputExpanded)}addCodeReference(e,t,n,o,s){const i=`ref-${this.nextRefId++}`;const r={code:e,notebookName:t,cellIndex:n,lineNumber:o,lineEndNumber:s};this.codeRefMap.set(i,r);console.log("Added code reference:",i,"->",`(${t}, Cell ${n+1}, Line ${o}${o!==s?"_"+s:""}) `+e.substring(0,30)+"...");return i}getCodeReferenceMap(){return this.codeRefMap}resetCodeReferences(){console.log("[InputHandler] resetCodeReferences called!",(new Error).stack);this.codeRefMap.clear();this.nextRefId=1;console.log("Code references reset.")}resolveCodeReferences(e){if(this.codeRefMap.size===0){return e}const t=/\[(ref-\d+)\]/g;let n=e.replace(t,((e,t)=>{const n=this.codeRefMap.get(t);if(n){console.log("Resolving code reference:",t);return`\n\`\`\`\n${n.code}\n\`\`\`\n`}else{console.warn("Could not find code for reference:",t);return e}}));return n}handleInsertCodeReferenceFromShortcut(e){var t,n,o;const i=(t=s.globals.notebookTracker)===null||t===void 0?void 0:t.currentWidget;const r=(n=s.globals.notebookTracker)===null||n===void 0?void 0:n.activeCell;const a=r===null||r===void 0?void 0:r.editor;const l=a?a.editor:null;if(!i||!r||!a||!l||!l.state){console.error("Cannot insert code reference: Missing notebook, cell, or editor context.");return}try{const t=i.context.path;const n=((o=t.split("/").pop())===null||o===void 0?void 0:o.split(".")[0])||"notebook";const s=i.content.activeCellIndex;const r=l.state;const a=r.selection.main;const c=r.doc.lineAt(a.from).number;const d=r.doc.lineAt(a.to).number;if(s===undefined||s===null){console.error("Cannot insert code reference: Could not determine active cell index.");return}const u=this.addCodeReference(e,n,s,c,d);const p=c===d?`L${c}`:`L${c}-${d}`;const h=`@code(${n}:Cell ${s+1}:${p})`;this.chatInput.focus();const g=window.getSelection();if(!g||g.rangeCount===0){console.error("Cannot insert reference display text: No window selection found.");this.appendToInput(h+" ");return}const m=g.getRangeAt(0);const f=document.createTextNode(h+" ");m.deleteContents();m.insertNode(f);m.setStartAfter(f);m.setEndAfter(f);g.removeAllRanges();g.addRange(m);this.chatInput.dispatchEvent(new Event("input",{bubbles:true,cancelable:true}))}catch(c){console.error("Error handling insert code reference from shortcut:",c)}}setHasAtSymbol(e){this.hasAtSymbol=e}getHasAtSymbol(){return this.hasAtSymbol}}t.InputHandler=i},51527:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:true});t.MessageHandler=void 0;const o=n(3233);const s=n(44699);const i=n(40095);class r{constructor(e,t,n,o,s){this.apiClient=e;this.chatState=t;this.uiManager=n;this.rendererCallbacks=o;this.inputHandler=s}handleSendMessage(e){if(!e.trim())return;console.log(`[MessageHandler] Handling send: "${e}"`);this.addMessage(e,"user");this.streamAndRenderResponse(e)}handleSendAutoMessage(e){if(!e.trim())return;const t=e.charAt(0).toUpperCase()+e.slice(1);this.addMessage(t,"user",false,true);console.log("[MessageHandler] Creating action separator element...");const n=document.createElement("div");n.className="jp-llm-ext-action-separator";n.style.textAlign="center";n.style.margin="10px 0";n.style.fontSize="0.9em";n.style.color="var(--jp-ui-font-color2, grey)";if(e==="confirmed"){n.textContent="--------‚úÖ Confirmed--------"}else if(e==="rejected"){n.textContent="--------‚ùå Rejected--------"}else{n.textContent=`--------${t}--------`}console.log("[MessageHandler] Attempting to add separator element:",n);this.uiManager.addChatMessageElement(n);console.log("[MessageHandler] Separator element should be added.");this.streamAndRenderResponse(e)}addMessage(e,t,n=false,s=false){console.log(`[MessageHandler] Adding message: Sender=${t}, Markdown=${n}, Auto=${s}`);let r;const a=Object.assign(Object.assign({},this.rendererCallbacks),{getCodeRefData:e=>this.inputHandler.getCodeReferenceMap().get(e),getCurrentNotebookContext:()=>{var e,t;const n=(e=i.globals.notebookTracker)===null||e===void 0?void 0:e.currentWidget;if(n===null||n===void 0?void 0:n.context){const e=n.context.path;const o=((t=e.split("/").pop())===null||t===void 0?void 0:t.split(".")[0])||"notebook";return{name:o,path:e}}return undefined}});if(t==="user"){r=(0,o.renderUserMessage)(e,{isMarkdown:n},a)}else{const t=!s;r=(0,o.renderBotMessage)(e,{isMarkdown:t},a)}this.uiManager.addChatMessageElement(r);if(!s){const o={sender:t,text:e,isMarkdown:n};this.chatState.addMessageToCurrentChat(o)}}streamAndRenderResponse(e){const{streamingDiv:t,contentDiv:n}=this.uiManager.createBotMessageContainer();let i="";const r=(0,s.getCurrentCellContent)();this.apiClient.streamChat(e,{cellContext:r},(e=>{i+=e;t.textContent=i;this.uiManager.scrollToBottom()}),(()=>{var e;t.style.display="none";n.style.display="block";const s=(0,o.renderBotMessage)(i,{isMarkdown:true},this.rendererCallbacks);n.innerHTML="";while(s.firstChild){if(!((e=s.firstChild.classList)===null||e===void 0?void 0:e.contains("markdown-indicator"))){n.appendChild(s.firstChild)}else{s.removeChild(s.firstChild)}}const r=i.trim().startsWith("/images/");const a={text:i,sender:"bot",isMarkdown:!r};this.chatState.addMessageToCurrentChat(a);this.uiManager.scrollToBottom()}),(e=>{t.style.display="none";n.style.display="block";n.innerHTML=`<div class="jp-llm-ext-error-message">Error: ${e.message}</div>`;console.error("API Error:",e);this.uiManager.scrollToBottom()}))}}t.MessageHandler=r},5709:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:true});t.PopupMenuManager=void 0;const o=n(40095);class s{constructor(e,t,n){this.currentMenuLevel="top";this.currentMenuPath="";this.menuHistory=[];this.currentNotebook=null;this.selectedMenuItemIndex=-1;this.isRenderingContent=false;this.lastSearchTerm="";this.allowedExtensions=[".py",".ipynb",".md",".json",".txt",".csv"];this.fileCache=new Map;this.docManager=e;this.widgetNode=t;this.callbacks=n;this.popupMenuContainer=document.createElement("div");this.popupMenuContainer.className="jp-llm-ext-popup-menu-container";this.popupMenuContainer.style.display="none";this.widgetNode.appendChild(this.popupMenuContainer);this.searchInput=document.createElement("input");this.searchInput.type="text";this.searchInput.placeholder="Search...";this.searchInput.className="jp-llm-ext-popup-menu-search";this.searchInput.addEventListener("input",(()=>{if(this.searchInput.value!==this.lastSearchTerm){this.lastSearchTerm=this.searchInput.value;this.renderMenuContent()}}));this.searchInput.addEventListener("keydown",(e=>{console.log(`POPUP Search KeyDown: Key='${e.key}'`);if(["ArrowUp","ArrowDown","Enter","Tab","Escape"].includes(e.key)){console.log("POPUP (Search Input): Stopping propagation for navigation key:",e.key);if(e.key==="Escape"){this.hidePopupMenu()}else if(e.key==="Enter"){const e=this.getMenuItems();if(e.length>0){this.selectedMenuItemIndex=0;this.updateSelectionHighlight()}}else if(e.key==="ArrowDown"||e.key==="ArrowUp"){}e.stopPropagation()}}),true);document.addEventListener("click",this.handleDocumentClick.bind(this),true);this.boundHandleKeyDown=this.handleKeyDown.bind(this);document.addEventListener("keydown",this.boundHandleKeyDown,true);if(o.globals.notebookTracker){this.currentNotebook=o.globals.notebookTracker.currentWidget;o.globals.notebookTracker.currentChanged.connect(((e,t)=>{this.currentNotebook=t}))}}dispose(){document.removeEventListener("click",this.handleDocumentClick.bind(this),true);document.removeEventListener("keydown",this.boundHandleKeyDown,true);if(this.popupMenuContainer.parentNode===this.widgetNode){this.popupMenuContainer.parentNode.removeChild(this.popupMenuContainer)}}handleDocumentClick(e){if(this.popupMenuContainer.style.display!=="none"&&!this.popupMenuContainer.contains(e.target)){const t=this.widgetNode.querySelector("#jp-llm-ext-at-button");if(t&&t.contains(e.target)){console.log("POPUP: Click was on the @ button, not hiding.");return}console.log("POPUP: Click detected outside the menu.");this.hidePopupMenu()}}async showPopupMenu(e,t){console.log(`POPUP: Showing menu at (${e}, ${t})`);this._anchorX=e;this._anchorY=t;if(this.popupMenuContainer.style.display==="none"){this.currentMenuLevel="top";this.currentMenuPath="";this.menuHistory=[];this.searchInput.value="";this.lastSearchTerm="";await this.setCurrentDirectoryPath()}await this.renderMenuContent();this.widgetNode.appendChild(this.popupMenuContainer);setTimeout((()=>{console.log("POPUP: Deferred updatePopupPosition call.");try{this.updatePopupPosition()}catch(e){console.error("POPUP: Error during deferred updatePopupPosition:",e)}if(this.currentMenuLevel==="files"||this.currentMenuLevel==="directories"){this.searchInput.focus();console.log("POPUP: Focused search input after deferred positioning.");this.selectedMenuItemIndex=-1}else{this.selectedMenuItemIndex=-1;this.selectNextMenuItem()}}),0)}hidePopupMenu(){if(this.popupMenuContainer.style.display!=="none"){console.log("POPUP: Hiding menu. Called from:",(new Error).stack);this.popupMenuContainer.style.display="none";this.currentMenuLevel="top"}}async renderMenuContent(){if(this.isRenderingContent){console.log("POPUP: Skipping render - already rendering");return}this.isRenderingContent=true;try{while(this.popupMenuContainer.firstChild){this.popupMenuContainer.removeChild(this.popupMenuContainer.firstChild)}if(this.currentMenuLevel!=="top"){this.popupMenuContainer.appendChild(this.searchInput);this.searchInput.value="";this.lastSearchTerm=""}switch(this.currentMenuLevel){case"top":this.renderTopLevelItems();break;case"files":case"directories":await this.renderDirectoryBrowserItems();break;case"cells":await this.renderCellItems();break}this.selectedMenuItemIndex=-1;this.updateSelectionHighlight();console.log("POPUP: ===> About to call updatePopupPosition after renderMenuContent");try{this.updatePopupPosition()}catch(e){console.error("POPUP: Error calling updatePopupPosition after render:",e)}}catch(t){console.error("POPUP: Error rendering menu content",t)}finally{this.isRenderingContent=false}}renderTopLevelItems(){const e=[{label:"Code",description:"",actionId:"insert-code"},{label:"Cells",description:"",actionId:"browse-cells"},{label:"File",description:"",actionId:"browse-files"},{label:"Directory",description:"",actionId:"browse-directories"}];e.forEach((e=>{const t=this.createMenuItem(e.label,e.actionId,"",e.description);this.popupMenuContainer.appendChild(t)}))}async renderDirectoryBrowserItems(){var e;const t=this.searchInput.value.toLowerCase().trim();const n=this.createMenuItem("Loading...","loading","","");n.style.pointerEvents="none";const o=(e=this.popupMenuContainer.querySelector(".jp-llm-ext-popup-menu-path"))===null||e===void 0?void 0:e.nextSibling;this.popupMenuContainer.insertBefore(n,o||null);try{const e=this.currentMenuLevel==="files"?"file":"directory";const o=await this.listCurrentDirectoryContents(this.currentMenuPath,e);if(this.popupMenuContainer.contains(n)){this.popupMenuContainer.removeChild(n)}if(o&&o.length>0){const n=o.filter((e=>e.name.toLowerCase().includes(t)||e.relativePath.toLowerCase().includes(t)));if(n.length>0){n.forEach((e=>{const t=e.name;const n=e.type;const o=e.path;const s=e.relativePath;const i=n==="directory"?"üìÅ":"üìÑ";let r;if(n==="directory"){r=this.currentMenuLevel==="files"?"select-directory-navigate":"select-directory-callback"}else{r="select-file"}const a=this.createMenuItem(`${i} ${t}`,r,o,s!=="."?s:"");this.popupMenuContainer.appendChild(a)}))}else{const n=this.createMenuItem(t?"No matches found":`No ${e}s found`,"empty","","");n.style.pointerEvents="none";this.popupMenuContainer.appendChild(n)}}else{const e=this.createMenuItem(`No items found in this directory`,"empty","","");e.style.pointerEvents="none";this.popupMenuContainer.appendChild(e)}}catch(s){if(this.popupMenuContainer.contains(n)){this.popupMenuContainer.removeChild(n)}const e=this.createMenuItem(`Error: ${s}`,"error","","");e.style.color="red";e.style.pointerEvents="none";this.popupMenuContainer.appendChild(e);console.error("POPUP: Error loading/filtering directory contents:",s)}}async renderCellItems(){var e,t;const n=this.searchInput.value.toLowerCase().trim();const o=this.createMenuItem("Loading cells...","loading","","");o.style.pointerEvents="none";const s=(e=this.popupMenuContainer.querySelector(".jp-llm-ext-popup-menu-path"))===null||e===void 0?void 0:e.nextSibling;this.popupMenuContainer.insertBefore(o,s||null);try{if(!this.currentNotebook||!this.currentNotebook.content||!this.currentNotebook.content.model){if(this.popupMenuContainer.contains(o)){this.popupMenuContainer.removeChild(o)}const e=this.createMenuItem("No active notebook found","error","","");e.style.color="red";e.style.pointerEvents="none";this.popupMenuContainer.appendChild(e);return}const e=this.currentNotebook.content.model;const s=e.cells;if(this.popupMenuContainer.contains(o)){this.popupMenuContainer.removeChild(o)}if(!s||s.length===0){const e=this.createMenuItem("No cells in notebook","empty","","");e.style.pointerEvents="none";this.popupMenuContainer.appendChild(e);return}let i=0;for(let o=0;o<s.length;o++){const e=s.get(o);const r=e.type;const a=e.sharedModel?e.sharedModel.getSource():((t=e.toJSON())===null||t===void 0?void 0:t.source)||"";const l=r==="code"?e.executionCount!==undefined&&e.executionCount!==null?e.executionCount:"*":"";const c=typeof a==="string"?a:Array.isArray(a)?a.join("\n"):"";const d=c.split("\n")[0]||"";const u=d.length>30?d.substring(0,30)+"...":d;const p=r==="markdown"?"M":"C";const h=l!==""?`[${l}]`:"";const g=this.createMenuItem("","select-cell",o.toString());const m=document.createElement("span");m.className=`cell-type-indicator cell-type-${r==="markdown"?"md":"code"}`;m.textContent=p;const f=document.createElement("span");f.className="cell-exec-count";f.textContent=h;f.style.marginRight="8px";const C=document.createElement("span");C.className="cell-content-preview";C.textContent=u;const v=g.querySelector("span");if(v){v.textContent="";v.appendChild(m);if(h){v.appendChild(f)}v.appendChild(C)}const y=`${p} ${h} ${u}`.toLowerCase();if(n&&!y.includes(n)){continue}this.popupMenuContainer.appendChild(g);i++}if(i===0){const e=this.createMenuItem("No matching cells found","empty","","");e.style.pointerEvents="none";this.popupMenuContainer.appendChild(e)}}catch(i){if(this.popupMenuContainer.contains(o)){this.popupMenuContainer.removeChild(o)}const e=this.createMenuItem(`Error: ${i}`,"error","","");e.style.color="red";e.style.pointerEvents="none";this.popupMenuContainer.appendChild(e);console.error("POPUP: Error loading notebook cells:",i)}}createMenuItem(e,t,n="",o=""){const s=document.createElement("div");s.className="jp-llm-ext-popup-menu-item";s.dataset.actionId=t;if(n){s.dataset.path=n}s.onclick=e=>this.handleMenuClick(e);const i=document.createElement("span");i.textContent=e;s.appendChild(i);if(o){const e=document.createElement("span");e.className="jp-llm-ext-popup-menu-path-indicator";e.textContent=o;e.style.fontSize="0.85em";e.style.color="var(--jp-ui-font-color2)";e.style.marginLeft="8px";e.style.opacity="0.8";e.style.display="inline-block";s.appendChild(e)}return s}async handleMenuClick(e){var t;const n=e.currentTarget;const o=n.dataset.actionId;const s=n.dataset.path||"";console.log(`POPUP: Menu item clicked. Action: ${o}, Path: ${s}`);switch(o){case"navigate-back":this.navigateBackMenu();break;case"insert-code":{const e=this.callbacks.getSelectedText?this.callbacks.getSelectedText():null;if(e){const t=[{label:"Insert as plain code",actionId:"insert-plain-code",data:e},{label:"Insert as collapsed reference",actionId:"collapse-code-ref",data:e}];this.popupMenuContainer.innerHTML="";t.forEach((e=>{const t=this.createMenuItem(e.label,e.actionId,e.data);this.popupMenuContainer.appendChild(t)}));const n=this.createMenuItem("Back","navigate-back");n.style.borderTop="1px solid var(--jp-border-color1)";this.popupMenuContainer.appendChild(n);return}else{const e=this.callbacks.getCurrentCellContent?this.callbacks.getCurrentCellContent():null;if(e){this.callbacks.insertCode(e)}}this.hidePopupMenu();break}case"insert-plain-code":{if(s){this.callbacks.insertCode(s);this.hidePopupMenu()}break}case"collapse-code-ref":{if(s&&this.currentNotebook){try{const e=this.currentNotebook.context.path;const n=((t=e.split("/").pop())===null||t===void 0?void 0:t.split(".")[0])||"notebook";const o=this.currentNotebook.content.activeCell;if(!o){throw new Error("No active cell found")}const i=this.currentNotebook.content.activeCellIndex;let r=1;if(o.editor){const e=o.editor;const t=e.getCursorPosition();if(t){r=t.line+1}}this.callbacks.insertCollapsedCodeRef(s,i,r,n);this.hidePopupMenu()}catch(i){console.error("Error creating collapsed code reference:",i);this.callbacks.insertCode(s);this.hidePopupMenu()}}else{if(s){this.callbacks.insertCode(s)}this.hidePopupMenu()}break}case"browse-cells":await this.navigateMenu("cells","");this.searchInput.value="";break;case"browse-files":await this.navigateMenu("files",this.currentMenuPath||"");this.searchInput.value="";break;case"browse-directories":await this.navigateMenu("directories",this.currentMenuPath||"");this.searchInput.value="";break;case"select-cell":if(s){const e=parseInt(s);if(!isNaN(e)){this.callbacks.insertCellByIndex(e);this.hidePopupMenu()}else{console.error("POPUP: Invalid cell index.")}}else{console.error("POPUP: Cell selected but index (path) is missing.")}break;case"select-file":if(s){this.callbacks.insertFilePath(s);this.hidePopupMenu()}else{console.error("POPUP: File selected but path is missing.")}break;case"select-directory-navigate":if(s){const e=`${s}:${this.currentMenuLevel==="files"?"file":"directory"}`;this.fileCache.delete(e);const t=this.currentMenuLevel==="files"||this.currentMenuLevel==="directories"?this.currentMenuLevel:"files";await this.navigateMenu(t,s);this.searchInput.value=""}else{console.error("POPUP: Directory selected for navigation but path is missing.")}break;case"select-directory-callback":if(s){this.callbacks.insertDirectoryPath(s);this.hidePopupMenu()}else{console.error("POPUP: Directory selected for callback but path is missing.")}break;case"placeholder-action":console.log("Placeholder action triggered.");this.hidePopupMenu();break;case"loading":case"empty":case"error":break;default:console.warn("Unknown menu action:",o);this.hidePopupMenu();break}e.stopPropagation()}async navigateMenu(e,t){console.log(`POPUP: Navigating to level: ${e}, path: ${t}`);if(this.currentMenuLevel!==e||this.currentMenuPath!==t){this.menuHistory.push({level:this.currentMenuLevel,path:this.currentMenuPath})}this.currentMenuLevel=e;this.currentMenuPath=t;await this.renderMenuContent();if(e==="files"||e==="directories"){setTimeout((()=>this.searchInput.focus()),0);this.selectedMenuItemIndex=-1}else{this.selectedMenuItemIndex=-1;setTimeout((()=>this.selectNextMenuItem()),0)}}navigateBackMenu(){const e=this.menuHistory.pop();if(e){console.log(`POPUP: Navigating back to level: ${e.level}, path: ${e.path}`);this.currentMenuLevel=e.level;this.currentMenuPath=e.path;this.renderMenuContent().then((()=>{if(this.currentMenuLevel==="files"||this.currentMenuLevel==="directories"){setTimeout((()=>this.searchInput.focus()),0);this.selectedMenuItemIndex=-1}else{this.selectedMenuItemIndex=-1;setTimeout((()=>this.selectNextMenuItem()),0)}}))}else{console.log("POPUP: Already at the top level.");this.hidePopupMenu()}}async listCurrentDirectoryContents(e,t){console.log(`POPUP: Listing directory contents for path: '${e}', filter: ${t||"all"}`);const n=`${e}:${t||"all"}`;if(this.fileCache.has(n)){console.log("POPUP: Using cached directory contents");return this.fileCache.get(n)||null}try{const o=e==="/"?"":e;const s=o.endsWith("/")&&o.length>1?o.slice(0,-1):o;let i=[];const r=await this.docManager.services.contents.get(s||"");if(r.type!=="directory"){console.error("Path is not a directory:",e);return null}for(const e of r.content){const n=e.type==="directory"?"directory":"file";if(n==="directory"&&(t==="directory"||t===undefined)){i.push({name:e.name,path:e.path,type:"directory",relativePath:`./${e.name}`})}if(n==="file"&&(t==="file"||t===undefined)){const t=`.${e.name.split(".").pop()}`.toLowerCase();if(this.allowedExtensions.includes(t)){i.push({name:e.name,path:e.path,type:"file",relativePath:`./${e.name}`})}}}i=i.sort(((e,n)=>{if(t==="directory"){return e.name.localeCompare(n.name)}if(t==="file"){return e.name.localeCompare(n.name)}if(e.type==="directory"&&n.type!=="directory")return-1;if(e.type!=="directory"&&n.type==="directory")return 1;return e.name.localeCompare(n.name)}));this.fileCache.set(n,i);console.log(`POPUP: Found ${i.length} items for path '${e}'`);return i}catch(o){console.error(`POPUP: Error listing directory contents for '${e}':`,o);return null}}async setCurrentDirectoryPath(){var e;let t=null;const n=o.globals.app;if(!n){console.error("POPUP: Application reference not available");this.currentMenuPath="";return}const s=n.shell.currentWidget;if(s){const e=this.docManager.contextForWidget(s);if(e){const n=e.path;t=this.getParentDirectory(n);console.log(`POPUP: Path from current widget context: ${n} -> ${t}`)}}if(t===null&&this.currentNotebook&&this.currentNotebook.context){const e=this.currentNotebook.context.path;if(typeof e==="string"){t=this.getParentDirectory(e);console.log(`POPUP: Path from active notebook: ${e} -> ${t}`)}}if(t===null){try{const o=Array.from(n.shell.widgets("left"));const s=o.find((e=>e.id==="filebrowser"));if(s&&typeof((e=s.model)===null||e===void 0?void 0:e.path)==="string"){t=s.model.path;console.log(`POPUP: Path from file browser widget model: ${t}`)}else{console.log("POPUP: File browser widget path not directly accessible.")}}catch(i){console.warn("POPUP: Could not get path from file browser.",i)}}if(t===null){t="";console.log("POPUP: Falling back to server root path.")}this.currentMenuPath=t;console.log(`POPUP: Initial current menu path set to: '${this.currentMenuPath}'`)}getParentDirectory(e){if(!e)return"";const t=Math.max(e.lastIndexOf("/"),e.lastIndexOf("\\"));if(t===-1)return"";return e.substring(0,t)}handleKeyDown(e){if(!this.isPopupMenuVisible()){return}console.log(`POPUP Document KeyDown: Key='${e.key}', Target=`,e.target);if(e.metaKey||e.ctrlKey){return}if(e.target===this.searchInput){console.log("POPUP (Document): Key event target is search input, skipping document handler.");if(["ArrowUp","ArrowDown","Enter","Tab","Escape"].includes(e.key)){if(e.key==="ArrowUp"||e.key==="ArrowDown"){this.searchInput.blur();e.preventDefault();this.processMenuNavigation(e.key)}else if(e.key==="Enter"){this.searchInput.blur();e.preventDefault();this.processMenuNavigation(e.key)}else if(e.key==="Tab"){this.searchInput.blur()}else if(e.key==="Escape"){e.stopPropagation()}}else{return}}else{this.processMenuNavigation(e.key);if(["ArrowUp","ArrowDown","Enter","Tab","Escape"].includes(e.key)){e.preventDefault();e.stopPropagation()}}}processMenuNavigation(e){switch(e){case"ArrowDown":console.log("POPUP: Arrow Down pressed");this.selectNextMenuItem();break;case"ArrowUp":console.log("POPUP: Arrow Up pressed");this.selectPreviousMenuItem();break;case"Enter":case"Tab":console.log(`POPUP: ${e} pressed`);if(this.selectedMenuItemIndex>=0){const e=this.getMenuItems();if(e[this.selectedMenuItemIndex]){console.log("POPUP: Simulating click on selected item:",e[this.selectedMenuItemIndex].textContent);e[this.selectedMenuItemIndex].click()}else{console.log("POPUP: Selected index out of bounds?")}}else{console.log("POPUP: Enter/Tab pressed but no item selected");const e=this.getMenuItems();if(e.length>0){e[0].click()}}break;case"Escape":console.log("POPUP: Escape pressed");if(this.menuHistory.length>0){this.navigateBackMenu()}else{this.hidePopupMenu()}break}}updateSelectionHighlight(){const e=this.getMenuItems();e.forEach(((e,t)=>{if(t===this.selectedMenuItemIndex){e.classList.add("jp-llm-ext-popup-menu-item-selected");e.scrollIntoView({block:"nearest"})}else{e.classList.remove("jp-llm-ext-popup-menu-item-selected")}}))}deselectAllMenuItems(){const e=this.getMenuItems();e.forEach((e=>{e.classList.remove("jp-llm-ext-popup-menu-item-selected")}));this.selectedMenuItemIndex=-1}selectNextMenuItem(){const e=this.getMenuItems();if(e.length===0)return;this.selectedMenuItemIndex++;if(this.selectedMenuItemIndex>=e.length){this.selectedMenuItemIndex=0}this.updateSelectionHighlight();console.log(`POPUP: Selected item index: ${this.selectedMenuItemIndex}`)}selectPreviousMenuItem(){const e=this.getMenuItems();if(e.length===0)return;this.selectedMenuItemIndex--;if(this.selectedMenuItemIndex<0){this.selectedMenuItemIndex=e.length-1}this.updateSelectionHighlight();console.log(`POPUP: Selected item index: ${this.selectedMenuItemIndex}`)}getMenuItems(){return Array.from(this.popupMenuContainer.querySelectorAll(".jp-llm-ext-popup-menu-item"))}updatePopupPosition(){if(!this.widgetNode)return;const e=this.widgetNode.getBoundingClientRect();let t;let n;if(this._anchorX!==undefined&&this._anchorY!==undefined){console.log(`POPUP: Positioning based on anchor point: (${this._anchorX}, ${this._anchorY})`);t=this._anchorY;n=this._anchorX}else{console.warn("POPUP: Cannot update position - no anchor point provided.");return}this.popupMenuContainer.style.visibility="hidden";this.popupMenuContainer.style.display="block";const o=this.popupMenuContainer.offsetHeight;const s=this.popupMenuContainer.offsetWidth;let i=t-e.top-o;let r=n-e.left;const a=this.widgetNode.clientWidth;const l=this.widgetNode.clientHeight;if(r<0){r=5;console.log("POPUP Adjust: Corrected left edge")}if(r+s>a){r=a-s-5;console.log("POPUP Adjust: Corrected right edge")}if(i<0){const n=l-(t-e.top+10);if(n>=o){i=t-e.top+10;console.log("POPUP Adjust: Flipping below target (was off top)")}else{i=5;console.log("POPUP Adjust: Clamped to top edge (no space below)")}}console.log(`POPUP: Setting position - Top: ${i}px, Left: ${r}px (Relative to Widget)`);this.popupMenuContainer.style.top=`${i}px`;this.popupMenuContainer.style.left=`${r}px`;this.popupMenuContainer.style.display="block";this.popupMenuContainer.style.visibility="visible"}isPopupMenuVisible(){return this.popupMenuContainer.style.display!=="none"}getCurrentMenuLevel(){return this.currentMenuLevel}}t.PopupMenuManager=s},71857:(e,t)=>{Object.defineProperty(t,"__esModule",{value:true});t.SettingsHandler=void 0;class n{constructor(e,t,n){this.state=e;this.settingsModalContainer=t;this.uiManager=n}showModal(){const e=this.state.getSettings();if(e){try{this.settingsModalContainer.querySelector("#settings-provider").value=e.provider;this.settingsModalContainer.querySelector("#settings-api-key").value=e.apiKey;this.settingsModalContainer.querySelector("#settings-api-url").value=e.apiUrl;this.settingsModalContainer.querySelector("#settings-rules").value=e.rules}catch(t){console.error("Error populating settings form:",t)}}this.settingsModalContainer.style.display="flex"}hideModal(){this.settingsModalContainer.style.display="none"}saveSettings(){var e,t,n,o;const s=(e=this.settingsModalContainer.querySelector("#settings-provider"))===null||e===void 0?void 0:e.value;const i=(t=this.settingsModalContainer.querySelector("#settings-api-key"))===null||t===void 0?void 0:t.value;const r=(n=this.settingsModalContainer.querySelector("#settings-api-url"))===null||n===void 0?void 0:n.value;const a=(o=this.settingsModalContainer.querySelector("#settings-rules"))===null||o===void 0?void 0:o.value;if(s===undefined||i===undefined||r===undefined||a===undefined){console.error("Could not find all settings input elements.");this.showNotification("Error: Could not save settings. Input elements missing.","error");return}const l={provider:s,apiKey:i,apiUrl:r,rules:a};try{this.state.saveSettings(l);console.log("Settings saved via SettingsState:",l);console.log("API Client needs reconfiguration with new settings.");this.hideModal();this.showNotification("Settings saved successfully","success")}catch(c){console.error("Error saving settings:",c);this.showNotification(`Error saving settings: ${c}`,"error")}}showNotification(e,t){if(this.uiManager&&typeof this.uiManager.showNotification==="function"){this.uiManager.showNotification(e,t)}else{console.log(`Notification (${t}): ${e}`)}}}t.SettingsHandler=n},73238:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:true});t.setupShortcuts=r;t.removeShortcuts=a;const o=n(44699);const s=n(40095);let i=null;function r(e,t,n){if(i){console.warn("Shortcuts already set up. Removing previous listener.");a()}i=i=>{var r,a,l;const{showIndicator:c,appendToInput:d,showWidget:u,focusInput:p}=n;if(i.key==="@"||i.shiftKey&&i.key==="2"){console.log("SHORTCUT HANDLER: '@' key or SHIFT+2 detected");const e=document.activeElement;const n=e&&e.getAttribute("contenteditable")==="true"&&e.classList.contains("jp-llm-ext-input-field");if(!n){console.log("SHORTCUT HANDLER: Input field is NOT active element. Handling '@' globally.");i.preventDefault();i.stopPropagation();u();p();window.setTimeout((()=>{const e=document.querySelector(".jp-llm-ext-input-field");if(e){const n=window.getSelection();if(n){if(document.activeElement!==e){e.focus()}let o;if(n.rangeCount>0){o=n.getRangeAt(0);if(!e.contains(o.commonAncestorContainer)){console.log("SHORTCUT HANDLER: Range is not inside the input field after focus. Creating new range.");o=document.createRange();o.selectNodeContents(e);o.collapse(false);n.removeAllRanges();n.addRange(o)}}else{console.log("SHORTCUT HANDLER: No range found after focus. Creating new range.");o=document.createRange();o.selectNodeContents(e);o.collapse(false);n.removeAllRanges();n.addRange(o)}const s=document.createTextNode("@");o.deleteContents();o.insertNode(s);o.setStartAfter(s);o.setEndAfter(s);n.removeAllRanges();n.addRange(o);window.setTimeout((()=>{console.log("SHORTCUT HANDLER: Showing popup after focusing, inserting '@', and nested timeout.");const e=window.getSelection();if(e&&e.rangeCount>0){const n=e.getRangeAt(0);const o="jp-llm-shortcut-popup-anchor";let s=document.getElementById(o);if(s)s.remove();s=document.createElement("span");s.id=o;s.style.visibility="hidden";s.style.width="0";s.style.overflow="hidden";s.textContent="‚Äã";n.insertNode(s);const i=s.getBoundingClientRect();s.remove();if(i.top===0&&i.left===0){console.error("SHORTCUT HANDLER: Failed to get valid coordinates from temp anchor span.")}else{console.log(`SHORTCUT HANDLER: Anchor coords from temp span: Top=${i.top}, Left=${i.left}`);t.showPopupMenu(i.left,i.top);c("Browsing references...")}}else{console.error("SHORTCUT HANDLER: Could not get range immediately before showing popup.")}}),0)}else{console.log("SHORTCUT HANDLER: No selection object after focus, cannot insert '@' or show popup reliably.")}}else{console.log("SHORTCUT HANDLER: Could not find input element after timeout.")}}),50)}else{console.log("SHORTCUT HANDLER: Input field IS active element. Letting default '@' behavior proceed.")}}else if(i.ctrlKey&&i.key.toLowerCase()==="l"){i.preventDefault();i.stopPropagation();const t=(0,o.getSelectedText)();const n=(0,o.isInNotebookCellAndEditorFocused)();const h=(0,o.isInNotebookCell)();const g=(l=(a=(r=s.globals.notebookTracker)===null||r===void 0?void 0:r.currentWidget)===null||a===void 0?void 0:a.content)===null||l===void 0?void 0:l.activeCellIndex;let m=false;if(n&&t){e.handleInsertCodeReferenceFromShortcut(t);c("Code reference inserted");m=true}else if(h&&g!==undefined&&g!==null){d(`@Cell[${g+1}]`);c("Cell reference inserted");m=true}else{c("Cannot insert reference: Select code or an active cell.");m=true}if(m){u();p()}}};document.addEventListener("keydown",i)}function a(){if(i){document.removeEventListener("keydown",i);i=null;console.log("Removed keyboard shortcuts.")}else{console.warn("Attempted to remove shortcuts, but none were active.")}}},88735:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:true});t.ApiClient=void 0;const o=n(18093);const s=n(96312);const i=n(89275);const r=n(86043);const a=n(43820);const l=n(40095);const c=n(22485);const d=n(64556);n(56531);var u=n(72083);Object.defineProperty(t,"ApiClient",{enumerable:true,get:function(){return u.ApiClient}});const p={id:"jupyter-simple-extension:plugin",autoStart:true,requires:[o.ILauncher,s.ICommandPalette,i.INotebookTracker,r.IDocumentManager],activate:(e,t,n,o,s)=>{console.log("JupyterLab extension jupyter-simple-extension is activated!");(0,l.initGlobals)(e,o);l.globals.cellContextTracker=new d.CellContextTracker(e,o);const i=new a.SimpleSidebarWidget(s);e.shell.add(i,"left",{rank:9999});(0,c.registerCommands)(e,n,t,i)}};t["default"]=p},43820:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:true});t.SimpleSidebarWidget=void 0;const o=n(1143);const s=n(52061);const i=n(72083);const r=n(5709);const a=n(73238);const l=n(96576);const c=n(55157);const d=n(19411);const u=n(92352);const p=n(53508);const h=n(51527);const g=n(73595);const m=n(71857);const f=n(89048);const C=n(75037);const v=n(40095);const y=n(48939);const b=n(44699);class M extends o.Widget{createWidgetSpan(e,t){if(!e)return;let n=t;if(t.startsWith("@file ")||t.startsWith("@dir ")){const e=t.split(" ");if(e.length>1){const t=e[1].split(/[\\/]/);n=t[t.length-1]||e[1]}}else if(t.startsWith("@Cell ")){n=t.substring(1)}const o=document.createElement("span");o.className="jp-llm-ext-ref-widget";o.setAttribute("contenteditable","false");o.setAttribute("data-ref-text",t);o.textContent=n;e.deleteContents();e.insertNode(o);const s=window.getSelection();if(s){const e=document.createRange();e.setStartAfter(o);e.setEndAfter(o);s.removeAllRanges();s.addRange(e)}}constructor(e){super();this.handleNewChat=()=>{var e;console.log("Handle New Chat clicked");const t=this.chatState.createNewChat();(e=this.historyHandler)===null||e===void 0?void 0:e.loadChat(t.id)};this.handleToggleHistory=()=>{console.log("Handle Toggle History clicked");this.historyHandler.toggleHistoryView()};this.handleSendMessage=e=>{if(!e.trim())return;console.log(`[Widget] handleSendMessage: Text='${e}'`);this.messageHandler.handleSendMessage(e)};this.handleShowSettings=e=>{console.log("Handle Show Settings clicked");this.settingsHandler.showModal()};this.handleShowPopupMenu=(e,t)=>{console.log("Handle Show Popup Menu clicked");const n=t.getBoundingClientRect();this.popupMenuManager.showPopupMenu(n.left,n.bottom+5)};this.handleUpdateTitle=()=>{var e;const t=((e=this.layoutElements.titleInput)===null||e===void 0?void 0:e.value)||"Chat";console.log("Handle Update Title called:",t);this.chatState.updateCurrentChatTitle(t)};this.docManager=e;this.id="simple-sidebar";this.title.label="";this.title.caption="AI Chat Interface";this.title.icon=s.extensionIcon;this.title.closable=true;this.addClass("jp-llm-ext-sidebar");this.settingsState=new u.SettingsState;const t=this.settingsState.getSettings();this.apiClient=new i.ApiClient((t===null||t===void 0?void 0:t.apiUrl)||undefined);this.chatState=new d.ChatState;this.popupMenuManager=new r.PopupMenuManager(this.docManager,this.node,{insertCode:e=>{var t,n,o;if(!this.inputHandler||!v.globals.notebookTracker)return;const s=v.globals.notebookTracker.currentWidget;if(!s||!s.context||!s.content){console.warn("Could not get notebook context for code reference, inserting raw code as fallback.");(t=this.inputHandler)===null||t===void 0?void 0:t.appendToInput(e);return}const i=s.context.path;const r=((n=i.split("/").pop())===null||n===void 0?void 0:n.split(".")[0])||"notebook";const a=s.content.activeCell;if(!a){console.warn("Could not get active cell for code reference, inserting raw code as fallback.");(o=this.inputHandler)===null||o===void 0?void 0:o.appendToInput(e);return}const l=s.content.activeCellIndex;let c=1;let d=1;console.log("Are we currently in a code cell?");console.log(a.editor);if(a.editor){const e=a.editor;const t=e.editor;if(t&&t.state){const n=t.state;const o=n.selection.main;if(!o.empty){c=n.doc.lineAt(o.from).number;d=n.doc.lineAt(o.to).number}else{const t=e.getCursorPosition();if(t){c=t.line+1;d=c}}}else{console.warn("Could not access CodeMirror state for line numbers.");const t=e.getCursorPosition();if(t){c=t.line+1;d=c}}}else{console.warn("Could not access cell editor for line numbers.")}console.log(`[SimpleSidebarWidget.insertCode] Determined lines: Start=${c}, End=${d}`);const u=this.inputHandler.addCodeReference(e,r,l,c,d);const p=`@code[${u}]`;this.inputHandler.appendToInput(p)},insertCell:e=>{var t;return(t=this.inputHandler)===null||t===void 0?void 0:t.appendToInput(`@cell ${e}`)},insertFilePath:e=>{var t;return(t=this.inputHandler)===null||t===void 0?void 0:t.appendToInput(`@file[${e}]`)},insertDirectoryPath:e=>{var t;return(t=this.inputHandler)===null||t===void 0?void 0:t.appendToInput(`@dir[${e}]`)},getSelectedText:b.getSelectedText,getCurrentCellContent:b.getCurrentCellContent,insertCellByIndex:e=>{var t;const n=e+1;const o=`@Cell[${n}]`;(t=this.inputHandler)===null||t===void 0?void 0:t.appendToInput(o)},insertCollapsedCodeRef:(e,t,n,o)=>{if(!this.inputHandler)return;const s=n;const i=this.inputHandler.addCodeReference(e,o,t,n,s);const r=`@code[${i}]`;this.inputHandler.appendToInput(r)}});const n=()=>{var e;const t=this.chatState.createNewChat();(e=this.historyHandler)===null||e===void 0?void 0:e.loadChat(t.id)};const o=()=>{var e;(e=this.historyHandler)===null||e===void 0?void 0:e.toggleHistoryView()};const M=()=>{var e;(e=this.settingsHandler)===null||e===void 0?void 0:e.showModal()};const x=e=>{var t;this.chatState.updateCurrentChatTitle(e);(t=this.uiManager)===null||t===void 0?void 0:t.showNotification("Chat title updated","info")};const w=e=>{const t=e.target.getBoundingClientRect();this.popupMenuManager.showPopupMenu(t.left+60,t.top-20);e.preventDefault();e.stopPropagation()};const k=()=>{const e=this.layoutElements.inputField;const t=new KeyboardEvent("keypress",{key:"Enter",bubbles:true});e.dispatchEvent(t)};const E=e=>{var t;(t=this.inputHandler)===null||t===void 0?void 0:t.setMarkdownMode(e)};const I=e=>{var t;(t=this.inputHandler)===null||t===void 0?void 0:t.toggleInputExpansion()};const P={showCopyFeedback:(e,t=true)=>{const n=e.innerHTML;e.innerHTML=t?"Copied!":"Failed!";e.disabled=true;setTimeout((()=>{e.innerHTML=n;e.disabled=false}),1e3)},addMessageToCell:b.addMessageToCell,copyToClipboard:(e,t)=>{navigator.clipboard.writeText(e).then((()=>t===null||t===void 0?void 0:t())).catch((e=>{console.error("Failed to copy text: ",e);t===null||t===void 0?void 0:t()}))},copyImageToClipboard:(e,t)=>{(0,y.copyImageToClipboard)(e,(e=>{t===null||t===void 0?void 0:t()}))},copyMessageToClipboard:(e,t)=>{(0,y.copyMessageToClipboard)(e,(e=>{t()}))},handleConfirmInterrupt:()=>{var e;(e=this.messageHandler)===null||e===void 0?void 0:e.handleSendAutoMessage("confirmed")},handleRejectInterrupt:()=>{var e;(e=this.messageHandler)===null||e===void 0?void 0:e.handleSendAutoMessage("rejected")}};const T={handleSave:()=>{var e;(e=this.settingsHandler)===null||e===void 0?void 0:e.saveSettings()},handleCancel:()=>{var e;(e=this.settingsHandler)===null||e===void 0?void 0:e.hideModal()}};const N={updateTitleInput:e=>this.uiManager.updateTitleInput(e),clearMessageContainer:()=>this.uiManager.clearMessageContainer(),addRenderedMessage:e=>this.uiManager.addChatMessageElement(e)};const S={handleSendMessage:e=>{if(this.messageHandler){this.messageHandler.handleSendMessage(e)}else{console.error("MessageHandler not initialized when trying to send message from InputHandler")}},showPopupMenu:(e,t)=>this.popupMenuManager.showPopupMenu(e,t),hidePopupMenu:()=>this.popupMenuManager.hidePopupMenu(),updatePlaceholder:e=>{this.layoutElements.inputField.dataset.placeholder=e?"Enter markdown...":"Ask anything..."},toggleInputExpansionUI:e=>{const t=this.layoutElements.expandButton;while(t.firstChild){t.removeChild(t.firstChild)}const n=e?C.LabIcon.resolve({icon:"ui-components:caret-up"}):C.LabIcon.resolve({icon:"ui-components:caret-down"});n.element({container:t,tag:"span"});t.title=e?"Collapse input":"Expand input"},getCodeRefMap:()=>{var e;return((e=this.inputHandler)===null||e===void 0?void 0:e.getCodeReferenceMap())||new Map},resetCodeRefMap:()=>{var e;return(e=this.inputHandler)===null||e===void 0?void 0:e.resetCodeReferences()}};const j={showIndicator:e=>{var t;return(t=this.uiManager)===null||t===void 0?void 0:t.showIndicator(e)},appendToInput:e=>{var t;return(t=this.inputHandler)===null||t===void 0?void 0:t.appendToInput(e)},showWidget:()=>{if(this.isHidden){this.show()}},focusInput:()=>{var e,t;return(t=(e=this.layoutElements)===null||e===void 0?void 0:e.inputField)===null||t===void 0?void 0:t.focus()}};this.layoutElements=(0,l.buildLayout)({onNewChatClick:n,onHistoryToggleClick:o,onSettingsClick:M,onTitleChange:x,onAtButtonClick:w,onSendMessageClick:k,onMarkdownToggleChange:E,onExpandToggleClick:I});this.settingsModalContainer=(0,c.createSettingsModalElement)(T);this.chatState=new d.ChatState;this.settingsState=new u.SettingsState;this.apiClient=new i.ApiClient;const L={handleNewChat:this.handleNewChat,handleToggleHistory:this.handleToggleHistory,handleSendMessage:this.handleSendMessage,handleShowSettings:this.handleShowSettings,handleShowPopupMenu:this.handleShowPopupMenu,handleUpdateTitle:this.handleUpdateTitle};this.uiManager=new f.UIManager(this.popupMenuManager,L,this.layoutElements);this.inputHandler=new p.InputHandler(this.layoutElements.inputField,S);this.messageHandler=new h.MessageHandler(this.apiClient,this.chatState,this.uiManager,P,this.inputHandler);this.historyHandler=new g.HistoryHandler(this.chatState,this.uiManager,N,P);this.settingsHandler=new m.SettingsHandler(this.settingsState,this.settingsModalContainer,this.uiManager);const A=this.chatState.getCurrentChatId();if(A){this.historyHandler.loadChat(A)}else{const e=this.chatState.createNewChat();this.historyHandler.loadChat(e.id)}(0,a.setupShortcuts)(this.inputHandler,this.popupMenuManager,j);this.node.appendChild(this.layoutElements.mainElement);this.node.appendChild(this.settingsModalContainer)}dispose(){var e,t;if(this.isDisposed){return}(0,a.removeShortcuts)();(e=this.inputHandler)===null||e===void 0?void 0:e.dispose();(t=this.popupMenuManager)===null||t===void 0?void 0:t.dispose();super.dispose()}}t.SimpleSidebarWidget=M},19411:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:true});t.ChatState=void 0;const o=n(92363);class s{constructor(){var e;this.chatHistory=[];this.currentChatId=null;if(this.chatHistory.length===0){this.createNewChat("Welcome Chat")}else{this.currentChatId=((e=this.chatHistory[0])===null||e===void 0?void 0:e.id)||null}}createNewChat(e="New Chat"){const t=`chat-${(0,o.v4)()}`;const n={id:t,title:e,messages:[]};this.chatHistory.push(n);this.currentChatId=t;console.log("Created new chat:",n);return n}setCurrentChatId(e){if(this.chatHistory.some((t=>t.id===e))){this.currentChatId=e}else{console.warn(`Chat ID ${e} not found in history.`)}}getCurrentChatId(){return this.currentChatId}getChatById(e){return this.chatHistory.find((t=>t.id===e))}getCurrentChat(){if(!this.currentChatId){return undefined}return this.getChatById(this.currentChatId)}updateCurrentChatTitle(e){const t=this.getCurrentChat();if(t){t.title=e;console.log(`Updated title for chat ${this.currentChatId} to "${e}"`)}else{console.warn("Cannot update title: No current chat selected.")}}addMessageToCurrentChat(e){const t=this.getCurrentChat();if(t){t.messages.push(e)}else{console.warn("Cannot add message: No current chat selected.")}}getCurrentChatMessages(){const e=this.getCurrentChat();return e?e.messages:[]}getChatHistory(){return[...this.chatHistory]}}t.ChatState=s},92352:(e,t)=>{Object.defineProperty(t,"__esModule",{value:true});t.SettingsState=void 0;const n="jp-llm-ext-settings";class o{constructor(){this.currentSettings=null;this.currentSettings=this.loadSettings()}loadSettings(){const e=localStorage.getItem(n);if(e){try{const t=JSON.parse(e);if(t&&t.provider){this.currentSettings=t;console.log("Loaded settings:",this.currentSettings);return this.currentSettings}}catch(t){console.error("Error loading saved settings:",t);localStorage.removeItem(n)}}console.log("No valid settings found in localStorage.");return null}saveSettings(e){try{localStorage.setItem(n,JSON.stringify(e));this.currentSettings=Object.assign({},e);console.log("Settings saved:",this.currentSettings)}catch(t){console.error("Error saving settings:",t)}}getSettings(){return this.currentSettings?Object.assign({},this.currentSettings):null}getSetting(e){return this.currentSettings?this.currentSettings[e]:undefined}}t.SettingsState=o},60198:(e,t)=>{Object.defineProperty(t,"__esModule",{value:true});t.createDiv=o;t.createButton=s;t.createSpan=i;t.createTextArea=r;t.createInputElement=a;t.createImageElement=l;t.createAnchorElement=c;t.createLabelElement=d;t.createFormElement=u;function n(e,t={}){const n=document.createElement(e);if(t.id){n.id=t.id}if(t.classes){const e=Array.isArray(t.classes)?t.classes:t.classes.split(" ").filter((e=>e));n.classList.add(...e)}if(t.text){n.textContent=t.text}else if(t.html){n.innerHTML=t.html}if(t.attributes){for(const e in t.attributes){if(t.attributes.hasOwnProperty(e)){n.setAttribute(e,t.attributes[e])}}}if(t.style){for(const e in t.style){if(t.style.hasOwnProperty(e)){n.style[e]=t.style[e]}}}if(t.children){t.children.forEach((e=>{if(typeof e==="string"){n.appendChild(document.createTextNode(e))}else{n.appendChild(e)}}))}return n}function o(e={}){return n("div",e)}function s(e={}){return n("button",e)}function i(e={}){return n("span",e)}function r(e={}){return n("textarea",e)}function a(e={}){var t;if((t=e.attributes)===null||t===void 0?void 0:t.type){}else if(!e.attributes){e.attributes={type:"text"}}else if(!e.attributes.type){e.attributes.type="text"}return n("input",e)}function l(e){const t=Object.assign({},e);t.attributes=Object.assign(Object.assign({},e.attributes),{src:e.src});if(e.alt){t.attributes.alt=e.alt}return n("img",t)}function c(e){const t=Object.assign({},e);t.attributes=Object.assign(Object.assign({},e.attributes),{href:e.href});return n("a",t)}function d(e){const t=Object.assign({},e);if(e.htmlFor){t.attributes=Object.assign(Object.assign({},e.attributes),{for:e.htmlFor})}return n("label",t)}function u(e={}){return n("form",e)}},96576:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:true});t.buildLayout=s;const o=n(60198);function s(e={}){const t=(0,o.createDiv)({classes:"jp-llm-ext-content-wrapper"});const n=(0,o.createDiv)({classes:"jp-llm-ext-title-container"});const s=(0,o.createInputElement)({id:"chat-title-input",classes:"chat-title-input",attributes:{type:"text",placeholder:"Chat title",value:"New Chat"}});if(e.onTitleChange){s.addEventListener("change",(()=>e.onTitleChange(s.value)))}n.appendChild(s);const i=(0,o.createDiv)({classes:"jp-llm-ext-message-container"});const r=(0,o.createDiv)({classes:"jp-llm-ext-history-container",style:{display:"none"}});const a=(0,o.createDiv)({classes:"jp-llm-ext-bottom-bar-container"});const l=(0,o.createDiv)({classes:"jp-llm-ext-bottom-bar-row jp-llm-ext-controls-row"});const c=(0,o.createDiv)({classes:"jp-llm-ext-controls-container"});const d=(0,o.createDiv)({classes:"jp-llm-ext-toggle-container"});const u=(0,o.createInputElement)({id:"markdown-toggle",attributes:{type:"checkbox"}});const p=(0,o.createLabelElement)({text:"Markdown mode",htmlFor:"markdown-toggle"});if(e.onMarkdownToggleChange){u.addEventListener("change",(()=>{e.onMarkdownToggleChange(u.checked)}))}d.appendChild(u);d.appendChild(p);const h=(0,o.createDiv)({classes:"jp-llm-ext-action-buttons-container"});const g=(0,o.createButton)({text:"@",attributes:{title:"Browse cells, code, files, and more"},classes:"jp-Button jp-llm-ext-action-button"});if(e.onAtButtonClick){g.addEventListener("click",e.onAtButtonClick)}const m=(0,o.createButton)({text:"‚§¢",attributes:{title:"Expand input"},classes:"jp-Button jp-llm-ext-action-button"});if(e.onExpandToggleClick){m.addEventListener("click",(()=>e.onExpandToggleClick(m)))}const f=(0,o.createButton)({text:"‚öôÔ∏è",attributes:{title:"Settings"},classes:"jp-Button jp-llm-ext-action-button"});if(e.onSettingsClick){f.addEventListener("click",e.onSettingsClick)}h.appendChild(g);h.appendChild(m);h.appendChild(f);c.appendChild(d);c.appendChild(h);l.appendChild(c);const C=(0,o.createDiv)({classes:"jp-llm-ext-bottom-bar-row jp-llm-ext-input-row"});const v=(0,o.createDiv)({classes:"jp-llm-ext-input-field",attributes:{contenteditable:"true",role:"textbox","aria-multiline":"true","data-placeholder":"Ask me anything..."},style:{minHeight:"20px",overflowY:"hidden"}});if(e.onInputFieldKeyPress){v.addEventListener("keypress",e.onInputFieldKeyPress)}if(e.onInputFieldValueChange){v.addEventListener("input",(()=>e.onInputFieldValueChange(v.textContent||"")))}C.appendChild(v);const y=(0,o.createDiv)({classes:"jp-llm-ext-bottom-bar-row jp-llm-ext-buttons-row"});const b=(0,o.createButton)({text:"Send",classes:"jp-Button jp-llm-ext-send-button"});if(e.onSendMessageClick){b.addEventListener("click",e.onSendMessageClick)}const M=(0,o.createButton)({text:"+ New Chat",attributes:{title:"Start a new chat"},classes:"jp-Button jp-llm-ext-action-button"});if(e.onNewChatClick){M.addEventListener("click",e.onNewChatClick)}const x=(0,o.createButton)({text:"History",attributes:{title:"View chat history"},classes:"jp-Button jp-llm-ext-action-button"});if(e.onHistoryToggleClick){x.addEventListener("click",e.onHistoryToggleClick)}y.appendChild(b);y.appendChild(M);y.appendChild(x);a.appendChild(l);a.appendChild(C);a.appendChild(y);t.appendChild(n);t.appendChild(i);t.appendChild(r);t.appendChild(a);return{mainElement:t,titleInput:s,messageContainer:i,historyContainer:r,inputField:v,bottomBarContainer:a,sendButton:b,newChatButton:M,historyButton:x,markdownToggleButton:u,expandButton:m,atButton:g,settingsButton:f}}},3233:function(e,t,n){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:true});t.MessageRenderer=void 0;t.renderUserMessage=u;t.renderBotMessage=m;t.renderBotMessageStreamingStart=v;t.renderBotMessageStreamingUpdate=y;t.renderBotMessageFinal=b;const s=n(14507);const i=o(n(59764));const r=n(60198);const a=n(40095);const l=n(73053);const c=n(46423);function d(e){const t=document.createElement("div");t.className=e==="user"?"jp-llm-ext-user-message":"jp-llm-ext-bot-message";return t}function u(e,t={},n={}){const o=d("user");if(t.isMarkdown){const t=document.createElement("div");t.className="markdown-content";try{const n=(0,c.preprocessMarkdown)(e);const o=s.marked.parse(n);const r=i.default.sanitize(o);t.innerHTML=r;const a=t.querySelectorAll("pre code");a.forEach((e=>{M(e,{})}))}catch(r){console.error("Failed to render user markdown:",r);t.textContent=e}o.appendChild(t)}else{p(o,e,n)}return o}function p(e,t,n){console.log("[renderMessageContentWithRefs] Processing text:",JSON.stringify(t));const o=/\s*(@(file|dir|Cell|code)\[([^\]]+?)\])\s*/g;let s=0;let i;o.lastIndex=0;while((i=o.exec(t))!==null){if(i.index>s){e.appendChild(document.createTextNode(t.substring(s,i.index)))}const a=i[0];const l=i[1];const c=i[2];const d=i[3];try{const t=h(c,d,l,n);e.appendChild(t)}catch(r){console.error(`Failed to create widget for reference: ${l}`,r);e.appendChild(document.createTextNode(a))}s=o.lastIndex}if(s<t.length){e.appendChild(document.createTextNode(t.substring(s)))}}function h(e,t,n,o){const s=document.createElement("span");s.className=`jp-llm-ext-ref-widget ref-${e.toLowerCase()}`;s.setAttribute("contenteditable","false");s.dataset.refText=n;let i="";let r=n;switch(e){case"file":i=t.split(/[\\/]/).pop()||t;r=`File: ${t}`;break;case"dir":i=t.split(/[\\/]/).pop()||t||"/";r=`Directory: ${t}`;break;case"Cell":{const e=parseInt(t)-1;const n=o.getCurrentNotebookContext?o.getCurrentNotebookContext():undefined;console.log(`[createRefWidget @Cell] Input Value: ${t}, Parsed Index: ${e}, Notebook Context:`,n);const s=(n===null||n===void 0?void 0:n.name)||"notebook";let l="?";if(n&&a.globals.notebookTracker){const t=a.globals.notebookTracker.find((e=>e.context.path===n.path));if(t&&t.model){const n=t.model.cells.get(e);if(n){l=n.type==="markdown"?"M":"C"}}}i=`${s}-${l}-${t}`;r=`Cell ${t} (${l==="M"?"Markdown":"Code"}) in ${s}`;break}case"code":{const e=t;const n=o.getCodeRefData?o.getCodeRefData(e):undefined;console.log(`[createRefWidget @code] Input Value (refId): ${e}, Ref Data Found:`,n);if(n){const e=n.lineNumber;const t=n.lineEndNumber;const o=e===t?`${e}`:`${e}_${t}`;i=`${n.notebookName}-${n.cellIndex+1}-${o}`;const s=e===t?`Line ${e}`:`Lines ${e}-${t}`;r=`Code Reference: ${n.notebookName}, Cell ${n.cellIndex+1}, ${s}`}else{i=`code-ref-${e}`;r=`Code Reference ID: ${e} (Data not found)`}break}}s.textContent=i;s.title=r;return s}function g(e,t){const n=/\s*(@(file|dir|Cell|code)\[([^\]]+?)\])\s*/g;const o=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null);let s;const i=[];while(s=o.nextNode()){if(s instanceof Text&&s.textContent&&!(s.parentElement&&s.parentElement.closest(".jp-llm-ext-ref-widget"))){n.lastIndex=0;if(n.test(s.textContent)){i.push(s)}}}i.forEach((e=>{const o=e.parentNode;if(!o)return;const s=e.textContent||"";const i=document.createDocumentFragment();let r=0;let a;n.lastIndex=0;while((a=n.exec(s))!==null){if(a.index>r){i.appendChild(document.createTextNode(s.substring(r,a.index)))}const e=a[0];const o=a[1];const c=a[2];const d=a[3];try{const e=h(c,d,o,t);i.appendChild(e)}catch(l){console.error(`Failed to create widget for reference: ${o}`,l);i.appendChild(document.createTextNode(e))}r=n.lastIndex}if(r<s.length){i.appendChild(document.createTextNode(s.substring(r)))}o.replaceChild(i,e)}))}function m(e,t={isMarkdown:true},n={}){const o=d("bot");const r=e.trim().startsWith("/images/")&&(e.trim().endsWith(".png")||e.trim().endsWith(".jpg")||e.trim().endsWith(".jpeg")||e.trim().endsWith(".gif"));if(r){const t=`http://127.0.0.1:8000${e.trim()}`;C(o,t,n)}else if(t.isMarkdown){const t=document.createElement("div");t.textContent="MD";t.className="markdown-indicator";o.appendChild(t);const r=document.createElement("div");r.className="markdown-content";try{const t=(0,c.preprocessMarkdown)(e);const o=s.marked.parse(t);const a=i.default.sanitize(o);r.innerHTML=a;g(r,n);const l=r.querySelectorAll("pre code");l.forEach((e=>{M(e,n)}));const d=e.startsWith("**[INTERRUPT]**");if(d){x(r,n)}}catch(a){r.textContent=e;console.error("Failed to render markdown:",a)}o.appendChild(r);w(o,e,n)}else{o.textContent=e;w(o,e,n)}return o}function f(e){return d(e)}function C(e,t,n={}){const o=document.createElement("div");o.className="jp-llm-ext-image-container";o.style.position="relative";const s=document.createElement("img");s.src=t;s.alt="Image from bot";s.style.maxWidth="100%";s.style.height="auto";o.appendChild(s);const i=document.createElement("div");i.className="jp-llm-ext-image-actions";i.style.position="absolute";i.style.bottom="10px";i.style.right="10px";i.style.display="flex";i.style.gap="8px";i.style.backgroundColor="rgba(255, 255, 255, 0.6)";i.style.borderRadius="4px";i.style.padding="4px";if(n.copyImageToClipboard&&n.showCopyFeedback){const e=document.createElement("button");e.className="jp-llm-ext-image-action-button";e.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>';e.title="Copy image to clipboard";const o=()=>n.showCopyFeedback(e);e.addEventListener("click",(e=>{e.stopPropagation();n.copyImageToClipboard(t,o)}));i.appendChild(e)}if(n.addMessageToCell){const e=document.createElement("button");e.className="jp-llm-ext-image-action-button";e.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect><path d="M12 11v6"></path><path d="M9 14h6"></path></svg>';e.title="Add image path to current cell";e.addEventListener("click",(e=>{e.stopPropagation();n.addMessageToCell(t)}));i.appendChild(e)}if(i.hasChildNodes()){o.appendChild(i)}e.appendChild(o)}function v(){const e=f("bot");const t=(0,r.createDiv)({text:"MD",classes:"markdown-indicator"});e.appendChild(t);const n=(0,r.createDiv)({classes:"streaming-content",style:{whiteSpace:"pre-wrap",fontFamily:"monospace",fontSize:"0.9em"}});e.appendChild(n);const o=(0,r.createDiv)({classes:"markdown-content",style:{display:"none"}});e.appendChild(o);return{wrapper:e,streamingDiv:n,contentDiv:o}}function y(e,t){e.textContent+=t}function b(e,t,n,o={},r={}){t.style.display="none";e.style.display="block";const a=Object.assign(Object.assign({},o),r);const l=n.trim().startsWith("/images/")&&(n.trim().endsWith(".png")||n.trim().endsWith(".jpg")||n.trim().endsWith(".jpeg")||n.trim().endsWith(".gif"));if(l){const t=`http://127.0.0.1:8000${n.trim()}`;C(e,t,a)}else{try{const t=(0,c.preprocessMarkdown)(n);const o=s.marked.parse(t);const r=i.default.sanitize(o);e.innerHTML=r;g(e,a);const l=n.startsWith("**[INTERRUPT]**");if(l){x(e,a)}const d=e.querySelectorAll("pre code");d.forEach((e=>{M(e,a)}))}catch(d){console.error("Error rendering markdown:",d);e.textContent=n}}return e}function M(e,t={}){var n;const o=e.parentElement;if(!o||o.tagName!=="PRE"){console.warn("Code block enhancement called on element not within a <pre> tag.");return}e.classList.add("jp-RenderedText");o.classList.add("jp-RenderedHTMLCommon");const s=e.textContent||"";const i=document.createElement("div");i.className="jp-llm-ext-code-header";const r=(0,l.detectLanguage)(s);if(r){const t=document.createElement("span");t.className="jp-llm-ext-code-language";t.textContent=r;i.appendChild(t);e.classList.add(`language-${r}`)}try{e.innerHTML=(0,l.highlightCode)(s,r)}catch(c){console.error("Error applying syntax highlighting:",c)}const a=document.createElement("div");a.className="jp-llm-ext-code-actions";if(t.copyToClipboard&&t.showCopyFeedback){const e=document.createElement("button");e.className="jp-llm-ext-code-action-button";e.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>';e.title="Copy code to clipboard";const n=()=>t.showCopyFeedback(e);e.addEventListener("click",(e=>{e.stopPropagation();t.copyToClipboard(s,n)}));a.appendChild(e)}if(t.addMessageToCell){const e=document.createElement("button");e.className="jp-llm-ext-code-action-button";e.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect><path d="M12 11v6"></path><path d="M9 14h6"></path></svg>';e.title="Add code to current cell";e.addEventListener("click",(e=>{e.stopPropagation();t.addMessageToCell(s)}));a.appendChild(e)}if(a.hasChildNodes()){i.appendChild(a)}if(i.hasChildNodes()){(n=o.parentNode)===null||n===void 0?void 0:n.insertBefore(i,o)}}function x(e,t={}){if(!t.handleConfirmInterrupt||!t.handleRejectInterrupt){console.warn("Interrupt message needs confirm/reject callbacks.");return}const n=document.createElement("div");n.className="jp-llm-ext-interrupt-buttons";n.style.marginTop="12px";n.style.display="flex";n.style.gap="8px";const o=document.createElement("button");o.className="jp-llm-ext-confirm-button";o.textContent="Confirm";o.style.padding="6px 12px";o.style.background="#4CAF50";o.style.color="white";o.style.border="none";o.style.borderRadius="4px";o.style.cursor="pointer";o.style.fontWeight="bold";const s=document.createElement("button");s.className="jp-llm-ext-reject-button";s.textContent="Reject";s.style.padding="6px 12px";s.style.background="#F44336";s.style.color="white";s.style.border="none";s.style.borderRadius="4px";s.style.cursor="pointer";s.style.fontWeight="bold";o.addEventListener("click",(()=>{o.disabled=true;s.disabled=true;o.style.opacity="0.5";s.style.opacity="0.5";t.handleConfirmInterrupt()}));s.addEventListener("click",(()=>{o.disabled=true;s.disabled=true;o.style.opacity="0.5";s.style.opacity="0.5";t.handleRejectInterrupt()}));n.appendChild(o);n.appendChild(s);e.appendChild(n)}function w(e,t,n={}){if(!n.copyMessageToClipboard&&!n.addMessageToCell){return}console.log("Adding action buttons to bot message");const o=document.createElement("div");o.className="jp-llm-ext-message-actions";if(n.copyMessageToClipboard&&n.showCopyFeedback){const e=document.createElement("button");e.className="jp-llm-ext-message-action-button";e.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>';e.title="Copy message to clipboard";const s=()=>n.showCopyFeedback(e);e.addEventListener("click",(e=>{e.stopPropagation();n.copyMessageToClipboard(t,s)}));o.appendChild(e)}if(n.addMessageToCell){const e=document.createElement("button");e.className="jp-llm-ext-message-action-button";e.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect><path d="M12 11v6"></path><path d="M9 14h6"></path></svg>';e.title="Add message to current cell";e.addEventListener("click",(e=>{e.stopPropagation();n.addMessageToCell(t)}));o.appendChild(e)}if(o.hasChildNodes()){e.appendChild(o);console.log("Action buttons added to bot message:",o)}}class k{constructor(){}}t.MessageRenderer=k},55157:(e,t)=>{Object.defineProperty(t,"__esModule",{value:true});t.SettingsModal=void 0;t.createSettingsModalElement=n;function n(e){const t=document.createElement("div");t.className="jp-llm-ext-settings-modal";t.style.display="none";const n=document.createElement("div");n.className="jp-llm-ext-settings-content";const o=document.createElement("h2");o.className="jp-llm-ext-settings-title";o.textContent="Settings";n.appendChild(o);const s=document.createElement("form");s.className="jp-llm-ext-settings-form";const i=document.createElement("label");i.className="jp-llm-ext-settings-label";i.textContent="API Provider:";s.appendChild(i);const r=document.createElement("select");r.className="jp-llm-ext-settings-select";r.id="settings-provider";["OpenAI","HuggingFace","Local"].forEach((e=>{const t=document.createElement("option");t.value=e;t.textContent=e;r.appendChild(t)}));s.appendChild(r);const a=document.createElement("label");a.className="jp-llm-ext-settings-label";a.textContent="API Key:";s.appendChild(a);const l=document.createElement("input");l.className="jp-llm-ext-settings-input";l.type="password";l.id="settings-api-key";s.appendChild(l);const c=document.createElement("label");c.className="jp-llm-ext-settings-label";c.textContent="API URL (optional):";s.appendChild(c);const d=document.createElement("input");d.className="jp-llm-ext-settings-input";d.type="text";d.id="settings-api-url";s.appendChild(d);const u=document.createElement("label");u.className="jp-llm-ext-settings-label";u.textContent="Custom Rules (optional):";s.appendChild(u);const p=document.createElement("textarea");p.className="jp-llm-ext-settings-textarea";p.id="settings-rules";s.appendChild(p);const h=document.createElement("div");h.className="jp-llm-ext-settings-buttons";const g=document.createElement("button");g.className="jp-llm-ext-settings-button jp-llm-ext-settings-save-button";g.textContent="Save";g.type="button";g.addEventListener("click",(t=>{t.preventDefault();const n={apiKey:l.value,apiUrl:d.value,rules:p.value,provider:r.value};e.handleSave(n)}));const m=document.createElement("button");m.className="jp-llm-ext-settings-button jp-llm-ext-settings-cancel-button";m.textContent="Cancel";m.type="button";m.addEventListener("click",(t=>{t.preventDefault();e.handleCancel()}));h.appendChild(g);h.appendChild(m);s.appendChild(h);n.appendChild(s);t.appendChild(n);return t}class o{constructor(e){}}t.SettingsModal=o},89048:(e,t)=>{Object.defineProperty(t,"__esModule",{value:true});t.UIManager=void 0;class n{constructor(e,t,n){this.notificationTimeout=null;this.isInputExpanded=false;this.isMarkdownMode=false;this.popupMenuManager=e;this.callbacks=t;this.layoutElements=n;this.inputField=n.inputField;this.messageContainer=n.messageContainer;this.historyContainer=n.historyContainer;this.titleInput=n.titleInput;this.bottomBarContainer=n.bottomBarContainer;this.keyboardShortcutIndicator=document.createElement("div");this.keyboardShortcutIndicator.className="jp-llm-ext-shortcut-indicator";this.keyboardShortcutIndicator.style.display="none";if(this.bottomBarContainer){this.bottomBarContainer.insertAdjacentElement("afterend",this.keyboardShortcutIndicator)}else{console.error("UIManager: bottomBarContainer element not found during indicator initialization.")}}getUIElements(){return this.layoutElements}createLayout(){const e=document.createElement("div");e.className="jp-llm-ext-content-wrapper";const t=document.createElement("div");t.className="jp-llm-ext-title-container";this.titleInput=document.createElement("input");this.titleInput.className="chat-title-input";this.titleInput.type="text";this.titleInput.placeholder="Chat title";this.titleInput.value="New Chat";this.titleInput.addEventListener("change",this.callbacks.handleUpdateTitle);t.appendChild(this.titleInput);this.messageContainer=document.createElement("div");this.messageContainer.className="jp-llm-ext-message-container";this.historyContainer=document.createElement("div");this.historyContainer.className="jp-llm-ext-history-container";this.historyContainer.style.display="none";this.bottomBarContainer=document.createElement("div");this.bottomBarContainer.className="jp-llm-ext-bottom-bar-container";const n=document.createElement("div");n.className="jp-llm-ext-bottom-bar-row jp-llm-ext-controls-row";const o=this.createControlsContainer();n.appendChild(o);const s=document.createElement("div");s.className="jp-llm-ext-bottom-bar-row jp-llm-ext-input-row";this.inputField=document.createElement("div");this.inputField.setAttribute("contenteditable","true");this.inputField.setAttribute("role","textbox");this.inputField.setAttribute("aria-multiline","true");this.inputField.setAttribute("data-placeholder","Ask me anything...");this.inputField.className="jp-llm-ext-input-field";this.inputField.addEventListener("input",(e=>{this.handleInputForReference()}));this.inputField.addEventListener("keydown",(e=>{console.log(`UI_MANAGER KeyDown: Key='${e.key}', Shift='${e.shiftKey}', Code='${e.code}'`);const t=window.getSelection();if(e.key==="Backspace"&&t&&t.isCollapsed){const n=t.getRangeAt(0);const o=n.startContainer.childNodes[n.startOffset-1]||n.startContainer.previousSibling;let s=null;if(n.startOffset>0&&n.startContainer.childNodes.length>=n.startOffset){s=n.startContainer.childNodes[n.startOffset-1]}else if(n.startOffset===0&&n.startContainer.previousSibling){s=n.startContainer.previousSibling}else if(n.startContainer!==this.inputField&&n.startContainer.parentNode===this.inputField&&n.startOffset===0){s=n.startContainer.previousSibling}if(s&&s.nodeType===Node.ELEMENT_NODE&&s.classList.contains("jp-llm-ext-ref-widget")){e.preventDefault();s.remove();this.inputField.dispatchEvent(new Event("input",{bubbles:true,cancelable:true}));return}}if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();const t=this.getSerializedInput();if(t.trim()){this.callbacks.handleSendMessage(t);this.clearInputField()}}else if(this.popupMenuManager.isPopupMenuVisible()){if(e.key==="Tab"||e.key==="Escape"||e.key==="ArrowUp"||e.key==="ArrowDown"||e.key==="Enter"){if(e.key!=="Enter"){e.preventDefault()}}}}));this.inputField.addEventListener("copy",(e=>{this.handleCopy(e)}));this.inputField.addEventListener("paste",(e=>{this.handlePaste(e)}));s.appendChild(this.inputField);const i=document.createElement("div");i.className="jp-llm-ext-bottom-bar-row jp-llm-ext-buttons-row";const r=this.createButton("Send","Send message");r.classList.add("jp-llm-ext-send-button");r.addEventListener("click",(()=>{const e=this.getSerializedInput();if(e.trim()){this.callbacks.handleSendMessage(e);this.clearInputField()}}));const a=this.createButton("+ New Chat","Start a new chat");a.addEventListener("click",this.callbacks.handleNewChat);const l=this.createButton("History","View chat history");l.addEventListener("click",this.callbacks.handleToggleHistory);i.appendChild(r);i.appendChild(a);i.appendChild(l);this.bottomBarContainer.appendChild(n);this.bottomBarContainer.appendChild(s);this.bottomBarContainer.appendChild(i);e.appendChild(t);e.appendChild(this.messageContainer);e.appendChild(this.historyContainer);e.appendChild(this.bottomBarContainer);return{mainLayout:e,messageContainer:this.messageContainer,inputField:this.inputField,titleInput:this.titleInput,historyContainer:this.historyContainer,bottomBarContainer:this.bottomBarContainer}}createControlsContainer(){const e=document.createElement("div");e.className="jp-llm-ext-controls-container";const t=document.createElement("div");t.className="jp-llm-ext-toggle-container";this.markdownToggle=document.createElement("input");this.markdownToggle.type="checkbox";this.markdownToggle.id="markdown-toggle";this.markdownToggle.addEventListener("change",(e=>{const t=e.target;this.isMarkdownMode=t.checked;const n=this.isMarkdownMode?"Write markdown here...\\n\\n# Example heading\\n- List item\\n\\n```code block```":"Ask me anything...";this.inputField.setAttribute("data-placeholder",n);this.inputField.blur();this.inputField.focus()}));const n=document.createElement("label");n.htmlFor="markdown-toggle";n.textContent="Markdown mode";t.appendChild(this.markdownToggle);t.appendChild(n);const o=document.createElement("div");o.className="jp-llm-ext-action-buttons-container";const s=this.createButton("@","Browse cells, code, files, and more");s.addEventListener("click",(e=>{this.callbacks.handleShowPopupMenu(e,e.currentTarget)}));this.expandButton=this.createButton("‚§¢","Expand input");this.expandButton.addEventListener("click",(()=>this.toggleInputExpansion()));const i=this.createButton("‚öôÔ∏è","Settings");i.addEventListener("click",this.callbacks.handleShowSettings);o.appendChild(s);o.appendChild(this.expandButton);o.appendChild(i);e.appendChild(t);e.appendChild(o);return e}toggleInputExpansion(){if(!this.inputField||!this.expandButton)return;this.isInputExpanded=!this.isInputExpanded;if(this.isInputExpanded){this.inputField.style.height="200px";this.inputField.style.resize="vertical";this.expandButton.textContent="‚§°";this.expandButton.title="Collapse input"}else{this.inputField.style.height="";this.inputField.style.resize="none";this.expandButton.textContent="‚§¢";this.expandButton.title="Expand input"}}createButton(e,t){const n=document.createElement("button");n.textContent=e;n.title=t;n.className="jp-Button jp-llm-ext-action-button";return n}addChatMessageElement(e){if(this.messageContainer){this.messageContainer.appendChild(e);this.scrollToBottom()}else{console.error("Message container not initialized in UIManager.")}}scrollToBottom(){if(this.messageContainer){this.messageContainer.scrollTop=this.messageContainer.scrollHeight}else{console.error("Message container not initialized in UIManager.")}}showHistoryView(){this.layoutElements.messageContainer.style.display="none";this.layoutElements.historyContainer.style.display="block";this.layoutElements.bottomBarContainer.style.display="none"}showChatView(){this.layoutElements.historyContainer.style.display="none";this.layoutElements.messageContainer.style.display="block";this.layoutElements.bottomBarContainer.style.display="flex";this.scrollToBottom()}clearMessageContainer(){this.layoutElements.messageContainer.innerHTML=""}updateTitleInput(e){if(this.layoutElements.titleInput){this.layoutElements.titleInput.value=e}}createBotMessageContainer(){const e=document.createElement("div");e.className="jp-llm-ext-bot-message";const t=document.createElement("div");t.className="jp-llm-ext-streaming-content";t.style.display="block";const n=document.createElement("div");n.className="jp-llm-ext-rendered-content";n.style.display="none";e.appendChild(t);e.appendChild(n);this.addChatMessageElement(e);return{botMessageDiv:e,streamingDiv:t,contentDiv:n}}showNotification(e,t,n=3e3){console.log(`Notification (${t}): ${e}`);const o=this.layoutElements.mainElement.querySelector(".jp-llm-ext-keyboard-shortcut-indicator");if(o){if(this.notificationTimeout){clearTimeout(this.notificationTimeout)}o.textContent=e;o.className=`jp-llm-ext-keyboard-shortcut-indicator visible jp-llm-ext-notification-${t}`;this.notificationTimeout=window.setTimeout((()=>{o.classList.remove("visible");this.notificationTimeout=null}),n)}else{console.warn("Notification indicator element not found for UIManager.")}}showIndicator(e){if(!this.keyboardShortcutIndicator)return;this.keyboardShortcutIndicator.textContent=e;this.keyboardShortcutIndicator.classList.add("visible");if(this.notificationTimeout){clearTimeout(this.notificationTimeout)}this.notificationTimeout=window.setTimeout((()=>{if(this.keyboardShortcutIndicator){this.keyboardShortcutIndicator.classList.remove("visible")}this.notificationTimeout=null}),1e3)}clearIndicator(){if(!this.keyboardShortcutIndicator)return;this.keyboardShortcutIndicator.classList.remove("visible");this.keyboardShortcutIndicator.textContent="";if(this.notificationTimeout){clearTimeout(this.notificationTimeout);this.notificationTimeout=null}}handleInputForReference(){var e,t;const n=window.getSelection();if(!n||!n.rangeCount||!n.isCollapsed){this.popupMenuManager.hidePopupMenu();return}const o=n.getRangeAt(0);const s=o.startContainer;const i=o.startOffset;if(!this.inputField.contains(s)){this.popupMenuManager.hidePopupMenu();return}let r="";let a=s;let l=i;while(a){if(a.nodeType===Node.TEXT_NODE){r=((e=a.textContent)===null||e===void 0?void 0:e.substring(0,l))+r}else if(a.nodeType===Node.ELEMENT_NODE&&a.classList.contains("jp-llm-ext-ref-widget")){r="[widget]"+r}else if(a.nodeType===Node.ELEMENT_NODE&&a.tagName==="BR"){r="\n"+r}if(a.previousSibling){a=a.previousSibling;l=(a.textContent||"").length}else{a=a.parentNode;if(a===this.inputField||!a){break}l=Array.prototype.indexOf.call(((t=a.parentNode)===null||t===void 0?void 0:t.childNodes)||[],a)}}console.log(`UI_MANAGER handleInput: Text before cursor: "${r}"`);const c=r.endsWith("@");const d=r.endsWith("@ ");if(c||d){if(this.popupMenuManager.isPopupMenuVisible()){console.log("UI_MANAGER handleInput: Popup already visible, skipping show.")}else{const e=r.lastIndexOf("@");let t=e+1;if(d){t=e+2}const n=r.substring(t);const s="jp-llm-temp-popup-anchor";let i=document.getElementById(s);if(i)i.remove();i=document.createElement("span");i.id=s;i.style.visibility="hidden";i.style.width="0";i.style.height="0";i.style.overflow="hidden";i.textContent="‚Äã";o.insertNode(i);const a=i.getBoundingClientRect();i.remove();if(a.top===0&&a.left===0){console.error("UI_MANAGER handleInput: Failed to get valid coordinates from temp anchor span.");this.popupMenuManager.hidePopupMenu()}else{console.log(`UI_MANAGER handleInput: Anchor coords from temp span: Top=${a.top}, Left=${a.left}`);this.popupMenuManager.showPopupMenu(a.top,a.left)}}}else{if(this.popupMenuManager.isPopupMenuVisible()){console.log("UI_MANAGER handleInput: Hiding popup, trigger condition no longer met.");this.popupMenuManager.hidePopupMenu()}}}getSerializedInput(){let e="";const t=this.inputField.childNodes;for(let n=0;n<t.length;n++){const o=t[n];if(o.nodeType===Node.TEXT_NODE){e+=o.textContent}else if(o.nodeType===Node.ELEMENT_NODE){const t=o;if(t.classList.contains("jp-llm-ext-ref-widget")&&t.dataset.referenceText){e+=t.dataset.referenceText}else if(t.tagName==="BR"){e+="\n"}else if(t.tagName==="DIV"){if(n>0){e+="\n"}e+=this.serializeNodeChildren(t)}else{console.warn("UIManager getSerializedInput: Encountered unexpected element:",t.tagName);e+=t.textContent}}}return e.trim()}serializeNodeChildren(e){let t="";const n=e.childNodes;for(let o=0;o<n.length;o++){const e=n[o];if(e.nodeType===Node.TEXT_NODE){t+=e.textContent}else if(e.nodeType===Node.ELEMENT_NODE){const n=e;if(n.classList.contains("jp-llm-ext-ref-widget")&&n.dataset.referenceText){t+=n.dataset.referenceText}else if(n.tagName==="BR"){t+="\n"}else{t+=this.serializeNodeChildren(n)}}}return t}clearInputField(){this.inputField.innerHTML="";if(this.isInputExpanded){this.toggleInputExpansion()}this.inputField.dispatchEvent(new Event("input"))}handleCopy(e){const t=window.getSelection();if(!t||t.isCollapsed||!e.clipboardData){return}const n=t.getRangeAt(0);if(!this.inputField.contains(n.commonAncestorContainer)){return}const o=this.serializeRangeContent(n);e.preventDefault();e.clipboardData.setData("text/plain",o);console.log("UIManager handleCopy: Copied serialized text:",o)}handlePaste(e){var t;if(!e.clipboardData){return}const n=e.clipboardData.getData("text/plain");if(n){e.preventDefault();const o=window.getSelection();if(o&&o.rangeCount>0){const e=o.getRangeAt(0);e.deleteContents();const s=document.createTextNode(n);e.insertNode(s);e.setStartAfter(s);e.setEndAfter(s);o.removeAllRanges();o.addRange(e);this.inputField.focus();(t=s.parentElement)===null||t===void 0?void 0:t.scrollIntoView({block:"nearest"});this.inputField.dispatchEvent(new Event("input",{bubbles:true,cancelable:true}))}console.log("UIManager handlePaste: Pasted text:",n)}}serializeRangeContent(e){const t=e.cloneContents();let n=document.createElement("div");n.appendChild(t);let o="";const s=n.childNodes;const i=e=>{if(e.nodeType===Node.TEXT_NODE){o+=e.textContent}else if(e.nodeType===Node.ELEMENT_NODE){const t=e;if(t.classList.contains("jp-llm-ext-ref-widget")&&t.dataset.referenceText){o+=t.dataset.referenceText}else if(t.tagName==="BR"){o+="\n"}else{const e=t.childNodes;for(let t=0;t<e.length;t++){i(e[t])}}}};for(let r=0;r<s.length;r++){i(s[r])}return o}}t.UIManager=n},48939:(e,t)=>{Object.defineProperty(t,"__esModule",{value:true});t.copyToClipboard=n;t.copyMessageToClipboard=o;t.copyImageToClipboard=s;function n(e,t){try{navigator.clipboard.writeText(e).then((()=>{console.log("Content copied to clipboard");t===null||t===void 0?void 0:t()})).catch((e=>{console.error("Failed to copy text: ",e)}))}catch(n){console.error("Error copying text to clipboard:",n)}}function o(e,t){try{navigator.clipboard.writeText(e).then((()=>{console.log("Message content copied to clipboard");t===null||t===void 0?void 0:t(true)})).catch((e=>{console.error("Failed to copy message text: ",e);t===null||t===void 0?void 0:t(false)}))}catch(n){console.error("Error copying message to clipboard:",n);t===null||t===void 0?void 0:t(false)}}function s(e,t){try{fetch(e).then((e=>{if(!e.ok){throw new Error(`Failed to fetch image: ${e.statusText}`)}return e.blob()})).then((e=>{const n=new ClipboardItem({[e.type]:e});navigator.clipboard.write([n]).then((()=>{console.log("Image copied to clipboard");t===null||t===void 0?void 0:t(true)})).catch((e=>{console.error("Failed to copy image to clipboard: ",e);alert("Failed to copy image: "+e.message);t===null||t===void 0?void 0:t(false)}))})).catch((e=>{console.error("Failed to fetch or process image: ",e);alert("Failed to fetch image: "+e.message);t===null||t===void 0?void 0:t(false)}))}catch(n){console.error("Error preparing image copy:",n);alert("Error copying image: "+n);t===null||t===void 0?void 0:t(false)}}},20281:(e,t)=>{Object.defineProperty(t,"__esModule",{value:true});t.getCaretPosition=n;t.setCaretPosition=o;function n(e){const t=window.getSelection();if(!t||t.rangeCount===0||!e.contains(t.anchorNode)){return 0}const n=t.getRangeAt(0);const o=n.cloneRange();o.selectNodeContents(e);o.setEnd(n.startContainer,n.startOffset);return o.toString().length}function o(e,t){var n;const o=window.getSelection();if(!o){return}const s=document.createRange();let i=0;let r=false;let a=[e];while(a.length>0){const e=a.pop();if(e.nodeType===Node.TEXT_NODE){const o=((n=e.textContent)===null||n===void 0?void 0:n.length)||0;if(t>=i&&t<=i+o){s.setStart(e,t-i);s.setEnd(e,t-i);r=true;break}i+=o}else if(e.nodeType===Node.ELEMENT_NODE){const n=e;if(n.tagName==="BR"){if(t===i){s.setStartBefore(e);s.setEndBefore(e);r=true;break}i+=1}else if(n.getAttribute("contenteditable")==="false"){if(t===i){s.setStartBefore(e);s.setEndBefore(e);r=true;break}i+=1}else{const t=e.childNodes;for(let e=t.length-1;e>=0;e--){a.push(t[e])}}}}if(!r){s.selectNodeContents(e);s.collapse(false)}o.removeAllRanges();o.addRange(s);if(document.activeElement!==e){e.focus({preventScroll:true})}}},73053:function(e,t,n){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:true});t.detectLanguage=i;t.highlightCode=r;const s=o(n(75271));function i(e){try{const t=s.default.highlightAuto(e,["python","javascript","typescript","java","html","css","cpp","csharp","sql","rust","php","bash","json","xml","markdown"]);if(t.relevance>5&&t.language){return t.language}if(/^(?:\s*)?(?:import\s+[^;]+;|package\s+[^;]+;|public\s+class)/.test(e)){return"java"}else if(/^(?:\s*)?(import|from|def|class|if __name__)/.test(e)){return"python"}else if(/^(?:\s*)?(?:function|const|let|var|import|export|=>)/.test(e)){if(/^(?:\s*)?(?:import\s.+|export\s.+|interface|type|enum|declare|:|\s<)/.test(e)){return"typescript"}return"javascript"}else if(/^(?:\s*)?(?:<!DOCTYPE|<html|<head|<body)/i.test(e)){return"html"}else if(/^(?:\s*)?#include/.test(e)){return"cpp"}else if(/^(?:\s*)?(?:using\s+System|namespace|public\s+static\s+void\s+Main)/.test(e)){return"csharp"}else if(/^(?:\s*)?(?:SELECT|INSERT|UPDATE|DELETE|CREATE|ALTER)\s/i.test(e)){return"sql"}else if(/^(?:\s*)?(?:fn|let|struct|enum|trait|impl|mod)\s/.test(e)){return"rust"}else if(/^(?:\s*)?(?:<\?php|use\s+[\w\\]+;)/.test(e)){return"php"}else if(/^(?:\s*)?(?:#\s*!\/bin\/(?:bash|sh|zsh)|\$)/.test(e)){return"bash"}else if(/^\s*\{/.test(e)&&/\}\s*$/.test(e)){return"json"}else if(/^\s*<\?xml/.test(e)||/^\s*<\w+/.test(e)){return"xml"}return""}catch(t){console.error("Error detecting language:",t);return""}}function r(e,t){try{if(t&&s.default.getLanguage(t)){return s.default.highlight(e,{language:t,ignoreIllegals:true}).value}else{return s.default.highlightAuto(e).value}}catch(n){console.error(`Error highlighting code (language: ${t||"auto"}):`,n);return e.replace(/</g,"&lt;").replace(/>/g,"&gt;")}}},46423:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:true});t.configureMarked=s;t.preprocessMarkdown=i;const o=n(14507);function s(){o.marked.setOptions({gfm:true,breaks:true,pedantic:false,async:false,silent:false})}function i(e){const t=e.replace(/\r\n/g,"\n");let n=false;const o=t.split("\n");const s=o.map(((e,t)=>{if(e.trim().startsWith("```")){n=!n;return e.trim()}if(n){return e}let o=e;o=o.replace(/(\s*)-(\S)/g,"$1- $2");o=o.replace(/([^\n\s])-\s/g,"$1\n- ");return o}));let i=s.join("\n");i=i.replace(/```(.*)\n```/g,"```$1\n \n```");return i}},44699:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:true});t.addMessageToCell=s;t.getSelectedText=i;t.isInNotebookCell=r;t.isInNotebookCellAndEditorFocused=a;t.isCodeCell=l;t.isOutputArea=c;t.getCurrentCellContent=d;t.insertCellContentByIndex=u;const o=n(40095);function s(e){var t;const n=(t=o.globals.notebookTracker)===null||t===void 0?void 0:t.activeCell;if(!n||!n.editor){console.warn("Cannot add message: No active cell or editor found.");return}try{const t=n.editor;const o=t.editor;if(!o){console.warn("Cannot add message: CodeMirror view not accessible.");return}const s=o.state;const i=s.selection;const r=i.main.head;const a=s.update({changes:{from:r,insert:`\n${e}`},selection:{anchor:r+e.length+1}});o.dispatch(a)}catch(s){console.error("Error adding message to cell:",s)}}function i(){var e,t,n;const s=(e=o.globals.notebookTracker)===null||e===void 0?void 0:e.activeCell;if(s===null||s===void 0?void 0:s.editor){const e=s.editor;const t=e.editor;if(t&&t.state){const e=t.state;const n=e.selection.main;return n.empty?null:e.doc.sliceString(n.from,n.to)}console.warn("Could not access CodeMirror state to get selection.");return null}else{const e=(n=(t=o.globals.app)===null||t===void 0?void 0:t.shell)===null||n===void 0?void 0:n.currentWidget;if(e&&"content"in e&&e.content.editor){const t=e.content.editor;const n=t.editor;if(n&&n.state){const e=n.state;const t=e.selection.main;return t.empty?null:e.doc.sliceString(t.from,t.to)}console.warn("Could not access CodeMirror state for non-notebook editor selection.");return null}}return null}function r(){var e;const t=(e=o.globals.notebookTracker)===null||e===void 0?void 0:e.activeCell;return t!==null}function a(){var e;const t=(e=o.globals.notebookTracker)===null||e===void 0?void 0:e.activeCell;if(t===null||t===void 0?void 0:t.editor){const e=t.editor;const n=e.editor;return n&&n.state}return false}function l(){var e,t;const n=(e=o.globals.notebookTracker)===null||e===void 0?void 0:e.activeCell;return((t=n===null||n===void 0?void 0:n.model)===null||t===void 0?void 0:t.type)==="code"}function c(){var e;const t=(e=o.globals.notebookTracker)===null||e===void 0?void 0:e.activeCell;if(!(t===null||t===void 0?void 0:t.model))return false;if(t.model.type!=="code")return false;const n=t.editor;if(!n)return false;const s=n.editor;if(!(s===null||s===void 0?void 0:s.state))return false;const i=s.dom;if(!i)return false;const r=document.activeElement;if(!r)return false;const a=i.nextElementSibling;if(!a)return false;return a.contains(r)}function d(){var e,t,n,s,i;const r=(e=o.globals.notebookTracker)===null||e===void 0?void 0:e.activeCell;if(r===null||r===void 0?void 0:r.model){if(r.model.sharedModel&&typeof r.model.sharedModel.getSource==="function"){return r.model.sharedModel.getSource()}const e=r.model.toJSON();const t=e===null||e===void 0?void 0:e.source;if(typeof t==="string"){return t}else if(Array.isArray(t)){return t.join("\n")}console.warn("Could not get cell content via sharedModel or toJSON().source");return null}const a=(n=(t=o.globals.app)===null||t===void 0?void 0:t.shell)===null||n===void 0?void 0:n.currentWidget;if(a&&"content"in a&&a.content.model){return(i=(s=a.content.model.value)===null||s===void 0?void 0:s.text)!==null&&i!==void 0?i:null}return null}function u(e,t){try{if(!o.globals.notebookTracker||!o.globals.notebookTracker.currentWidget){console.error("No active notebook found");return}const n=o.globals.notebookTracker.currentWidget;const s=n.content.model;if(!s||!s.cells||e<0||e>=s.cells.length){console.error(`Invalid cell index: ${e}`);return}const i=s.cells.get(e);let r="";if(i.sharedModel&&typeof i.sharedModel.getSource==="function"){r=i.sharedModel.getSource()}else{const e=i.toJSON();const t=e===null||e===void 0?void 0:e.source;if(typeof t==="string"){r=t}else if(Array.isArray(t)){r=t.join("\n")}}t(`cell ${r}`)}catch(n){console.error("Error inserting cell by index:",n)}}}}]);
//# sourceMappingURL=8735.edfbd5260cfd2e7d2f5e.js.map?v=edfbd5260cfd2e7d2f5e