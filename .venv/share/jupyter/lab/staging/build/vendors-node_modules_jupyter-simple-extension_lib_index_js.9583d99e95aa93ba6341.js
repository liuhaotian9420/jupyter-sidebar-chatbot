"use strict";
(self["webpackChunk_jupyterlab_application_top"] = self["webpackChunk_jupyterlab_application_top"] || []).push([["vendors-node_modules_jupyter-simple-extension_lib_index_js"],{

/***/ "./node_modules/jupyter-simple-extension/lib/api-client.js":
/*!*****************************************************************!*\
  !*** ./node_modules/jupyter-simple-extension/lib/api-client.js ***!
  \*****************************************************************/
/***/ ((__unused_webpack_module, exports) => {


Object.defineProperty(exports, "__esModule", ({ value: true }));
exports.ApiClient = void 0;
/**
 * API client for interacting with the backend LLM service
 */
class ApiClient {
    constructor(baseUrl = 'http://localhost:8000') {
        this.baseUrl = baseUrl;
    }
    /**
     * Stream a chat response from the mock LLM
     * @param message The user message to send
     * @param context Optional context information
     * @param onChunk Callback for each text chunk received
     * @param onComplete Callback when streaming is complete
     * @param onError Callback for errors
     */
    async streamChat(message, context = null, onChunk, onComplete, onError) {
        try {
            const response = await fetch(`${this.baseUrl}/chat`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message,
                    context
                })
            });
            if (!response.ok) {
                throw new Error(`API error: ${response.statusText}`);
            }
            if (!response.body) {
                throw new Error('ReadableStream not supported in this browser.');
            }
            // Set up stream reading
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let done = false;
            while (!done) {
                const { value, done: readerDone } = await reader.read();
                done = readerDone;
                if (value) {
                    const chunk = decoder.decode(value, { stream: !done });
                    onChunk(chunk);
                }
            }
            onComplete();
        }
        catch (error) {
            onError(error instanceof Error ? error : new Error(String(error)));
        }
    }
    /**
     * Simple health check for the API
     * @returns A promise that resolves to true if the API is healthy
     */
    async healthCheck() {
        try {
            const response = await fetch(`${this.baseUrl}/health`);
            return response.ok;
        }
        catch (error) {
            console.error('API health check failed:', error);
            return false;
        }
    }
}
exports.ApiClient = ApiClient;


/***/ }),

/***/ "./node_modules/jupyter-simple-extension/lib/cell-context-tracker.js":
/*!***************************************************************************!*\
  !*** ./node_modules/jupyter-simple-extension/lib/cell-context-tracker.js ***!
  \***************************************************************************/
/***/ ((__unused_webpack_module, exports) => {


Object.defineProperty(exports, "__esModule", ({ value: true }));
exports.CellContextTracker = void 0;
/**
 * Tracks cell context and cursor position within Jupyter notebooks
 */
class CellContextTracker {
    constructor(app, notebookTracker) {
        this.activeCellEditorNode = null;
        this.lastCellContext = null;
        this._isDisposed = false;
        /**
         * Handles editor events (keydown, mouseup)
         */
        this.handleEditorEvent = (event) => {
            try {
                // Get the current active cell from the tracker
                const cell = this.notebookTracker.activeCell;
                if (!cell || !cell.editor)
                    return;
                // Find the inner EditorView instance
                const editor = cell.editor;
                const view = editor.editor;
                if (!view)
                    return;
                // Get and store the cursor context
                this.lastCellContext = this.getCmContext(view);
            }
            catch (error) {
                console.error("Error in editor event handler:", error);
            }
        };
        this.notebookTracker = notebookTracker;
        this.setupTrackers();
    }
    /**
     * Whether this object has been disposed
     */
    get isDisposed() {
        return this._isDisposed;
    }
    /**
     * Sets up all the necessary event trackers
     */
    setupTrackers() {
        // Handle active cell changes
        this.notebookTracker.activeCellChanged.connect(this.setupCellListeners, this);
        // Handle notebook changes
        this.notebookTracker.currentChanged.connect(this.handleNotebookChange, this);
    }
    /**
     * Handles notebook changes
     */
    handleNotebookChange(tracker, panel) {
        this.cleanupPreviousListeners();
        if (panel && panel.content) {
            const cell = panel.content.activeCell;
            this.setupCellListeners(tracker, cell);
        }
    }
    /**
     * Sets up event listeners on the active cell
     */
    setupCellListeners(_tracker, cell) {
        if (!cell)
            return;
        this.cleanupPreviousListeners();
        if (cell.editor) {
            try {
                const cellNode = cell.node;
                const editorNode = cellNode.querySelector('.jp-Editor') ||
                    cellNode.querySelector('.jp-InputArea-editor');
                if (editorNode) {
                    this.activeCellEditorNode = editorNode;
                    // Add event listeners for key and mouse events
                    editorNode.addEventListener('keydown', this.handleEditorEvent);
                    editorNode.addEventListener('mouseup', this.handleEditorEvent);
                    // Try to capture immediate context if EditorView available
                    const view = cell.editor.editor;
                    if (view) {
                        this.lastCellContext = this.getCmContext(view);
                    }
                }
            }
            catch (error) {
                console.error("Error setting up cell listeners:", error);
            }
        }
    }
    /**
     * Cleans up event listeners from the previous active cell
     */
    cleanupPreviousListeners() {
        if (this.activeCellEditorNode) {
            this.activeCellEditorNode.removeEventListener('keydown', this.handleEditorEvent);
            this.activeCellEditorNode.removeEventListener('mouseup', this.handleEditorEvent);
            this.activeCellEditorNode = null;
        }
    }
    /**
     * Gets context information from CodeMirror EditorView
     */
    getCmContext(view) {
        const state = view.state;
        const offset = state.selection.main.head;
        const fullText = state.doc.toString();
        const line = state.doc.lineAt(offset);
        const position = {
            line: line.number - 1,
            column: offset - line.from,
            offset: offset
        };
        const contextRadius = 100;
        const start = Math.max(0, offset - contextRadius);
        const end = Math.min(fullText.length, offset + contextRadius);
        return {
            text: fullText,
            position: position,
            contextBefore: fullText.substring(start, offset),
            contextAfter: fullText.substring(offset, end)
        };
    }
    /**
     * Gets the current cell context
     */
    getCurrentCellContext() {
        return this.lastCellContext;
    }
    /**
     * Disposes all resources
     */
    dispose() {
        if (this._isDisposed) {
            return;
        }
        this._isDisposed = true;
        this.cleanupPreviousListeners();
        this.notebookTracker.activeCellChanged.disconnect(this.setupCellListeners, this);
        this.notebookTracker.currentChanged.disconnect(this.handleNotebookChange, this);
    }
}
exports.CellContextTracker = CellContextTracker;


/***/ }),

/***/ "./node_modules/jupyter-simple-extension/lib/commands.js":
/*!***************************************************************!*\
  !*** ./node_modules/jupyter-simple-extension/lib/commands.js ***!
  \***************************************************************/
/***/ ((__unused_webpack_module, exports, __webpack_require__) => {


Object.defineProperty(exports, "__esModule", ({ value: true }));
exports.registerCommands = registerCommands;
const icons_1 = __webpack_require__(/*! ./icons */ "./node_modules/jupyter-simple-extension/lib/icons.js");
/**
 * Registers commands for the extension
 */
function registerCommands(app, palette, launcher, sidebarWidget) {
    // Add command to toggle the sidebar
    app.commands.addCommand('simple-extension:toggle-sidebar', {
        label: 'Toggle AI Assistant Sidebar',
        icon: icons_1.extensionIcon,
        execute: () => {
            if (sidebarWidget.isAttached) {
                sidebarWidget.parent = null;
            }
            else {
                app.shell.add(sidebarWidget, 'left', { rank: 9999 });
            }
        }
    });
    // Add the command to the command palette
    palette.addItem({
        command: 'simple-extension:toggle-sidebar',
        category: 'Extension'
    });
    // Add a launcher item
    launcher.add({
        command: 'simple-extension:toggle-sidebar',
        category: 'Other',
        rank: 9999
    });
}


/***/ }),

/***/ "./node_modules/jupyter-simple-extension/lib/globals.js":
/*!**************************************************************!*\
  !*** ./node_modules/jupyter-simple-extension/lib/globals.js ***!
  \**************************************************************/
/***/ ((__unused_webpack_module, exports) => {


Object.defineProperty(exports, "__esModule", ({ value: true }));
exports.globals = void 0;
exports.initGlobals = initGlobals;
/**
 * Global references to key components in the application
 */
exports.globals = {};
/**
 * Initialize global references
 */
function initGlobals(app, notebookTracker) {
    exports.globals.app = app;
    exports.globals.notebookTracker = notebookTracker;
}


/***/ }),

/***/ "./node_modules/jupyter-simple-extension/lib/icons.js":
/*!************************************************************!*\
  !*** ./node_modules/jupyter-simple-extension/lib/icons.js ***!
  \************************************************************/
/***/ ((__unused_webpack_module, exports, __webpack_require__) => {


Object.defineProperty(exports, "__esModule", ({ value: true }));
exports.extensionIcon = void 0;
const ui_components_1 = __webpack_require__(/*! @jupyterlab/ui-components */ "webpack/sharing/consume/default/@jupyterlab/ui-components/@jupyterlab/ui-components");
// ===============================
// Icon Definition
// ===============================
const iconSvgStr = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chat-left-text" viewBox="0 0 16 16">' +
    '<path d="M14 1a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H4.414A2 2 0 0 0 3 11.586l-2 2V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v12.793a.5.5 0 0 0 .854.353l2.853-2.853A1 1 0 0 1 4.414 12H14a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"/>' +
    '<path d="M3 3.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zM3 6a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9A.5.5 0 0 1 3 6zm0 2.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5z"/>' +
    '</svg>';
/**
 * Icon for the AI Assistant extension
 */
exports.extensionIcon = new ui_components_1.LabIcon({
    name: 'simple:icon',
    svgstr: iconSvgStr
});


/***/ }),

/***/ "./node_modules/jupyter-simple-extension/lib/index.js":
/*!************************************************************!*\
  !*** ./node_modules/jupyter-simple-extension/lib/index.js ***!
  \************************************************************/
/***/ ((__unused_webpack_module, exports, __webpack_require__) => {


Object.defineProperty(exports, "__esModule", ({ value: true }));
exports.ApiClient = void 0;
const launcher_1 = __webpack_require__(/*! @jupyterlab/launcher */ "webpack/sharing/consume/default/@jupyterlab/launcher/@jupyterlab/launcher");
const apputils_1 = __webpack_require__(/*! @jupyterlab/apputils */ "webpack/sharing/consume/default/@jupyterlab/apputils/@jupyterlab/apputils");
const notebook_1 = __webpack_require__(/*! @jupyterlab/notebook */ "webpack/sharing/consume/default/@jupyterlab/notebook/@jupyterlab/notebook");
const docmanager_1 = __webpack_require__(/*! @jupyterlab/docmanager */ "webpack/sharing/consume/default/@jupyterlab/docmanager/@jupyterlab/docmanager");
const sidebar_widget_1 = __webpack_require__(/*! ./sidebar-widget */ "./node_modules/jupyter-simple-extension/lib/sidebar-widget.js");
const globals_1 = __webpack_require__(/*! ./globals */ "./node_modules/jupyter-simple-extension/lib/globals.js");
const commands_1 = __webpack_require__(/*! ./commands */ "./node_modules/jupyter-simple-extension/lib/commands.js");
const cell_context_tracker_1 = __webpack_require__(/*! ./cell-context-tracker */ "./node_modules/jupyter-simple-extension/lib/cell-context-tracker.js");
// import { ApiClient } from './api-client';
// Export ApiClient for use by other components
var api_client_1 = __webpack_require__(/*! ./api-client */ "./node_modules/jupyter-simple-extension/lib/api-client.js");
Object.defineProperty(exports, "ApiClient", ({ enumerable: true, get: function () { return api_client_1.ApiClient; } }));
/**
 * Initialization data for the jupyter-simple-extension extension.
 */
const plugin = {
    id: 'jupyter-simple-extension:plugin',
    autoStart: true,
    requires: [launcher_1.ILauncher, apputils_1.ICommandPalette, notebook_1.INotebookTracker, docmanager_1.IDocumentManager],
    activate: (jupyterApp, launcher, palette, tracker, docManager) => {
        console.log('JupyterLab extension jupyter-simple-extension is activated!');
        // Initialize global references
        (0, globals_1.initGlobals)(jupyterApp, tracker);
        // Initialize cell context tracker
        globals_1.globals.cellContextTracker = new cell_context_tracker_1.CellContextTracker(jupyterApp, tracker);
        // Create and add sidebar widget
        const sidebarWidget = new sidebar_widget_1.SimpleSidebarWidget(docManager);
        jupyterApp.shell.add(sidebarWidget, 'left', { rank: 9999 });
        // Register commands
        (0, commands_1.registerCommands)(jupyterApp, palette, launcher, sidebarWidget);
    }
};
exports["default"] = plugin;


/***/ }),

/***/ "./node_modules/jupyter-simple-extension/lib/markdown-config.js":
/*!**********************************************************************!*\
  !*** ./node_modules/jupyter-simple-extension/lib/markdown-config.js ***!
  \**********************************************************************/
/***/ ((__unused_webpack_module, exports, __webpack_require__) => {


Object.defineProperty(exports, "__esModule", ({ value: true }));
exports.configureMarked = configureMarked;
exports.preprocessMarkdown = preprocessMarkdown;
const marked_1 = __webpack_require__(/*! marked */ "webpack/sharing/consume/default/marked/marked");
/**
 * Configure marked with better rendering options for code blocks
 */
function configureMarked() {
    // Configure marked options
    marked_1.marked.setOptions({
        gfm: true, // Enable GitHub Flavored Markdown
        breaks: true, // Add <br> on single line breaks
        pedantic: false, // Conform to original markdown spec
        async: false, // Disable async rendering
        silent: false // Enable error reporting
    });
}
/**
 * Pre-process markdown text to fix common issues with streaming content
 */
function preprocessMarkdown(text) {
    // Handle code blocks first
    let inCodeBlock = false;
    const lines = text.split('\n');
    const processedLines = lines.map((line, i) => {
        // Check for code block markers
        if (line.trim().startsWith('```')) {
            inCodeBlock = !inCodeBlock;
            // Preserve language specification
            return line.trim();
        }
        // If we're in a code block, preserve the line as is
        if (inCodeBlock) {
            return line;
        }
        // Outside code blocks, handle list items
        return line.replace(/([^\n\s])-\s/g, '$1\n- ');
    });
    return processedLines.join('\n');
}


/***/ }),

/***/ "./node_modules/jupyter-simple-extension/lib/sidebar-widget.js":
/*!*********************************************************************!*\
  !*** ./node_modules/jupyter-simple-extension/lib/sidebar-widget.js ***!
  \*********************************************************************/
/***/ (function(__unused_webpack_module, exports, __webpack_require__) {


var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", ({ value: true }));
exports.SimpleSidebarWidget = void 0;
const widgets_1 = __webpack_require__(/*! @lumino/widgets */ "webpack/sharing/consume/default/@lumino/widgets/@lumino/widgets");
const notebook_1 = __webpack_require__(/*! @jupyterlab/notebook */ "webpack/sharing/consume/default/@jupyterlab/notebook/@jupyterlab/notebook");
const marked_1 = __webpack_require__(/*! marked */ "webpack/sharing/consume/default/marked/marked");
const dompurify_1 = __importDefault(__webpack_require__(/*! dompurify */ "webpack/sharing/consume/default/dompurify/dompurify"));
const icons_1 = __webpack_require__(/*! ./icons */ "./node_modules/jupyter-simple-extension/lib/icons.js");
const globals_1 = __webpack_require__(/*! ./globals */ "./node_modules/jupyter-simple-extension/lib/globals.js");
const api_client_1 = __webpack_require__(/*! ./api-client */ "./node_modules/jupyter-simple-extension/lib/api-client.js");
const markdown_config_1 = __webpack_require__(/*! ./markdown-config */ "./node_modules/jupyter-simple-extension/lib/markdown-config.js");
// import { ICellContext } from './types';
// import { ICellContext } from './types';
// Configure marked with our settings
(0, markdown_config_1.configureMarked)();
/**
 * Main sidebar widget for the AI chat interface
 */
class SimpleSidebarWidget extends widgets_1.Widget {
    constructor(docManager) {
        super();
        this.isMarkdownMode = false;
        this.isInputExpanded = false;
        this.chatHistory = [];
        this.currentChatId = '';
        this.isHistoryViewActive = false;
        /**
         * Handles keyboard shortcuts
         */
        this.handleKeyDown = (event) => {
            var _a, _b;
            // Check for Ctrl+L (for selected code)
            if (event.ctrlKey && event.key.toLowerCase() === 'l') {
                // Prevent default browser behavior
                event.preventDefault();
                event.stopPropagation();
                // Get the current active cell
                const cell = (_a = globals_1.globals.notebookTracker) === null || _a === void 0 ? void 0 : _a.activeCell;
                if (!cell || !cell.editor) {
                    return;
                }
                try {
                    // Get the CodeMirror editor instance
                    const editor = cell.editor;
                    const view = editor.editor;
                    if (!view) {
                        return;
                    }
                    // Check if there's a selection
                    const state = view.state;
                    const selection = state.selection;
                    if (!selection.main.empty) {
                        // If there's a selection, use @code
                        const from = selection.main.from;
                        const to = selection.main.to;
                        const selectedText = state.doc.sliceString(from, to);
                        this.appendToInput(`@code\n${selectedText}`);
                        this.showKeyboardShortcutIndicator('Selected code inserted');
                    }
                    else {
                        // If no selection, use @cell
                        const cellContext = (_b = globals_1.globals.cellContextTracker) === null || _b === void 0 ? void 0 : _b.getCurrentCellContext();
                        if (cellContext) {
                            this.appendToInput(`@cell\n${cellContext.text}`);
                            this.showKeyboardShortcutIndicator('Cell content inserted');
                        }
                    }
                    // Ensure the sidebar is visible and focused
                    if (this.isHidden) {
                        this.show();
                    }
                    this.inputField.focus();
                }
                catch (error) {
                    console.error('Error handling keyboard shortcut:', error);
                }
            }
        };
        /**
         * Handles clicks outside the command menu
         */
        this.handleClickOutside = (event) => {
            if (!this.commandMenuContainer.contains(event.target)) {
                this.hideCommandMenu();
            }
        };
        this.docManager = docManager;
        this.id = 'simple-sidebar';
        this.title.label = '';
        this.title.caption = 'AI Chat Interface';
        this.title.icon = icons_1.extensionIcon;
        this.title.closable = true;
        // Initialize API client
        this.apiClient = new api_client_1.ApiClient();
        // Initialize container elements before creating layout
        this.messageContainer = document.createElement('div');
        this.inputContainer = document.createElement('div');
        this.inputField = document.createElement('textarea');
        this.titleInput = document.createElement('input');
        this.historyContainer = document.createElement('div');
        this.commandMenuContainer = document.createElement('div');
        this.commandMenuContainer.className = 'command-menu-container';
        this.commandMenuContainer.style.display = 'none';
        // Create keyboard shortcut indicator
        this.keyboardShortcutIndicator = document.createElement('div');
        this.keyboardShortcutIndicator.className = 'keyboard-shortcut-indicator';
        document.body.appendChild(this.keyboardShortcutIndicator);
        // Create a new chat on start
        this.createNewChat();
        this.node.appendChild(this.createLayout());
        this.node.appendChild(this.commandMenuContainer);
        // Add keyboard shortcut listener
        document.addEventListener('keydown', this.handleKeyDown);
    }
    /**
     * Shows a visual indicator for keyboard shortcuts
     */
    showKeyboardShortcutIndicator(text) {
        this.keyboardShortcutIndicator.textContent = text;
        this.keyboardShortcutIndicator.classList.add('visible');
        // Hide after 1 second
        setTimeout(() => {
            this.keyboardShortcutIndicator.classList.remove('visible');
        }, 1000);
    }
    /**
     * Disposes all resources
     */
    dispose() {
        // Remove keyboard shortcut listener
        document.removeEventListener('keydown', this.handleKeyDown);
        // Remove keyboard shortcut indicator
        if (this.keyboardShortcutIndicator.parentNode) {
            this.keyboardShortcutIndicator.parentNode.removeChild(this.keyboardShortcutIndicator);
        }
        super.dispose();
    }
    /**
     * Creates the main layout for the sidebar
     */
    createLayout() {
        // Create the main container
        const content = document.createElement('div');
        content.className = 'simple-sidebar-content';
        // Create title input container
        const titleContainer = document.createElement('div');
        titleContainer.className = 'title-container';
        // Set up title input
        this.titleInput.className = 'chat-title-input';
        this.titleInput.type = 'text';
        this.titleInput.placeholder = 'Chat title';
        this.titleInput.value = 'New Chat';
        this.titleInput.addEventListener('change', () => this.updateCurrentChatTitle());
        titleContainer.appendChild(this.titleInput);
        // Configure top action buttons (New Chat & History)
        const topActionsContainer = document.createElement('div');
        topActionsContainer.className = 'top-actions-container';
        const newChatButton = document.createElement('button');
        newChatButton.className = 'jp-Button action-button';
        newChatButton.textContent = '+ New Chat';
        newChatButton.title = 'Start a new chat';
        newChatButton.addEventListener('click', () => this.createNewChat());
        const historyButton = document.createElement('button');
        historyButton.className = 'jp-Button action-button';
        historyButton.textContent = 'History';
        historyButton.title = 'View chat history';
        historyButton.addEventListener('click', () => this.toggleHistoryView());
        topActionsContainer.appendChild(newChatButton);
        topActionsContainer.appendChild(historyButton);
        // Configure message container
        this.messageContainer.className = 'message-container';
        // Configure history container
        this.historyContainer.className = 'history-container';
        this.historyContainer.style.display = 'none'; // Initially hidden
        // Configure input container
        this.inputContainer.className = 'input-container';
        // Create controls container
        const controlsContainer = this.createControlsContainer();
        // Configure input field
        this.inputField.placeholder = 'Ask me anything...';
        this.inputField.style.flexGrow = '1';
        this.inputField.style.padding = '5px';
        this.inputField.style.border = '1px solid #ccc';
        this.inputField.style.borderRadius = '3px';
        this.inputField.style.resize = 'none';
        this.inputField.rows = 1;
        this.inputField.style.overflowY = 'auto';
        // Add keypress listener to input field
        this.inputField.addEventListener('keypress', (event) => {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                this.handleSendMessage();
            }
        });
        // Create send button container
        const inputActionsContainer = document.createElement('div');
        inputActionsContainer.className = 'input-actions-container';
        // Create send button
        const sendButton = document.createElement('button');
        sendButton.className = 'jp-Button send-button';
        sendButton.textContent = 'Send';
        sendButton.addEventListener('click', () => this.handleSendMessage());
        // Add button to actions container
        inputActionsContainer.appendChild(sendButton);
        // Assemble the input components
        this.inputContainer.appendChild(controlsContainer);
        this.inputContainer.appendChild(this.inputField);
        this.inputContainer.appendChild(inputActionsContainer);
        // Assemble all components
        content.appendChild(topActionsContainer);
        content.appendChild(titleContainer);
        content.appendChild(this.messageContainer);
        content.appendChild(this.historyContainer);
        content.appendChild(this.inputContainer);
        return content;
    }
    /**
     * Creates a new chat session
     */
    createNewChat() {
        // Generate a unique ID for the chat
        const chatId = `chat-${Date.now()}`;
        // Create a new chat item
        const newChat = {
            id: chatId,
            title: 'New Chat',
            messages: []
        };
        // Add to history
        this.chatHistory.push(newChat);
        // Set as current chat
        this.currentChatId = chatId;
        // Update title input
        this.titleInput.value = newChat.title;
        // Clear message container
        if (this.messageContainer) {
            this.messageContainer.innerHTML = '';
        }
        // Hide history if it's visible
        if (this.isHistoryViewActive) {
            this.toggleHistoryView();
        }
    }
    /**
     * Toggles between chat view and history view
     */
    toggleHistoryView() {
        this.isHistoryViewActive = !this.isHistoryViewActive;
        if (this.isHistoryViewActive) {
            // Show history view, hide message view
            this.messageContainer.style.display = 'none';
            this.historyContainer.style.display = 'block';
            this.inputContainer.style.display = 'none';
            this.titleInput.style.display = 'none';
            // Populate history
            this.renderChatHistory();
        }
        else {
            // Show message view, hide history view
            this.messageContainer.style.display = 'block';
            this.historyContainer.style.display = 'none';
            this.inputContainer.style.display = 'flex';
            this.titleInput.style.display = 'block';
        }
    }
    /**
     * Renders the chat history in the history container
     */
    renderChatHistory() {
        this.historyContainer.innerHTML = '';
        if (this.chatHistory.length === 0) {
            const emptyMessage = document.createElement('div');
            emptyMessage.className = 'empty-history-message';
            emptyMessage.textContent = 'No chat history yet';
            this.historyContainer.appendChild(emptyMessage);
            return;
        }
        // Create a list of chat history items
        this.chatHistory.forEach(chat => {
            const historyItem = document.createElement('div');
            historyItem.className = 'history-item';
            if (chat.id === this.currentChatId) {
                historyItem.classList.add('active');
            }
            // Add title
            const title = document.createElement('div');
            title.className = 'history-title';
            title.textContent = chat.title;
            // Add message preview
            const preview = document.createElement('div');
            preview.className = 'history-preview';
            const lastMessage = chat.messages[chat.messages.length - 1];
            preview.textContent = lastMessage
                ? `${lastMessage.text.substring(0, 40)}${lastMessage.text.length > 40 ? '...' : ''}`
                : 'Empty chat';
            // Add click event
            historyItem.addEventListener('click', () => this.loadChat(chat.id));
            historyItem.appendChild(title);
            historyItem.appendChild(preview);
            this.historyContainer.appendChild(historyItem);
        });
    }
    /**
     * Loads a chat from history
     */
    loadChat(chatId) {
        const chat = this.chatHistory.find(c => c.id === chatId);
        if (!chat)
            return;
        // Set as current chat
        this.currentChatId = chatId;
        // Update title
        this.titleInput.value = chat.title;
        // Clear and re-populate message container
        this.messageContainer.innerHTML = '';
        chat.messages.forEach(msg => {
            this.addMessage(msg.text, msg.sender, msg.isMarkdown, false);
        });
        // Switch back to chat view
        if (this.isHistoryViewActive) {
            this.toggleHistoryView();
        }
    }
    /**
     * Updates the title of the current chat
     */
    updateCurrentChatTitle() {
        const chat = this.chatHistory.find(c => c.id === this.currentChatId);
        if (chat) {
            chat.title = this.titleInput.value;
        }
    }
    /**
     * Creates the controls container with toggles and action buttons
     */
    createControlsContainer() {
        const controlsContainer = document.createElement('div');
        controlsContainer.className = 'controls-container';
        // Create markdown toggle container
        const toggleContainer = document.createElement('div');
        toggleContainer.className = 'toggle-container';
        // Create markdown toggle
        const markdownToggle = document.createElement('input');
        markdownToggle.type = 'checkbox';
        markdownToggle.id = 'markdown-toggle';
        markdownToggle.style.marginRight = '5px';
        markdownToggle.addEventListener('change', (e) => {
            const target = e.target;
            this.isMarkdownMode = target.checked;
            this.inputField.placeholder = this.isMarkdownMode ?
                'Write markdown here...\n\n# Example heading\n- List item\n\n```code block```' :
                'Ask me anything...';
        });
        // Create toggle label
        const toggleLabel = document.createElement('label');
        toggleLabel.htmlFor = 'markdown-toggle';
        toggleLabel.textContent = 'Markdown mode';
        toggleLabel.style.fontSize = '12px';
        // Add toggle elements to container
        toggleContainer.appendChild(markdownToggle);
        toggleContainer.appendChild(toggleLabel);
        // Create action buttons container
        const actionButtonsContainer = document.createElement('div');
        actionButtonsContainer.className = 'action-buttons-container';
        // Create all action buttons
        const buttons = [
            {
                text: '@',
                title: 'Command list',
                action: (event) => {
                    event.preventDefault();
                    event.stopPropagation();
                    const rect = event.currentTarget.getBoundingClientRect();
                    this.showCommandMenu(rect.left, rect.bottom);
                }
            },
            { text: '📎', title: 'Upload file', action: () => { } },
            { text: '🔍', title: 'Browse files', action: () => { } },
            {
                text: '⤢',
                title: 'Expand input',
                action: () => this.toggleInputExpansion(actionButtonsContainer.children[3])
            },
            { text: '⚙️', title: 'Settings', action: () => { } },
            { text: '📁', title: 'List Directory Contents', action: () => this.listCurrentDirectoryContents() }
        ];
        // Add all buttons to the container
        buttons.forEach(button => {
            const btn = this.createButton(button.text, button.title);
            btn.addEventListener('click', (e) => button.action(e));
            actionButtonsContainer.appendChild(btn);
        });
        // Add toggle and action buttons to the controls container
        controlsContainer.appendChild(toggleContainer);
        controlsContainer.appendChild(actionButtonsContainer);
        return controlsContainer;
    }
    /**
     * Toggles the expansion state of the input field
     */
    toggleInputExpansion(button) {
        this.isInputExpanded = !this.isInputExpanded;
        if (this.isInputExpanded) {
            this.inputField.style.height = '100px';
            this.inputField.style.resize = 'vertical';
            button.textContent = '⤡';
            button.title = 'Collapse input';
        }
        else {
            this.inputField.style.height = 'auto';
            this.inputField.style.resize = 'none';
            button.textContent = '⤢';
            button.title = 'Expand input';
        }
    }
    /**
     * Helper function to create a button with given text and tooltip
     */
    createButton(text, tooltip) {
        const button = document.createElement('button');
        button.textContent = text;
        button.title = tooltip;
        button.className = 'jp-Button action-button';
        return button;
    }
    /**
     * Handles sending a message from the input field
     */
    handleSendMessage() {
        const message = this.inputField.value.trim();
        if (message) {
            // Add user message to UI
            this.addMessage(message, 'user', this.isMarkdownMode);
            this.inputField.value = '';
            // Reset expanded state if needed after sending
            if (this.isInputExpanded) {
                this.inputField.style.height = '100px';
            }
            else {
                this.inputField.style.height = 'auto';
                this.inputField.rows = 1;
            }
            // Create a temporary message container for the bot's streaming response
            const botMessageDiv = document.createElement('div');
            botMessageDiv.className = 'bot-message';
            const markdownIndicator = document.createElement('div');
            markdownIndicator.textContent = "MD";
            markdownIndicator.className = 'markdown-indicator';
            botMessageDiv.appendChild(markdownIndicator);
            // Create separate divs for streaming text and final markdown
            const streamingDiv = document.createElement('div');
            streamingDiv.className = 'streaming-content';
            streamingDiv.style.whiteSpace = 'pre-wrap';
            streamingDiv.style.fontFamily = 'monospace';
            streamingDiv.style.fontSize = '0.9em';
            botMessageDiv.appendChild(streamingDiv);
            const contentDiv = document.createElement('div');
            contentDiv.className = 'markdown-content';
            contentDiv.style.display = 'none'; // Initially hidden
            botMessageDiv.appendChild(contentDiv);
            this.messageContainer.appendChild(botMessageDiv);
            // Variable to collect the complete response
            let completeResponse = '';
            // Get cell context if available
            const cellContext = globals_1.globals.cellContextTracker ?
                globals_1.globals.cellContextTracker.getCurrentCellContext() : null;
            // Stream response from API
            this.apiClient.streamChat(message, { cellContext }, 
            // On each chunk received
            (chunk) => {
                completeResponse += chunk;
                streamingDiv.textContent = completeResponse;
                this.messageContainer.scrollTop = this.messageContainer.scrollHeight;
            }, 
            // On complete
            () => {
                // Hide streaming div, show markdown div
                streamingDiv.style.display = 'none';
                contentDiv.style.display = 'block';
                // Pre-process and render markdown
                try {
                    // Pre-process the markdown to fix any issues with code blocks
                    const processedMarkdown = (0, markdown_config_1.preprocessMarkdown)(completeResponse);
                    // Parse and sanitize
                    const rawHtml = marked_1.marked.parse(processedMarkdown);
                    const sanitizedHtml = dompurify_1.default.sanitize(rawHtml);
                    // Apply the HTML with proper code block styling
                    contentDiv.innerHTML = sanitizedHtml;
                    // Add syntax highlighting classes to code blocks
                    const codeBlocks = contentDiv.querySelectorAll('pre code');
                    codeBlocks.forEach(block => {
                        var _a;
                        block.classList.add('jp-RenderedText');
                        (_a = block.parentElement) === null || _a === void 0 ? void 0 : _a.classList.add('jp-RenderedHTMLCommon');
                    });
                    // Add action buttons to the bot message
                    console.log('Adding action buttons to streamed bot message');
                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'message-actions';
                    actionsDiv.style.display = 'flex'; // Ensure display is set
                    // Copy button with icon
                    const copyButton = document.createElement('button');
                    copyButton.className = 'message-action-button';
                    copyButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>';
                    copyButton.title = 'Copy message to clipboard';
                    copyButton.addEventListener('click', (event) => {
                        event.stopPropagation();
                        this.copyMessageToClipboard(completeResponse);
                    });
                    actionsDiv.appendChild(copyButton);
                    // Add to button with icon
                    const addToButton = document.createElement('button');
                    addToButton.className = 'message-action-button';
                    addToButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect><path d="M12 11v6"></path><path d="M9 14h6"></path></svg>';
                    addToButton.title = 'Add message to current cell';
                    addToButton.addEventListener('click', (event) => {
                        event.stopPropagation();
                        this.addMessageToCell(completeResponse);
                    });
                    actionsDiv.appendChild(addToButton);
                    // Add buttons to message
                    botMessageDiv.appendChild(actionsDiv);
                    console.log('Action buttons added to bot message:', actionsDiv);
                }
                catch (error) {
                    contentDiv.textContent = completeResponse;
                    console.error('Failed to render markdown:', error);
                }
                // Save to chat history
                const chat = this.chatHistory.find(c => c.id === this.currentChatId);
                if (chat) {
                    chat.messages.push({
                        text: completeResponse,
                        sender: 'bot',
                        isMarkdown: true
                    });
                }
                this.messageContainer.scrollTop = this.messageContainer.scrollHeight;
            }, 
            // On error
            (error) => {
                streamingDiv.style.display = 'none';
                contentDiv.style.display = 'block';
                contentDiv.innerHTML = `<div class="error-message">Error: ${error.message}</div>`;
                console.error('API Error:', error);
            });
        }
    }
    /**
     * Adds a message to the chat interface
     */
    addMessage(text, sender, isMarkdown = false, saveToHistory = true) {
        console.log('Adding message:', { sender, isMarkdown }); // Debug log
        const messageDiv = document.createElement('div');
        messageDiv.className = sender === 'user' ? 'user-message' : 'bot-message';
        // Add message content
        if (isMarkdown || sender === 'bot') {
            // Bot messages are always rendered as markdown
            const markdownIndicator = document.createElement('div');
            markdownIndicator.textContent = "MD";
            markdownIndicator.className = 'markdown-indicator';
            messageDiv.appendChild(markdownIndicator);
            // Create a container for the rendered markdown
            const contentDiv = document.createElement('div');
            contentDiv.className = 'markdown-content';
            try {
                // Pre-process the markdown text
                const processedText = (0, markdown_config_1.preprocessMarkdown)(text);
                // Parse and render markdown
                const rawHtml = marked_1.marked.parse(processedText);
                const sanitizedHtml = dompurify_1.default.sanitize(rawHtml);
                contentDiv.innerHTML = sanitizedHtml;
                // Add syntax highlighting classes to code blocks
                const codeBlocks = contentDiv.querySelectorAll('pre code');
                codeBlocks.forEach(block => {
                    var _a;
                    block.classList.add('jp-RenderedText');
                    (_a = block.parentElement) === null || _a === void 0 ? void 0 : _a.classList.add('jp-RenderedHTMLCommon');
                });
            }
            catch (error) {
                contentDiv.textContent = text;
                console.error('Failed to render markdown:', error);
            }
            messageDiv.appendChild(contentDiv);
            // Add action buttons for bot messages
            if (sender === 'bot') {
                console.log('Adding action buttons to bot message'); // Debug log
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'message-actions';
                // Copy button with icon
                const copyButton = document.createElement('button');
                copyButton.className = 'message-action-button';
                copyButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>';
                copyButton.title = 'Copy message to clipboard';
                copyButton.addEventListener('click', (event) => {
                    event.stopPropagation();
                    this.copyMessageToClipboard(text);
                });
                actionsDiv.appendChild(copyButton);
                // Add to button with icon
                const addToButton = document.createElement('button');
                addToButton.className = 'message-action-button';
                addToButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect><path d="M12 11v6"></path><path d="M9 14h6"></path></svg>';
                addToButton.title = 'Add message to current cell';
                addToButton.addEventListener('click', (event) => {
                    event.stopPropagation();
                    this.addMessageToCell(text);
                });
                actionsDiv.appendChild(addToButton);
                // Add buttons to message
                messageDiv.appendChild(actionsDiv);
                console.log('Action buttons added to message:', actionsDiv); // Debug log
            }
        }
        else {
            messageDiv.textContent = text;
        }
        this.messageContainer.appendChild(messageDiv);
        this.messageContainer.scrollTop = this.messageContainer.scrollHeight;
        // Save to chat history
        if (saveToHistory) {
            const chat = this.chatHistory.find(c => c.id === this.currentChatId);
            if (chat) {
                chat.messages.push({
                    text,
                    sender,
                    isMarkdown: isMarkdown || sender === 'bot'
                });
            }
        }
    }
    /**
     * Copies message content to clipboard
     */
    copyMessageToClipboard(text) {
        try {
            navigator.clipboard.writeText(text).then(() => {
                console.log('Content copied to clipboard');
                // Find the button element that was clicked
                const buttons = document.querySelectorAll('.message-action-button');
                let clickedButton = null;
                for (let i = 0; i < buttons.length; i++) {
                    const button = buttons[i];
                    if (button.title === 'Copy message to clipboard' && button === document.activeElement) {
                        clickedButton = button;
                        break;
                    }
                }
                // Show visual feedback if we found the button
                if (clickedButton) {
                    const originalHTML = clickedButton.innerHTML;
                    clickedButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6L9 17l-5-5"></path></svg>';
                    setTimeout(() => {
                        clickedButton.innerHTML = originalHTML;
                    }, 2000);
                }
            }).catch(err => {
                console.error('Failed to copy text: ', err);
            });
        }
        catch (error) {
            console.error('Error copying to clipboard:', error);
        }
    }
    /**
     * Adds message content to the current cell
     */
    addMessageToCell(text) {
        var _a;
        const cell = (_a = globals_1.globals.notebookTracker) === null || _a === void 0 ? void 0 : _a.activeCell;
        if (!cell || !cell.editor) {
            return;
        }
        try {
            const editor = cell.editor;
            const view = editor.editor;
            if (!view) {
                return;
            }
            // Get current cursor position
            const state = view.state;
            const selection = state.selection;
            const cursorPos = selection.main.head;
            // Insert newline and message content at cursor position
            const transaction = state.update({
                changes: {
                    from: cursorPos,
                    insert: `\n${text}`
                },
                selection: { anchor: cursorPos + text.length + 1 }
            });
            view.dispatch(transaction);
        }
        catch (error) {
            console.error('Error adding message to cell:', error);
        }
    }
    /**
     * Lists the contents of the current directory
     */
    async listCurrentDirectoryContents() {
        let dirPath = null;
        let source = null;
        // Try to get directory path from current widget
        const app = globals_1.globals.app;
        if (!app) {
            this.addMessage('Error: Application reference not available', 'bot', false);
            return;
        }
        const currentShellWidget = app.shell.currentWidget;
        if (currentShellWidget) {
            const widgetContext = this.docManager.contextForWidget(currentShellWidget);
            if (widgetContext) {
                const path = widgetContext.path;
                const lastSlash = path.lastIndexOf('/');
                dirPath = lastSlash === -1 ? '' : path.substring(0, lastSlash);
                source = 'widget context';
            }
        }
        // Fallback to notebook tracker if no context from widget
        if (dirPath === null && globals_1.globals.notebookTracker) {
            const currentNotebookPanel = globals_1.globals.notebookTracker.currentWidget;
            if (currentNotebookPanel instanceof notebook_1.NotebookPanel) {
                const nbPath = currentNotebookPanel.context.path;
                const lastSlash = nbPath.lastIndexOf('/');
                dirPath = lastSlash === -1 ? '' : nbPath.substring(0, lastSlash);
                source = 'active notebook';
            }
        }
        // List contents if path was found
        if (dirPath !== null) {
            try {
                const contents = await this.docManager.services.contents.get(dirPath);
                if (contents.content && contents.content.length > 0) {
                    const messageContent = `Directory contents (${source}):\n${contents.content.map((item) => `- ${item.name} (${item.type})`).join('\n')}`;
                    this.addMessage(messageContent, 'bot', true);
                }
                else {
                    this.addMessage(`Directory "${dirPath || '/'}" is empty.`, 'bot', true);
                }
            }
            catch (error) {
                this.addMessage(`Error listing directory contents for "${dirPath}": ${error}`, 'bot', true);
            }
        }
        else {
            this.addMessage('Could not determine current directory context.', 'bot', true);
        }
    }
    /**
     * Shows the command menu at the specified position
     */
    showCommandMenu(x, y) {
        const commands = [
            {
                label: 'code',
                description: 'Insert selected code',
                action: () => this.handleCodeCommand()
            },
            {
                label: 'cell',
                description: 'Insert entire cell content',
                action: () => this.handleCellCommand()
            }
        ];
        // Clear existing content
        this.commandMenuContainer.innerHTML = '';
        // Create menu items
        commands.forEach(cmd => {
            const item = document.createElement('div');
            item.className = 'command-menu-item';
            const label = document.createElement('div');
            label.className = 'command-label';
            label.textContent = cmd.label;
            const desc = document.createElement('div');
            desc.className = 'command-description';
            desc.textContent = cmd.description;
            item.appendChild(label);
            item.appendChild(desc);
            item.addEventListener('click', () => {
                cmd.action();
                this.hideCommandMenu();
            });
            this.commandMenuContainer.appendChild(item);
        });
        // Position and show menu
        this.commandMenuContainer.style.position = 'absolute';
        this.commandMenuContainer.style.left = `${x}px`;
        this.commandMenuContainer.style.top = `${y}px`;
        this.commandMenuContainer.style.display = 'block';
        // Add click outside listener
        document.addEventListener('click', this.handleClickOutside);
    }
    /**
     * Hides the command menu
     */
    hideCommandMenu() {
        this.commandMenuContainer.style.display = 'none';
        document.removeEventListener('click', this.handleClickOutside);
    }
    /**
     * Handles the code command - inserts selected code
     */
    handleCodeCommand() {
        var _a;
        const selectedText = this.getSelectedText();
        if (selectedText) {
            this.appendToInput(`@code\n${selectedText}`);
        }
        else {
            // If no selection, get the entire cell content
            const cellContext = (_a = globals_1.globals.cellContextTracker) === null || _a === void 0 ? void 0 : _a.getCurrentCellContext();
            if (cellContext) {
                this.appendToInput(`@code\n${cellContext.text}`);
            }
        }
    }
    /**
     * Handles the cell command - inserts entire cell content
     */
    handleCellCommand() {
        var _a;
        const cellContext = (_a = globals_1.globals.cellContextTracker) === null || _a === void 0 ? void 0 : _a.getCurrentCellContext();
        if (cellContext) {
            this.appendToInput(`@cell\n${cellContext.text}`);
        }
    }
    /**
     * Appends text to the input field with proper spacing
     */
    appendToInput(text) {
        try {
            const currentValue = this.inputField.value;
            if (currentValue) {
                // If there's existing content, add a newline before appending
                this.inputField.value = `${currentValue}\n\n${text}`;
            }
            else {
                this.inputField.value = text;
            }
            // Focus the input field and move cursor to end
            this.inputField.focus();
            this.inputField.setSelectionRange(this.inputField.value.length, this.inputField.value.length);
        }
        catch (error) {
            console.error('Error appending to input:', error);
        }
    }
    /**
     * Gets the selected text from cell context
     */
    getSelectedText() {
        var _a;
        // Get the current active cell from the tracker
        const cell = (_a = globals_1.globals.notebookTracker) === null || _a === void 0 ? void 0 : _a.activeCell;
        if (!cell || !cell.editor) {
            return '';
        }
        // Get the CodeMirror editor instance
        const editor = cell.editor;
        const view = editor.editor;
        if (!view) {
            return '';
        }
        // Get the selection from CodeMirror
        const state = view.state;
        const selection = state.selection;
        // If there's no selection, return empty string
        if (selection.main.empty) {
            return '';
        }
        // Get the selected text
        const from = selection.main.from;
        const to = selection.main.to;
        return state.doc.sliceString(from, to);
    }
}
exports.SimpleSidebarWidget = SimpleSidebarWidget;


/***/ })

}]);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmVuZG9ycy1ub2RlX21vZHVsZXNfanVweXRlci1zaW1wbGUtZXh0ZW5zaW9uX2xpYl9pbmRleF9qcy45NTgzZDk5ZTk1YWE5M2JhNjM0MS5qcyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFBYTtBQUNiLDhDQUE2QyxFQUFFLGFBQWEsRUFBQztBQUM3RCxpQkFBaUI7QUFDakI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLDRDQUE0QyxhQUFhO0FBQ3pEO0FBQ0E7QUFDQTtBQUNBLGlCQUFpQjtBQUNqQjtBQUNBO0FBQ0E7QUFDQSxpQkFBaUI7QUFDakIsYUFBYTtBQUNiO0FBQ0EsOENBQThDLG9CQUFvQjtBQUNsRTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSx3QkFBd0IsMEJBQTBCO0FBQ2xEO0FBQ0E7QUFDQSwwREFBMEQsZUFBZTtBQUN6RTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSw0Q0FBNEMsYUFBYTtBQUN6RDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsaUJBQWlCOzs7Ozs7Ozs7OztBQ3JFSjtBQUNiLDhDQUE2QyxFQUFFLGFBQWEsRUFBQztBQUM3RCwwQkFBMEI7QUFDMUI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNB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QUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxzREFBc0Q7QUFDdEQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsK0JBQStCLFdBQVc7QUFDMUM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHFCQUFxQixrQ0FBa0MsRUFBRSwwQ0FBMEM7QUFDbkc7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiLGNBQWMscURBQXFEO0FBQ25FLGNBQWMsc0RBQXNEO0FBQ3BFO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiLGNBQWMsa0RBQWtEO0FBQ2hFLGNBQWM7QUFDZDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNB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Q0EseUVBQXlFLFFBQVEsS0FBSyxNQUFNO0FBQzVGO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQSxrREFBa0QsRUFBRTtBQUNwRCxpREFBaUQsRUFBRTtBQUNuRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSx5Q0FBeUMsYUFBYTtBQUN0RDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsNkNBQTZDLGlCQUFpQjtBQUM5RDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHlDQUF5QyxpQkFBaUI7QUFDMUQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSwyQ0FBMkMsYUFBYSxNQUFNLEtBQUs7QUFDbkU7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLDJCQUEyQiIsInNvdXJjZXMiOlsid2VicGFjazovL0BqdXB5dGVybGFiL2FwcGxpY2F0aW9uLXRvcC8uL25vZGVfbW9kdWxlcy9qdXB5dGVyLXNpbXBsZS1leHRlbnNpb24vbGliL2FwaS1jbGllbnQuanMiLCJ3ZWJwYWNrOi8vQGp1cHl0ZXJsYWIvYXBwbGljYXRpb24tdG9wLy4vbm9kZV9tb2R1bGVzL2p1cHl0ZXItc2ltcGxlLWV4dGVuc2lvbi9saWIvY2VsbC1jb250ZXh0LXRyYWNrZXIuanMiLCJ3ZWJwYWNrOi8vQGp1cHl0ZXJsYWIvYXBwbGljYXRpb24tdG9wLy4vbm9kZV9tb2R1bGVzL2p1cHl0ZXItc2ltcGxlLWV4dGVuc2lvbi9saWIvY29tbWFuZHMuanMiLCJ3ZWJwYWNrOi8vQGp1cHl0ZXJsYWIvYXBwbGljYXRpb24tdG9wLy4vbm9kZV9tb2R1bGVzL2p1cHl0ZXItc2ltcGxlLWV4dGVuc2lvbi9saWIvZ2xvYmFscy5qcyIsIndlYnBhY2s6Ly9AanVweXRlcmxhYi9hcHBsaWNhdGlvbi10b3AvLi9ub2RlX21vZHVsZXMvanVweXRlci1zaW1wbGUtZXh0ZW5zaW9uL2xpYi9pY29ucy5qcyIsIndlYnBhY2s6Ly9AanVweXRlcmxhYi9hcHBsaWNhdGlvbi10b3AvLi9ub2RlX21vZHVsZXMvanVweXRlci1zaW1wbGUtZXh0ZW5zaW9uL2xpYi9pbmRleC5qcyIsIndlYnBhY2s6Ly9AanVweXRlcmxhYi9hcHBsaWNhdGlvbi10b3AvLi9ub2RlX21vZHVsZXMvanVweXRlci1zaW1wbGUtZXh0ZW5zaW9uL2xpYi9tYXJrZG93bi1jb25maWcuanMiLCJ3ZWJwYWNrOi8vQGp1cHl0ZXJsYWIvYXBwbGljYXRpb24tdG9wLy4vbm9kZV9tb2R1bGVzL2p1cHl0ZXItc2ltcGxlLWV4dGVuc2lvbi9saWIvc2lkZWJhci13aWRnZXQuanMiXSwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHsgdmFsdWU6IHRydWUgfSk7XG5leHBvcnRzLkFwaUNsaWVudCA9IHZvaWQgMDtcbi8qKlxuICogQVBJIGNsaWVudCBmb3IgaW50ZXJhY3Rpbmcgd2l0aCB0aGUgYmFja2VuZCBMTE0gc2VydmljZVxuICovXG5jbGFzcyBBcGlDbGllbnQge1xuICAgIGNvbnN0cnVjdG9yKGJhc2VVcmwgPSAnaHR0cDovL2xvY2FsaG9zdDo4MDAwJykge1xuICAgICAgICB0aGlzLmJhc2VVcmwgPSBiYXNlVXJsO1xuICAgIH1cbiAgICAvKipcbiAgICAgKiBTdHJlYW0gYSBjaGF0IHJlc3BvbnNlIGZyb20gdGhlIG1vY2sgTExNXG4gICAgICogQHBhcmFtIG1lc3NhZ2UgVGhlIHVzZXIgbWVzc2FnZSB0byBzZW5kXG4gICAgICogQHBhcmFtIGNvbnRleHQgT3B0aW9uYWwgY29udGV4dCBpbmZvcm1hdGlvblxuICAgICAqIEBwYXJhbSBvbkNodW5rIENhbGxiYWNrIGZvciBlYWNoIHRleHQgY2h1bmsgcmVjZWl2ZWRcbiAgICAgKiBAcGFyYW0gb25Db21wbGV0ZSBDYWxsYmFjayB3aGVuIHN0cmVhbWluZyBpcyBjb21wbGV0ZVxuICAgICAqIEBwYXJhbSBvbkVycm9yIENhbGxiYWNrIGZvciBlcnJvcnNcbiAgICAgKi9cbiAgICBhc3luYyBzdHJlYW1DaGF0KG1lc3NhZ2UsIGNvbnRleHQgPSBudWxsLCBvbkNodW5rLCBvbkNvbXBsZXRlLCBvbkVycm9yKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGZldGNoKGAke3RoaXMuYmFzZVVybH0vY2hhdGAsIHtcbiAgICAgICAgICAgICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgICAgICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgICAgICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgICAgICAgICAgIG1lc3NhZ2UsXG4gICAgICAgICAgICAgICAgICAgIGNvbnRleHRcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBpZiAoIXJlc3BvbnNlLm9rKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBBUEkgZXJyb3I6ICR7cmVzcG9uc2Uuc3RhdHVzVGV4dH1gKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICghcmVzcG9uc2UuYm9keSkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignUmVhZGFibGVTdHJlYW0gbm90IHN1cHBvcnRlZCBpbiB0aGlzIGJyb3dzZXIuJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyBTZXQgdXAgc3RyZWFtIHJlYWRpbmdcbiAgICAgICAgICAgIGNvbnN0IHJlYWRlciA9IHJlc3BvbnNlLmJvZHkuZ2V0UmVhZGVyKCk7XG4gICAgICAgICAgICBjb25zdCBkZWNvZGVyID0gbmV3IFRleHREZWNvZGVyKCk7XG4gICAgICAgICAgICBsZXQgZG9uZSA9IGZhbHNlO1xuICAgICAgICAgICAgd2hpbGUgKCFkb25lKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgeyB2YWx1ZSwgZG9uZTogcmVhZGVyRG9uZSB9ID0gYXdhaXQgcmVhZGVyLnJlYWQoKTtcbiAgICAgICAgICAgICAgICBkb25lID0gcmVhZGVyRG9uZTtcbiAgICAgICAgICAgICAgICBpZiAodmFsdWUpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgY2h1bmsgPSBkZWNvZGVyLmRlY29kZSh2YWx1ZSwgeyBzdHJlYW06ICFkb25lIH0pO1xuICAgICAgICAgICAgICAgICAgICBvbkNodW5rKGNodW5rKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBvbkNvbXBsZXRlKCk7XG4gICAgICAgIH1cbiAgICAgICAgY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBvbkVycm9yKGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvciA6IG5ldyBFcnJvcihTdHJpbmcoZXJyb3IpKSk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgLyoqXG4gICAgICogU2ltcGxlIGhlYWx0aCBjaGVjayBmb3IgdGhlIEFQSVxuICAgICAqIEByZXR1cm5zIEEgcHJvbWlzZSB0aGF0IHJlc29sdmVzIHRvIHRydWUgaWYgdGhlIEFQSSBpcyBoZWFsdGh5XG4gICAgICovXG4gICAgYXN5bmMgaGVhbHRoQ2hlY2soKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGZldGNoKGAke3RoaXMuYmFzZVVybH0vaGVhbHRoYCk7XG4gICAgICAgICAgICByZXR1cm4gcmVzcG9uc2Uub2s7XG4gICAgICAgIH1cbiAgICAgICAgY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKCdBUEkgaGVhbHRoIGNoZWNrIGZhaWxlZDonLCBlcnJvcik7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICB9XG59XG5leHBvcnRzLkFwaUNsaWVudCA9IEFwaUNsaWVudDtcbiIsIlwidXNlIHN0cmljdFwiO1xuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xuZXhwb3J0cy5DZWxsQ29udGV4dFRyYWNrZXIgPSB2b2lkIDA7XG4vKipcbiAqIFRyYWNrcyBjZWxsIGNvbnRleHQgYW5kIGN1cnNvciBwb3NpdGlvbiB3aXRoaW4gSnVweXRlciBub3RlYm9va3NcbiAqL1xuY2xhc3MgQ2VsbENvbnRleHRUcmFja2VyIHtcbiAgICBjb25zdHJ1Y3RvcihhcHAsIG5vdGVib29rVHJhY2tlcikge1xuICAgICAgICB0aGlzLmFjdGl2ZUNlbGxFZGl0b3JOb2RlID0gbnVsbDtcbiAgICAgICAgdGhpcy5sYXN0Q2VsbENvbnRleHQgPSBudWxsO1xuICAgICAgICB0aGlzLl9pc0Rpc3Bvc2VkID0gZmFsc2U7XG4gICAgICAgIC8qKlxuICAgICAgICAgKiBIYW5kbGVzIGVkaXRvciBldmVudHMgKGtleWRvd24sIG1vdXNldXApXG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLmhhbmRsZUVkaXRvckV2ZW50ID0gKGV2ZW50KSA9PiB7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIC8vIEdldCB0aGUgY3VycmVudCBhY3RpdmUgY2VsbCBmcm9tIHRoZSB0cmFja2VyXG4gICAgICAgICAgICAgICAgY29uc3QgY2VsbCA9IHRoaXMubm90ZWJvb2tUcmFja2VyLmFjdGl2ZUNlbGw7XG4gICAgICAgICAgICAgICAgaWYgKCFjZWxsIHx8ICFjZWxsLmVkaXRvcilcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIC8vIEZpbmQgdGhlIGlubmVyIEVkaXRvclZpZXcgaW5zdGFuY2VcbiAgICAgICAgICAgICAgICBjb25zdCBlZGl0b3IgPSBjZWxsLmVkaXRvcjtcbiAgICAgICAgICAgICAgICBjb25zdCB2aWV3ID0gZWRpdG9yLmVkaXRvcjtcbiAgICAgICAgICAgICAgICBpZiAoIXZpZXcpXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICAvLyBHZXQgYW5kIHN0b3JlIHRoZSBjdXJzb3IgY29udGV4dFxuICAgICAgICAgICAgICAgIHRoaXMubGFzdENlbGxDb250ZXh0ID0gdGhpcy5nZXRDbUNvbnRleHQodmlldyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKFwiRXJyb3IgaW4gZWRpdG9yIGV2ZW50IGhhbmRsZXI6XCIsIGVycm9yKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5ub3RlYm9va1RyYWNrZXIgPSBub3RlYm9va1RyYWNrZXI7XG4gICAgICAgIHRoaXMuc2V0dXBUcmFja2VycygpO1xuICAgIH1cbiAgICAvKipcbiAgICAgKiBXaGV0aGVyIHRoaXMgb2JqZWN0IGhhcyBiZWVuIGRpc3Bvc2VkXG4gICAgICovXG4gICAgZ2V0IGlzRGlzcG9zZWQoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9pc0Rpc3Bvc2VkO1xuICAgIH1cbiAgICAvKipcbiAgICAgKiBTZXRzIHVwIGFsbCB0aGUgbmVjZXNzYXJ5IGV2ZW50IHRyYWNrZXJzXG4gICAgICovXG4gICAgc2V0dXBUcmFja2VycygpIHtcbiAgICAgICAgLy8gSGFuZGxlIGFjdGl2ZSBjZWxsIGNoYW5nZXNcbiAgICAgICAgdGhpcy5ub3RlYm9va1RyYWNrZXIuYWN0aXZlQ2VsbENoYW5nZWQuY29ubmVjdCh0aGlzLnNldHVwQ2VsbExpc3RlbmVycywgdGhpcyk7XG4gICAgICAgIC8vIEhhbmRsZSBub3RlYm9vayBjaGFuZ2VzXG4gICAgICAgIHRoaXMubm90ZWJvb2tUcmFja2VyLmN1cnJlbnRDaGFuZ2VkLmNvbm5lY3QodGhpcy5oYW5kbGVOb3RlYm9va0NoYW5nZSwgdGhpcyk7XG4gICAgfVxuICAgIC8qKlxuICAgICAqIEhhbmRsZXMgbm90ZWJvb2sgY2hhbmdlc1xuICAgICAqL1xuICAgIGhhbmRsZU5vdGVib29rQ2hhbmdlKHRyYWNrZXIsIHBhbmVsKSB7XG4gICAgICAgIHRoaXMuY2xlYW51cFByZXZpb3VzTGlzdGVuZXJzKCk7XG4gICAgICAgIGlmIChwYW5lbCAmJiBwYW5lbC5jb250ZW50KSB7XG4gICAgICAgICAgICBjb25zdCBjZWxsID0gcGFuZWwuY29udGVudC5hY3RpdmVDZWxsO1xuICAgICAgICAgICAgdGhpcy5zZXR1cENlbGxMaXN0ZW5lcnModHJhY2tlciwgY2VsbCk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgLyoqXG4gICAgICogU2V0cyB1cCBldmVudCBsaXN0ZW5lcnMgb24gdGhlIGFjdGl2ZSBjZWxsXG4gICAgICovXG4gICAgc2V0dXBDZWxsTGlzdGVuZXJzKF90cmFja2VyLCBjZWxsKSB7XG4gICAgICAgIGlmICghY2VsbClcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgdGhpcy5jbGVhbnVwUHJldmlvdXNMaXN0ZW5lcnMoKTtcbiAgICAgICAgaWYgKGNlbGwuZWRpdG9yKSB7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGNlbGxOb2RlID0gY2VsbC5ub2RlO1xuICAgICAgICAgICAgICAgIGNvbnN0IGVkaXRvck5vZGUgPSBjZWxsTm9kZS5xdWVyeVNlbGVjdG9yKCcuanAtRWRpdG9yJykgfHxcbiAgICAgICAgICAgICAgICAgICAgY2VsbE5vZGUucXVlcnlTZWxlY3RvcignLmpwLUlucHV0QXJlYS1lZGl0b3InKTtcbiAgICAgICAgICAgICAgICBpZiAoZWRpdG9yTm9kZSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmFjdGl2ZUNlbGxFZGl0b3JOb2RlID0gZWRpdG9yTm9kZTtcbiAgICAgICAgICAgICAgICAgICAgLy8gQWRkIGV2ZW50IGxpc3RlbmVycyBmb3Iga2V5IGFuZCBtb3VzZSBldmVudHNcbiAgICAgICAgICAgICAgICAgICAgZWRpdG9yTm9kZS5hZGRFdmVudExpc3RlbmVyKCdrZXlkb3duJywgdGhpcy5oYW5kbGVFZGl0b3JFdmVudCk7XG4gICAgICAgICAgICAgICAgICAgIGVkaXRvck5vZGUuYWRkRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIHRoaXMuaGFuZGxlRWRpdG9yRXZlbnQpO1xuICAgICAgICAgICAgICAgICAgICAvLyBUcnkgdG8gY2FwdHVyZSBpbW1lZGlhdGUgY29udGV4dCBpZiBFZGl0b3JWaWV3IGF2YWlsYWJsZVxuICAgICAgICAgICAgICAgICAgICBjb25zdCB2aWV3ID0gY2VsbC5lZGl0b3IuZWRpdG9yO1xuICAgICAgICAgICAgICAgICAgICBpZiAodmlldykge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sYXN0Q2VsbENvbnRleHQgPSB0aGlzLmdldENtQ29udGV4dCh2aWV3KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoXCJFcnJvciBzZXR0aW5nIHVwIGNlbGwgbGlzdGVuZXJzOlwiLCBlcnJvcik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgLyoqXG4gICAgICogQ2xlYW5zIHVwIGV2ZW50IGxpc3RlbmVycyBmcm9tIHRoZSBwcmV2aW91cyBhY3RpdmUgY2VsbFxuICAgICAqL1xuICAgIGNsZWFudXBQcmV2aW91c0xpc3RlbmVycygpIHtcbiAgICAgICAgaWYgKHRoaXMuYWN0aXZlQ2VsbEVkaXRvck5vZGUpIHtcbiAgICAgICAgICAgIHRoaXMuYWN0aXZlQ2VsbEVkaXRvck5vZGUucmVtb3ZlRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIHRoaXMuaGFuZGxlRWRpdG9yRXZlbnQpO1xuICAgICAgICAgICAgdGhpcy5hY3RpdmVDZWxsRWRpdG9yTm9kZS5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgdGhpcy5oYW5kbGVFZGl0b3JFdmVudCk7XG4gICAgICAgICAgICB0aGlzLmFjdGl2ZUNlbGxFZGl0b3JOb2RlID0gbnVsbDtcbiAgICAgICAgfVxuICAgIH1cbiAgICAvKipcbiAgICAgKiBHZXRzIGNvbnRleHQgaW5mb3JtYXRpb24gZnJvbSBDb2RlTWlycm9yIEVkaXRvclZpZXdcbiAgICAgKi9cbiAgICBnZXRDbUNvbnRleHQodmlldykge1xuICAgICAgICBjb25zdCBzdGF0ZSA9IHZpZXcuc3RhdGU7XG4gICAgICAgIGNvbnN0IG9mZnNldCA9IHN0YXRlLnNlbGVjdGlvbi5tYWluLmhlYWQ7XG4gICAgICAgIGNvbnN0IGZ1bGxUZXh0ID0gc3RhdGUuZG9jLnRvU3RyaW5nKCk7XG4gICAgICAgIGNvbnN0IGxpbmUgPSBzdGF0ZS5kb2MubGluZUF0KG9mZnNldCk7XG4gICAgICAgIGNvbnN0IHBvc2l0aW9uID0ge1xuICAgICAgICAgICAgbGluZTogbGluZS5udW1iZXIgLSAxLFxuICAgICAgICAgICAgY29sdW1uOiBvZmZzZXQgLSBsaW5lLmZyb20sXG4gICAgICAgICAgICBvZmZzZXQ6IG9mZnNldFxuICAgICAgICB9O1xuICAgICAgICBjb25zdCBjb250ZXh0UmFkaXVzID0gMTAwO1xuICAgICAgICBjb25zdCBzdGFydCA9IE1hdGgubWF4KDAsIG9mZnNldCAtIGNvbnRleHRSYWRpdXMpO1xuICAgICAgICBjb25zdCBlbmQgPSBNYXRoLm1pbihmdWxsVGV4dC5sZW5ndGgsIG9mZnNldCArIGNvbnRleHRSYWRpdXMpO1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgdGV4dDogZnVsbFRleHQsXG4gICAgICAgICAgICBwb3NpdGlvbjogcG9zaXRpb24sXG4gICAgICAgICAgICBjb250ZXh0QmVmb3JlOiBmdWxsVGV4dC5zdWJzdHJpbmcoc3RhcnQsIG9mZnNldCksXG4gICAgICAgICAgICBjb250ZXh0QWZ0ZXI6IGZ1bGxUZXh0LnN1YnN0cmluZyhvZmZzZXQsIGVuZClcbiAgICAgICAgfTtcbiAgICB9XG4gICAgLyoqXG4gICAgICogR2V0cyB0aGUgY3VycmVudCBjZWxsIGNvbnRleHRcbiAgICAgKi9cbiAgICBnZXRDdXJyZW50Q2VsbENvbnRleHQoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmxhc3RDZWxsQ29udGV4dDtcbiAgICB9XG4gICAgLyoqXG4gICAgICogRGlzcG9zZXMgYWxsIHJlc291cmNlc1xuICAgICAqL1xuICAgIGRpc3Bvc2UoKSB7XG4gICAgICAgIGlmICh0aGlzLl9pc0Rpc3Bvc2VkKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5faXNEaXNwb3NlZCA9IHRydWU7XG4gICAgICAgIHRoaXMuY2xlYW51cFByZXZpb3VzTGlzdGVuZXJzKCk7XG4gICAgICAgIHRoaXMubm90ZWJvb2tUcmFja2VyLmFjdGl2ZUNlbGxDaGFuZ2VkLmRpc2Nvbm5lY3QodGhpcy5zZXR1cENlbGxMaXN0ZW5lcnMsIHRoaXMpO1xuICAgICAgICB0aGlzLm5vdGVib29rVHJhY2tlci5jdXJyZW50Q2hhbmdlZC5kaXNjb25uZWN0KHRoaXMuaGFuZGxlTm90ZWJvb2tDaGFuZ2UsIHRoaXMpO1xuICAgIH1cbn1cbmV4cG9ydHMuQ2VsbENvbnRleHRUcmFja2VyID0gQ2VsbENvbnRleHRUcmFja2VyO1xuIiwiXCJ1c2Ugc3RyaWN0XCI7XG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHsgdmFsdWU6IHRydWUgfSk7XG5leHBvcnRzLnJlZ2lzdGVyQ29tbWFuZHMgPSByZWdpc3RlckNvbW1hbmRzO1xuY29uc3QgaWNvbnNfMSA9IHJlcXVpcmUoXCIuL2ljb25zXCIpO1xuLyoqXG4gKiBSZWdpc3RlcnMgY29tbWFuZHMgZm9yIHRoZSBleHRlbnNpb25cbiAqL1xuZnVuY3Rpb24gcmVnaXN0ZXJDb21tYW5kcyhhcHAsIHBhbGV0dGUsIGxhdW5jaGVyLCBzaWRlYmFyV2lkZ2V0KSB7XG4gICAgLy8gQWRkIGNvbW1hbmQgdG8gdG9nZ2xlIHRoZSBzaWRlYmFyXG4gICAgYXBwLmNvbW1hbmRzLmFkZENvbW1hbmQoJ3NpbXBsZS1leHRlbnNpb246dG9nZ2xlLXNpZGViYXInLCB7XG4gICAgICAgIGxhYmVsOiAnVG9nZ2xlIEFJIEFzc2lzdGFudCBTaWRlYmFyJyxcbiAgICAgICAgaWNvbjogaWNvbnNfMS5leHRlbnNpb25JY29uLFxuICAgICAgICBleGVjdXRlOiAoKSA9PiB7XG4gICAgICAgICAgICBpZiAoc2lkZWJhcldpZGdldC5pc0F0dGFjaGVkKSB7XG4gICAgICAgICAgICAgICAgc2lkZWJhcldpZGdldC5wYXJlbnQgPSBudWxsO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgYXBwLnNoZWxsLmFkZChzaWRlYmFyV2lkZ2V0LCAnbGVmdCcsIHsgcmFuazogOTk5OSB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH0pO1xuICAgIC8vIEFkZCB0aGUgY29tbWFuZCB0byB0aGUgY29tbWFuZCBwYWxldHRlXG4gICAgcGFsZXR0ZS5hZGRJdGVtKHtcbiAgICAgICAgY29tbWFuZDogJ3NpbXBsZS1leHRlbnNpb246dG9nZ2xlLXNpZGViYXInLFxuICAgICAgICBjYXRlZ29yeTogJ0V4dGVuc2lvbidcbiAgICB9KTtcbiAgICAvLyBBZGQgYSBsYXVuY2hlciBpdGVtXG4gICAgbGF1bmNoZXIuYWRkKHtcbiAgICAgICAgY29tbWFuZDogJ3NpbXBsZS1leHRlbnNpb246dG9nZ2xlLXNpZGViYXInLFxuICAgICAgICBjYXRlZ29yeTogJ090aGVyJyxcbiAgICAgICAgcmFuazogOTk5OVxuICAgIH0pO1xufVxuIiwiXCJ1c2Ugc3RyaWN0XCI7XG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHsgdmFsdWU6IHRydWUgfSk7XG5leHBvcnRzLmdsb2JhbHMgPSB2b2lkIDA7XG5leHBvcnRzLmluaXRHbG9iYWxzID0gaW5pdEdsb2JhbHM7XG4vKipcbiAqIEdsb2JhbCByZWZlcmVuY2VzIHRvIGtleSBjb21wb25lbnRzIGluIHRoZSBhcHBsaWNhdGlvblxuICovXG5leHBvcnRzLmdsb2JhbHMgPSB7fTtcbi8qKlxuICogSW5pdGlhbGl6ZSBnbG9iYWwgcmVmZXJlbmNlc1xuICovXG5mdW5jdGlvbiBpbml0R2xvYmFscyhhcHAsIG5vdGVib29rVHJhY2tlcikge1xuICAgIGV4cG9ydHMuZ2xvYmFscy5hcHAgPSBhcHA7XG4gICAgZXhwb3J0cy5nbG9iYWxzLm5vdGVib29rVHJhY2tlciA9IG5vdGVib29rVHJhY2tlcjtcbn1cbiIsIlwidXNlIHN0cmljdFwiO1xuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xuZXhwb3J0cy5leHRlbnNpb25JY29uID0gdm9pZCAwO1xuY29uc3QgdWlfY29tcG9uZW50c18xID0gcmVxdWlyZShcIkBqdXB5dGVybGFiL3VpLWNvbXBvbmVudHNcIik7XG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4vLyBJY29uIERlZmluaXRpb25cbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbmNvbnN0IGljb25TdmdTdHIgPSAnPHN2ZyB4bWxucz1cImh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnXCIgd2lkdGg9XCIxNlwiIGhlaWdodD1cIjE2XCIgZmlsbD1cImN1cnJlbnRDb2xvclwiIGNsYXNzPVwiYmkgYmktY2hhdC1sZWZ0LXRleHRcIiB2aWV3Qm94PVwiMCAwIDE2IDE2XCI+JyArXG4gICAgJzxwYXRoIGQ9XCJNMTQgMWExIDEgMCAwIDEgMSAxdjhhMSAxIDAgMCAxLTEgMUg0LjQxNEEyIDIgMCAwIDAgMyAxMS41ODZsLTIgMlYyYTEgMSAwIDAgMSAxLTFoMTJ6TTIgMGEyIDIgMCAwIDAtMiAydjEyLjc5M2EuNS41IDAgMCAwIC44NTQuMzUzbDIuODUzLTIuODUzQTEgMSAwIDAgMSA0LjQxNCAxMkgxNGEyIDIgMCAwIDAgMi0yVjJhMiAyIDAgMCAwLTItMkgyelwiLz4nICtcbiAgICAnPHBhdGggZD1cIk0zIDMuNWEuNS41IDAgMCAxIC41LS41aDlhLjUuNSAwIDAgMSAwIDFoLTlhLjUuNSAwIDAgMS0uNS0uNXpNMyA2YS41LjUgMCAwIDEgLjUtLjVoOWEuNS41IDAgMCAxIDAgMWgtOUEuNS41IDAgMCAxIDMgNnptMCAyLjVhLjUuNSAwIDAgMSAuNS0uNWg1YS41LjUgMCAwIDEgMCAxaC01YS41LjUgMCAwIDEtLjUtLjV6XCIvPicgK1xuICAgICc8L3N2Zz4nO1xuLyoqXG4gKiBJY29uIGZvciB0aGUgQUkgQXNzaXN0YW50IGV4dGVuc2lvblxuICovXG5leHBvcnRzLmV4dGVuc2lvbkljb24gPSBuZXcgdWlfY29tcG9uZW50c18xLkxhYkljb24oe1xuICAgIG5hbWU6ICdzaW1wbGU6aWNvbicsXG4gICAgc3Znc3RyOiBpY29uU3ZnU3RyXG59KTtcbiIsIlwidXNlIHN0cmljdFwiO1xuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xuZXhwb3J0cy5BcGlDbGllbnQgPSB2b2lkIDA7XG5jb25zdCBsYXVuY2hlcl8xID0gcmVxdWlyZShcIkBqdXB5dGVybGFiL2xhdW5jaGVyXCIpO1xuY29uc3QgYXBwdXRpbHNfMSA9IHJlcXVpcmUoXCJAanVweXRlcmxhYi9hcHB1dGlsc1wiKTtcbmNvbnN0IG5vdGVib29rXzEgPSByZXF1aXJlKFwiQGp1cHl0ZXJsYWIvbm90ZWJvb2tcIik7XG5jb25zdCBkb2NtYW5hZ2VyXzEgPSByZXF1aXJlKFwiQGp1cHl0ZXJsYWIvZG9jbWFuYWdlclwiKTtcbmNvbnN0IHNpZGViYXJfd2lkZ2V0XzEgPSByZXF1aXJlKFwiLi9zaWRlYmFyLXdpZGdldFwiKTtcbmNvbnN0IGdsb2JhbHNfMSA9IHJlcXVpcmUoXCIuL2dsb2JhbHNcIik7XG5jb25zdCBjb21tYW5kc18xID0gcmVxdWlyZShcIi4vY29tbWFuZHNcIik7XG5jb25zdCBjZWxsX2NvbnRleHRfdHJhY2tlcl8xID0gcmVxdWlyZShcIi4vY2VsbC1jb250ZXh0LXRyYWNrZXJcIik7XG4vLyBpbXBvcnQgeyBBcGlDbGllbnQgfSBmcm9tICcuL2FwaS1jbGllbnQnO1xuLy8gRXhwb3J0IEFwaUNsaWVudCBmb3IgdXNlIGJ5IG90aGVyIGNvbXBvbmVudHNcbnZhciBhcGlfY2xpZW50XzEgPSByZXF1aXJlKFwiLi9hcGktY2xpZW50XCIpO1xuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiQXBpQ2xpZW50XCIsIHsgZW51bWVyYWJsZTogdHJ1ZSwgZ2V0OiBmdW5jdGlvbiAoKSB7IHJldHVybiBhcGlfY2xpZW50XzEuQXBpQ2xpZW50OyB9IH0pO1xuLyoqXG4gKiBJbml0aWFsaXphdGlvbiBkYXRhIGZvciB0aGUganVweXRlci1zaW1wbGUtZXh0ZW5zaW9uIGV4dGVuc2lvbi5cbiAqL1xuY29uc3QgcGx1Z2luID0ge1xuICAgIGlkOiAnanVweXRlci1zaW1wbGUtZXh0ZW5zaW9uOnBsdWdpbicsXG4gICAgYXV0b1N0YXJ0OiB0cnVlLFxuICAgIHJlcXVpcmVzOiBbbGF1bmNoZXJfMS5JTGF1bmNoZXIsIGFwcHV0aWxzXzEuSUNvbW1hbmRQYWxldHRlLCBub3RlYm9va18xLklOb3RlYm9va1RyYWNrZXIsIGRvY21hbmFnZXJfMS5JRG9jdW1lbnRNYW5hZ2VyXSxcbiAgICBhY3RpdmF0ZTogKGp1cHl0ZXJBcHAsIGxhdW5jaGVyLCBwYWxldHRlLCB0cmFja2VyLCBkb2NNYW5hZ2VyKSA9PiB7XG4gICAgICAgIGNvbnNvbGUubG9nKCdKdXB5dGVyTGFiIGV4dGVuc2lvbiBqdXB5dGVyLXNpbXBsZS1leHRlbnNpb24gaXMgYWN0aXZhdGVkIScpO1xuICAgICAgICAvLyBJbml0aWFsaXplIGdsb2JhbCByZWZlcmVuY2VzXG4gICAgICAgICgwLCBnbG9iYWxzXzEuaW5pdEdsb2JhbHMpKGp1cHl0ZXJBcHAsIHRyYWNrZXIpO1xuICAgICAgICAvLyBJbml0aWFsaXplIGNlbGwgY29udGV4dCB0cmFja2VyXG4gICAgICAgIGdsb2JhbHNfMS5nbG9iYWxzLmNlbGxDb250ZXh0VHJhY2tlciA9IG5ldyBjZWxsX2NvbnRleHRfdHJhY2tlcl8xLkNlbGxDb250ZXh0VHJhY2tlcihqdXB5dGVyQXBwLCB0cmFja2VyKTtcbiAgICAgICAgLy8gQ3JlYXRlIGFuZCBhZGQgc2lkZWJhciB3aWRnZXRcbiAgICAgICAgY29uc3Qgc2lkZWJhcldpZGdldCA9IG5ldyBzaWRlYmFyX3dpZGdldF8xLlNpbXBsZVNpZGViYXJXaWRnZXQoZG9jTWFuYWdlcik7XG4gICAgICAgIGp1cHl0ZXJBcHAuc2hlbGwuYWRkKHNpZGViYXJXaWRnZXQsICdsZWZ0JywgeyByYW5rOiA5OTk5IH0pO1xuICAgICAgICAvLyBSZWdpc3RlciBjb21tYW5kc1xuICAgICAgICAoMCwgY29tbWFuZHNfMS5yZWdpc3RlckNvbW1hbmRzKShqdXB5dGVyQXBwLCBwYWxldHRlLCBsYXVuY2hlciwgc2lkZWJhcldpZGdldCk7XG4gICAgfVxufTtcbmV4cG9ydHMuZGVmYXVsdCA9IHBsdWdpbjtcbiIsIlwidXNlIHN0cmljdFwiO1xuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xuZXhwb3J0cy5jb25maWd1cmVNYXJrZWQgPSBjb25maWd1cmVNYXJrZWQ7XG5leHBvcnRzLnByZXByb2Nlc3NNYXJrZG93biA9IHByZXByb2Nlc3NNYXJrZG93bjtcbmNvbnN0IG1hcmtlZF8xID0gcmVxdWlyZShcIm1hcmtlZFwiKTtcbi8qKlxuICogQ29uZmlndXJlIG1hcmtlZCB3aXRoIGJldHRlciByZW5kZXJpbmcgb3B0aW9ucyBmb3IgY29kZSBibG9ja3NcbiAqL1xuZnVuY3Rpb24gY29uZmlndXJlTWFya2VkKCkge1xuICAgIC8vIENvbmZpZ3VyZSBtYXJrZWQgb3B0aW9uc1xuICAgIG1hcmtlZF8xLm1hcmtlZC5zZXRPcHRpb25zKHtcbiAgICAgICAgZ2ZtOiB0cnVlLCAvLyBFbmFibGUgR2l0SHViIEZsYXZvcmVkIE1hcmtkb3duXG4gICAgICAgIGJyZWFrczogdHJ1ZSwgLy8gQWRkIDxicj4gb24gc2luZ2xlIGxpbmUgYnJlYWtzXG4gICAgICAgIHBlZGFudGljOiBmYWxzZSwgLy8gQ29uZm9ybSB0byBvcmlnaW5hbCBtYXJrZG93biBzcGVjXG4gICAgICAgIGFzeW5jOiBmYWxzZSwgLy8gRGlzYWJsZSBhc3luYyByZW5kZXJpbmdcbiAgICAgICAgc2lsZW50OiBmYWxzZSAvLyBFbmFibGUgZXJyb3IgcmVwb3J0aW5nXG4gICAgfSk7XG59XG4vKipcbiAqIFByZS1wcm9jZXNzIG1hcmtkb3duIHRleHQgdG8gZml4IGNvbW1vbiBpc3N1ZXMgd2l0aCBzdHJlYW1pbmcgY29udGVudFxuICovXG5mdW5jdGlvbiBwcmVwcm9jZXNzTWFya2Rvd24odGV4dCkge1xuICAgIC8vIEhhbmRsZSBjb2RlIGJsb2NrcyBmaXJzdFxuICAgIGxldCBpbkNvZGVCbG9jayA9IGZhbHNlO1xuICAgIGNvbnN0IGxpbmVzID0gdGV4dC5zcGxpdCgnXFxuJyk7XG4gICAgY29uc3QgcHJvY2Vzc2VkTGluZXMgPSBsaW5lcy5tYXAoKGxpbmUsIGkpID0+IHtcbiAgICAgICAgLy8gQ2hlY2sgZm9yIGNvZGUgYmxvY2sgbWFya2Vyc1xuICAgICAgICBpZiAobGluZS50cmltKCkuc3RhcnRzV2l0aCgnYGBgJykpIHtcbiAgICAgICAgICAgIGluQ29kZUJsb2NrID0gIWluQ29kZUJsb2NrO1xuICAgICAgICAgICAgLy8gUHJlc2VydmUgbGFuZ3VhZ2Ugc3BlY2lmaWNhdGlvblxuICAgICAgICAgICAgcmV0dXJuIGxpbmUudHJpbSgpO1xuICAgICAgICB9XG4gICAgICAgIC8vIElmIHdlJ3JlIGluIGEgY29kZSBibG9jaywgcHJlc2VydmUgdGhlIGxpbmUgYXMgaXNcbiAgICAgICAgaWYgKGluQ29kZUJsb2NrKSB7XG4gICAgICAgICAgICByZXR1cm4gbGluZTtcbiAgICAgICAgfVxuICAgICAgICAvLyBPdXRzaWRlIGNvZGUgYmxvY2tzLCBoYW5kbGUgbGlzdCBpdGVtc1xuICAgICAgICByZXR1cm4gbGluZS5yZXBsYWNlKC8oW15cXG5cXHNdKS1cXHMvZywgJyQxXFxuLSAnKTtcbiAgICB9KTtcbiAgICByZXR1cm4gcHJvY2Vzc2VkTGluZXMuam9pbignXFxuJyk7XG59XG4iLCJcInVzZSBzdHJpY3RcIjtcbnZhciBfX2ltcG9ydERlZmF1bHQgPSAodGhpcyAmJiB0aGlzLl9faW1wb3J0RGVmYXVsdCkgfHwgZnVuY3Rpb24gKG1vZCkge1xuICAgIHJldHVybiAobW9kICYmIG1vZC5fX2VzTW9kdWxlKSA/IG1vZCA6IHsgXCJkZWZhdWx0XCI6IG1vZCB9O1xufTtcbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcIl9fZXNNb2R1bGVcIiwgeyB2YWx1ZTogdHJ1ZSB9KTtcbmV4cG9ydHMuU2ltcGxlU2lkZWJhcldpZGdldCA9IHZvaWQgMDtcbmNvbnN0IHdpZGdldHNfMSA9IHJlcXVpcmUoXCJAbHVtaW5vL3dpZGdldHNcIik7XG5jb25zdCBub3RlYm9va18xID0gcmVxdWlyZShcIkBqdXB5dGVybGFiL25vdGVib29rXCIpO1xuY29uc3QgbWFya2VkXzEgPSByZXF1aXJlKFwibWFya2VkXCIpO1xuY29uc3QgZG9tcHVyaWZ5XzEgPSBfX2ltcG9ydERlZmF1bHQocmVxdWlyZShcImRvbXB1cmlmeVwiKSk7XG5jb25zdCBpY29uc18xID0gcmVxdWlyZShcIi4vaWNvbnNcIik7XG5jb25zdCBnbG9iYWxzXzEgPSByZXF1aXJlKFwiLi9nbG9iYWxzXCIpO1xuY29uc3QgYXBpX2NsaWVudF8xID0gcmVxdWlyZShcIi4vYXBpLWNsaWVudFwiKTtcbmNvbnN0IG1hcmtkb3duX2NvbmZpZ18xID0gcmVxdWlyZShcIi4vbWFya2Rvd24tY29uZmlnXCIpO1xuLy8gaW1wb3J0IHsgSUNlbGxDb250ZXh0IH0gZnJvbSAnLi90eXBlcyc7XG4vLyBpbXBvcnQgeyBJQ2VsbENvbnRleHQgfSBmcm9tICcuL3R5cGVzJztcbi8vIENvbmZpZ3VyZSBtYXJrZWQgd2l0aCBvdXIgc2V0dGluZ3NcbigwLCBtYXJrZG93bl9jb25maWdfMS5jb25maWd1cmVNYXJrZWQpKCk7XG4vKipcbiAqIE1haW4gc2lkZWJhciB3aWRnZXQgZm9yIHRoZSBBSSBjaGF0IGludGVyZmFjZVxuICovXG5jbGFzcyBTaW1wbGVTaWRlYmFyV2lkZ2V0IGV4dGVuZHMgd2lkZ2V0c18xLldpZGdldCB7XG4gICAgY29uc3RydWN0b3IoZG9jTWFuYWdlcikge1xuICAgICAgICBzdXBlcigpO1xuICAgICAgICB0aGlzLmlzTWFya2Rvd25Nb2RlID0gZmFsc2U7XG4gICAgICAgIHRoaXMuaXNJbnB1dEV4cGFuZGVkID0gZmFsc2U7XG4gICAgICAgIHRoaXMuY2hhdEhpc3RvcnkgPSBbXTtcbiAgICAgICAgdGhpcy5jdXJyZW50Q2hhdElkID0gJyc7XG4gICAgICAgIHRoaXMuaXNIaXN0b3J5Vmlld0FjdGl2ZSA9IGZhbHNlO1xuICAgICAgICAvKipcbiAgICAgICAgICogSGFuZGxlcyBrZXlib2FyZCBzaG9ydGN1dHNcbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuaGFuZGxlS2V5RG93biA9IChldmVudCkgPT4ge1xuICAgICAgICAgICAgdmFyIF9hLCBfYjtcbiAgICAgICAgICAgIC8vIENoZWNrIGZvciBDdHJsK0wgKGZvciBzZWxlY3RlZCBjb2RlKVxuICAgICAgICAgICAgaWYgKGV2ZW50LmN0cmxLZXkgJiYgZXZlbnQua2V5LnRvTG93ZXJDYXNlKCkgPT09ICdsJykge1xuICAgICAgICAgICAgICAgIC8vIFByZXZlbnQgZGVmYXVsdCBicm93c2VyIGJlaGF2aW9yXG4gICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgICAgICAgICAvLyBHZXQgdGhlIGN1cnJlbnQgYWN0aXZlIGNlbGxcbiAgICAgICAgICAgICAgICBjb25zdCBjZWxsID0gKF9hID0gZ2xvYmFsc18xLmdsb2JhbHMubm90ZWJvb2tUcmFja2VyKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuYWN0aXZlQ2VsbDtcbiAgICAgICAgICAgICAgICBpZiAoIWNlbGwgfHwgIWNlbGwuZWRpdG9yKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgLy8gR2V0IHRoZSBDb2RlTWlycm9yIGVkaXRvciBpbnN0YW5jZVxuICAgICAgICAgICAgICAgICAgICBjb25zdCBlZGl0b3IgPSBjZWxsLmVkaXRvcjtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdmlldyA9IGVkaXRvci5lZGl0b3I7XG4gICAgICAgICAgICAgICAgICAgIGlmICghdmlldykge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIC8vIENoZWNrIGlmIHRoZXJlJ3MgYSBzZWxlY3Rpb25cbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3RhdGUgPSB2aWV3LnN0YXRlO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBzZWxlY3Rpb24gPSBzdGF0ZS5zZWxlY3Rpb247XG4gICAgICAgICAgICAgICAgICAgIGlmICghc2VsZWN0aW9uLm1haW4uZW1wdHkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIElmIHRoZXJlJ3MgYSBzZWxlY3Rpb24sIHVzZSBAY29kZVxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZnJvbSA9IHNlbGVjdGlvbi5tYWluLmZyb207XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0byA9IHNlbGVjdGlvbi5tYWluLnRvO1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2VsZWN0ZWRUZXh0ID0gc3RhdGUuZG9jLnNsaWNlU3RyaW5nKGZyb20sIHRvKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYXBwZW5kVG9JbnB1dChgQGNvZGVcXG4ke3NlbGVjdGVkVGV4dH1gKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0tleWJvYXJkU2hvcnRjdXRJbmRpY2F0b3IoJ1NlbGVjdGVkIGNvZGUgaW5zZXJ0ZWQnKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIElmIG5vIHNlbGVjdGlvbiwgdXNlIEBjZWxsXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjZWxsQ29udGV4dCA9IChfYiA9IGdsb2JhbHNfMS5nbG9iYWxzLmNlbGxDb250ZXh0VHJhY2tlcikgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iLmdldEN1cnJlbnRDZWxsQ29udGV4dCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNlbGxDb250ZXh0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hcHBlbmRUb0lucHV0KGBAY2VsbFxcbiR7Y2VsbENvbnRleHQudGV4dH1gKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dLZXlib2FyZFNob3J0Y3V0SW5kaWNhdG9yKCdDZWxsIGNvbnRlbnQgaW5zZXJ0ZWQnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAvLyBFbnN1cmUgdGhlIHNpZGViYXIgaXMgdmlzaWJsZSBhbmQgZm9jdXNlZFxuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5pc0hpZGRlbikge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93KCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnB1dEZpZWxkLmZvY3VzKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCdFcnJvciBoYW5kbGluZyBrZXlib2FyZCBzaG9ydGN1dDonLCBlcnJvcik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICAvKipcbiAgICAgICAgICogSGFuZGxlcyBjbGlja3Mgb3V0c2lkZSB0aGUgY29tbWFuZCBtZW51XG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLmhhbmRsZUNsaWNrT3V0c2lkZSA9IChldmVudCkgPT4ge1xuICAgICAgICAgICAgaWYgKCF0aGlzLmNvbW1hbmRNZW51Q29udGFpbmVyLmNvbnRhaW5zKGV2ZW50LnRhcmdldCkpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmhpZGVDb21tYW5kTWVudSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICB0aGlzLmRvY01hbmFnZXIgPSBkb2NNYW5hZ2VyO1xuICAgICAgICB0aGlzLmlkID0gJ3NpbXBsZS1zaWRlYmFyJztcbiAgICAgICAgdGhpcy50aXRsZS5sYWJlbCA9ICcnO1xuICAgICAgICB0aGlzLnRpdGxlLmNhcHRpb24gPSAnQUkgQ2hhdCBJbnRlcmZhY2UnO1xuICAgICAgICB0aGlzLnRpdGxlLmljb24gPSBpY29uc18xLmV4dGVuc2lvbkljb247XG4gICAgICAgIHRoaXMudGl0bGUuY2xvc2FibGUgPSB0cnVlO1xuICAgICAgICAvLyBJbml0aWFsaXplIEFQSSBjbGllbnRcbiAgICAgICAgdGhpcy5hcGlDbGllbnQgPSBuZXcgYXBpX2NsaWVudF8xLkFwaUNsaWVudCgpO1xuICAgICAgICAvLyBJbml0aWFsaXplIGNvbnRhaW5lciBlbGVtZW50cyBiZWZvcmUgY3JlYXRpbmcgbGF5b3V0XG4gICAgICAgIHRoaXMubWVzc2FnZUNvbnRhaW5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xuICAgICAgICB0aGlzLmlucHV0Q29udGFpbmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XG4gICAgICAgIHRoaXMuaW5wdXRGaWVsZCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RleHRhcmVhJyk7XG4gICAgICAgIHRoaXMudGl0bGVJbnB1dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2lucHV0Jyk7XG4gICAgICAgIHRoaXMuaGlzdG9yeUNvbnRhaW5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xuICAgICAgICB0aGlzLmNvbW1hbmRNZW51Q29udGFpbmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XG4gICAgICAgIHRoaXMuY29tbWFuZE1lbnVDb250YWluZXIuY2xhc3NOYW1lID0gJ2NvbW1hbmQtbWVudS1jb250YWluZXInO1xuICAgICAgICB0aGlzLmNvbW1hbmRNZW51Q29udGFpbmVyLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7XG4gICAgICAgIC8vIENyZWF0ZSBrZXlib2FyZCBzaG9ydGN1dCBpbmRpY2F0b3JcbiAgICAgICAgdGhpcy5rZXlib2FyZFNob3J0Y3V0SW5kaWNhdG9yID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XG4gICAgICAgIHRoaXMua2V5Ym9hcmRTaG9ydGN1dEluZGljYXRvci5jbGFzc05hbWUgPSAna2V5Ym9hcmQtc2hvcnRjdXQtaW5kaWNhdG9yJztcbiAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZCh0aGlzLmtleWJvYXJkU2hvcnRjdXRJbmRpY2F0b3IpO1xuICAgICAgICAvLyBDcmVhdGUgYSBuZXcgY2hhdCBvbiBzdGFydFxuICAgICAgICB0aGlzLmNyZWF0ZU5ld0NoYXQoKTtcbiAgICAgICAgdGhpcy5ub2RlLmFwcGVuZENoaWxkKHRoaXMuY3JlYXRlTGF5b3V0KCkpO1xuICAgICAgICB0aGlzLm5vZGUuYXBwZW5kQ2hpbGQodGhpcy5jb21tYW5kTWVudUNvbnRhaW5lcik7XG4gICAgICAgIC8vIEFkZCBrZXlib2FyZCBzaG9ydGN1dCBsaXN0ZW5lclxuICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdrZXlkb3duJywgdGhpcy5oYW5kbGVLZXlEb3duKTtcbiAgICB9XG4gICAgLyoqXG4gICAgICogU2hvd3MgYSB2aXN1YWwgaW5kaWNhdG9yIGZvciBrZXlib2FyZCBzaG9ydGN1dHNcbiAgICAgKi9cbiAgICBzaG93S2V5Ym9hcmRTaG9ydGN1dEluZGljYXRvcih0ZXh0KSB7XG4gICAgICAgIHRoaXMua2V5Ym9hcmRTaG9ydGN1dEluZGljYXRvci50ZXh0Q29udGVudCA9IHRleHQ7XG4gICAgICAgIHRoaXMua2V5Ym9hcmRTaG9ydGN1dEluZGljYXRvci5jbGFzc0xpc3QuYWRkKCd2aXNpYmxlJyk7XG4gICAgICAgIC8vIEhpZGUgYWZ0ZXIgMSBzZWNvbmRcbiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmtleWJvYXJkU2hvcnRjdXRJbmRpY2F0b3IuY2xhc3NMaXN0LnJlbW92ZSgndmlzaWJsZScpO1xuICAgICAgICB9LCAxMDAwKTtcbiAgICB9XG4gICAgLyoqXG4gICAgICogRGlzcG9zZXMgYWxsIHJlc291cmNlc1xuICAgICAqL1xuICAgIGRpc3Bvc2UoKSB7XG4gICAgICAgIC8vIFJlbW92ZSBrZXlib2FyZCBzaG9ydGN1dCBsaXN0ZW5lclxuICAgICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdrZXlkb3duJywgdGhpcy5oYW5kbGVLZXlEb3duKTtcbiAgICAgICAgLy8gUmVtb3ZlIGtleWJvYXJkIHNob3J0Y3V0IGluZGljYXRvclxuICAgICAgICBpZiAodGhpcy5rZXlib2FyZFNob3J0Y3V0SW5kaWNhdG9yLnBhcmVudE5vZGUpIHtcbiAgICAgICAgICAgIHRoaXMua2V5Ym9hcmRTaG9ydGN1dEluZGljYXRvci5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHRoaXMua2V5Ym9hcmRTaG9ydGN1dEluZGljYXRvcik7XG4gICAgICAgIH1cbiAgICAgICAgc3VwZXIuZGlzcG9zZSgpO1xuICAgIH1cbiAgICAvKipcbiAgICAgKiBDcmVhdGVzIHRoZSBtYWluIGxheW91dCBmb3IgdGhlIHNpZGViYXJcbiAgICAgKi9cbiAgICBjcmVhdGVMYXlvdXQoKSB7XG4gICAgICAgIC8vIENyZWF0ZSB0aGUgbWFpbiBjb250YWluZXJcbiAgICAgICAgY29uc3QgY29udGVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xuICAgICAgICBjb250ZW50LmNsYXNzTmFtZSA9ICdzaW1wbGUtc2lkZWJhci1jb250ZW50JztcbiAgICAgICAgLy8gQ3JlYXRlIHRpdGxlIGlucHV0IGNvbnRhaW5lclxuICAgICAgICBjb25zdCB0aXRsZUNvbnRhaW5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xuICAgICAgICB0aXRsZUNvbnRhaW5lci5jbGFzc05hbWUgPSAndGl0bGUtY29udGFpbmVyJztcbiAgICAgICAgLy8gU2V0IHVwIHRpdGxlIGlucHV0XG4gICAgICAgIHRoaXMudGl0bGVJbnB1dC5jbGFzc05hbWUgPSAnY2hhdC10aXRsZS1pbnB1dCc7XG4gICAgICAgIHRoaXMudGl0bGVJbnB1dC50eXBlID0gJ3RleHQnO1xuICAgICAgICB0aGlzLnRpdGxlSW5wdXQucGxhY2Vob2xkZXIgPSAnQ2hhdCB0aXRsZSc7XG4gICAgICAgIHRoaXMudGl0bGVJbnB1dC52YWx1ZSA9ICdOZXcgQ2hhdCc7XG4gICAgICAgIHRoaXMudGl0bGVJbnB1dC5hZGRFdmVudExpc3RlbmVyKCdjaGFuZ2UnLCAoKSA9PiB0aGlzLnVwZGF0ZUN1cnJlbnRDaGF0VGl0bGUoKSk7XG4gICAgICAgIHRpdGxlQ29udGFpbmVyLmFwcGVuZENoaWxkKHRoaXMudGl0bGVJbnB1dCk7XG4gICAgICAgIC8vIENvbmZpZ3VyZSB0b3AgYWN0aW9uIGJ1dHRvbnMgKE5ldyBDaGF0ICYgSGlzdG9yeSlcbiAgICAgICAgY29uc3QgdG9wQWN0aW9uc0NvbnRhaW5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xuICAgICAgICB0b3BBY3Rpb25zQ29udGFpbmVyLmNsYXNzTmFtZSA9ICd0b3AtYWN0aW9ucy1jb250YWluZXInO1xuICAgICAgICBjb25zdCBuZXdDaGF0QnV0dG9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYnV0dG9uJyk7XG4gICAgICAgIG5ld0NoYXRCdXR0b24uY2xhc3NOYW1lID0gJ2pwLUJ1dHRvbiBhY3Rpb24tYnV0dG9uJztcbiAgICAgICAgbmV3Q2hhdEJ1dHRvbi50ZXh0Q29udGVudCA9ICcrIE5ldyBDaGF0JztcbiAgICAgICAgbmV3Q2hhdEJ1dHRvbi50aXRsZSA9ICdTdGFydCBhIG5ldyBjaGF0JztcbiAgICAgICAgbmV3Q2hhdEJ1dHRvbi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHRoaXMuY3JlYXRlTmV3Q2hhdCgpKTtcbiAgICAgICAgY29uc3QgaGlzdG9yeUJ1dHRvbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2J1dHRvbicpO1xuICAgICAgICBoaXN0b3J5QnV0dG9uLmNsYXNzTmFtZSA9ICdqcC1CdXR0b24gYWN0aW9uLWJ1dHRvbic7XG4gICAgICAgIGhpc3RvcnlCdXR0b24udGV4dENvbnRlbnQgPSAnSGlzdG9yeSc7XG4gICAgICAgIGhpc3RvcnlCdXR0b24udGl0bGUgPSAnVmlldyBjaGF0IGhpc3RvcnknO1xuICAgICAgICBoaXN0b3J5QnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4gdGhpcy50b2dnbGVIaXN0b3J5VmlldygpKTtcbiAgICAgICAgdG9wQWN0aW9uc0NvbnRhaW5lci5hcHBlbmRDaGlsZChuZXdDaGF0QnV0dG9uKTtcbiAgICAgICAgdG9wQWN0aW9uc0NvbnRhaW5lci5hcHBlbmRDaGlsZChoaXN0b3J5QnV0dG9uKTtcbiAgICAgICAgLy8gQ29uZmlndXJlIG1lc3NhZ2UgY29udGFpbmVyXG4gICAgICAgIHRoaXMubWVzc2FnZUNvbnRhaW5lci5jbGFzc05hbWUgPSAnbWVzc2FnZS1jb250YWluZXInO1xuICAgICAgICAvLyBDb25maWd1cmUgaGlzdG9yeSBjb250YWluZXJcbiAgICAgICAgdGhpcy5oaXN0b3J5Q29udGFpbmVyLmNsYXNzTmFtZSA9ICdoaXN0b3J5LWNvbnRhaW5lcic7XG4gICAgICAgIHRoaXMuaGlzdG9yeUNvbnRhaW5lci5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOyAvLyBJbml0aWFsbHkgaGlkZGVuXG4gICAgICAgIC8vIENvbmZpZ3VyZSBpbnB1dCBjb250YWluZXJcbiAgICAgICAgdGhpcy5pbnB1dENvbnRhaW5lci5jbGFzc05hbWUgPSAnaW5wdXQtY29udGFpbmVyJztcbiAgICAgICAgLy8gQ3JlYXRlIGNvbnRyb2xzIGNvbnRhaW5lclxuICAgICAgICBjb25zdCBjb250cm9sc0NvbnRhaW5lciA9IHRoaXMuY3JlYXRlQ29udHJvbHNDb250YWluZXIoKTtcbiAgICAgICAgLy8gQ29uZmlndXJlIGlucHV0IGZpZWxkXG4gICAgICAgIHRoaXMuaW5wdXRGaWVsZC5wbGFjZWhvbGRlciA9ICdBc2sgbWUgYW55dGhpbmcuLi4nO1xuICAgICAgICB0aGlzLmlucHV0RmllbGQuc3R5bGUuZmxleEdyb3cgPSAnMSc7XG4gICAgICAgIHRoaXMuaW5wdXRGaWVsZC5zdHlsZS5wYWRkaW5nID0gJzVweCc7XG4gICAgICAgIHRoaXMuaW5wdXRGaWVsZC5zdHlsZS5ib3JkZXIgPSAnMXB4IHNvbGlkICNjY2MnO1xuICAgICAgICB0aGlzLmlucHV0RmllbGQuc3R5bGUuYm9yZGVyUmFkaXVzID0gJzNweCc7XG4gICAgICAgIHRoaXMuaW5wdXRGaWVsZC5zdHlsZS5yZXNpemUgPSAnbm9uZSc7XG4gICAgICAgIHRoaXMuaW5wdXRGaWVsZC5yb3dzID0gMTtcbiAgICAgICAgdGhpcy5pbnB1dEZpZWxkLnN0eWxlLm92ZXJmbG93WSA9ICdhdXRvJztcbiAgICAgICAgLy8gQWRkIGtleXByZXNzIGxpc3RlbmVyIHRvIGlucHV0IGZpZWxkXG4gICAgICAgIHRoaXMuaW5wdXRGaWVsZC5hZGRFdmVudExpc3RlbmVyKCdrZXlwcmVzcycsIChldmVudCkgPT4ge1xuICAgICAgICAgICAgaWYgKGV2ZW50LmtleSA9PT0gJ0VudGVyJyAmJiAhZXZlbnQuc2hpZnRLZXkpIHtcbiAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlU2VuZE1lc3NhZ2UoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIC8vIENyZWF0ZSBzZW5kIGJ1dHRvbiBjb250YWluZXJcbiAgICAgICAgY29uc3QgaW5wdXRBY3Rpb25zQ29udGFpbmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XG4gICAgICAgIGlucHV0QWN0aW9uc0NvbnRhaW5lci5jbGFzc05hbWUgPSAnaW5wdXQtYWN0aW9ucy1jb250YWluZXInO1xuICAgICAgICAvLyBDcmVhdGUgc2VuZCBidXR0b25cbiAgICAgICAgY29uc3Qgc2VuZEJ1dHRvbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2J1dHRvbicpO1xuICAgICAgICBzZW5kQnV0dG9uLmNsYXNzTmFtZSA9ICdqcC1CdXR0b24gc2VuZC1idXR0b24nO1xuICAgICAgICBzZW5kQnV0dG9uLnRleHRDb250ZW50ID0gJ1NlbmQnO1xuICAgICAgICBzZW5kQnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4gdGhpcy5oYW5kbGVTZW5kTWVzc2FnZSgpKTtcbiAgICAgICAgLy8gQWRkIGJ1dHRvbiB0byBhY3Rpb25zIGNvbnRhaW5lclxuICAgICAgICBpbnB1dEFjdGlvbnNDb250YWluZXIuYXBwZW5kQ2hpbGQoc2VuZEJ1dHRvbik7XG4gICAgICAgIC8vIEFzc2VtYmxlIHRoZSBpbnB1dCBjb21wb25lbnRzXG4gICAgICAgIHRoaXMuaW5wdXRDb250YWluZXIuYXBwZW5kQ2hpbGQoY29udHJvbHNDb250YWluZXIpO1xuICAgICAgICB0aGlzLmlucHV0Q29udGFpbmVyLmFwcGVuZENoaWxkKHRoaXMuaW5wdXRGaWVsZCk7XG4gICAgICAgIHRoaXMuaW5wdXRDb250YWluZXIuYXBwZW5kQ2hpbGQoaW5wdXRBY3Rpb25zQ29udGFpbmVyKTtcbiAgICAgICAgLy8gQXNzZW1ibGUgYWxsIGNvbXBvbmVudHNcbiAgICAgICAgY29udGVudC5hcHBlbmRDaGlsZCh0b3BBY3Rpb25zQ29udGFpbmVyKTtcbiAgICAgICAgY29udGVudC5hcHBlbmRDaGlsZCh0aXRsZUNvbnRhaW5lcik7XG4gICAgICAgIGNvbnRlbnQuYXBwZW5kQ2hpbGQodGhpcy5tZXNzYWdlQ29udGFpbmVyKTtcbiAgICAgICAgY29udGVudC5hcHBlbmRDaGlsZCh0aGlzLmhpc3RvcnlDb250YWluZXIpO1xuICAgICAgICBjb250ZW50LmFwcGVuZENoaWxkKHRoaXMuaW5wdXRDb250YWluZXIpO1xuICAgICAgICByZXR1cm4gY29udGVudDtcbiAgICB9XG4gICAgLyoqXG4gICAgICogQ3JlYXRlcyBhIG5ldyBjaGF0IHNlc3Npb25cbiAgICAgKi9cbiAgICBjcmVhdGVOZXdDaGF0KCkge1xuICAgICAgICAvLyBHZW5lcmF0ZSBhIHVuaXF1ZSBJRCBmb3IgdGhlIGNoYXRcbiAgICAgICAgY29uc3QgY2hhdElkID0gYGNoYXQtJHtEYXRlLm5vdygpfWA7XG4gICAgICAgIC8vIENyZWF0ZSBhIG5ldyBjaGF0IGl0ZW1cbiAgICAgICAgY29uc3QgbmV3Q2hhdCA9IHtcbiAgICAgICAgICAgIGlkOiBjaGF0SWQsXG4gICAgICAgICAgICB0aXRsZTogJ05ldyBDaGF0JyxcbiAgICAgICAgICAgIG1lc3NhZ2VzOiBbXVxuICAgICAgICB9O1xuICAgICAgICAvLyBBZGQgdG8gaGlzdG9yeVxuICAgICAgICB0aGlzLmNoYXRIaXN0b3J5LnB1c2gobmV3Q2hhdCk7XG4gICAgICAgIC8vIFNldCBhcyBjdXJyZW50IGNoYXRcbiAgICAgICAgdGhpcy5jdXJyZW50Q2hhdElkID0gY2hhdElkO1xuICAgICAgICAvLyBVcGRhdGUgdGl0bGUgaW5wdXRcbiAgICAgICAgdGhpcy50aXRsZUlucHV0LnZhbHVlID0gbmV3Q2hhdC50aXRsZTtcbiAgICAgICAgLy8gQ2xlYXIgbWVzc2FnZSBjb250YWluZXJcbiAgICAgICAgaWYgKHRoaXMubWVzc2FnZUNvbnRhaW5lcikge1xuICAgICAgICAgICAgdGhpcy5tZXNzYWdlQ29udGFpbmVyLmlubmVySFRNTCA9ICcnO1xuICAgICAgICB9XG4gICAgICAgIC8vIEhpZGUgaGlzdG9yeSBpZiBpdCdzIHZpc2libGVcbiAgICAgICAgaWYgKHRoaXMuaXNIaXN0b3J5Vmlld0FjdGl2ZSkge1xuICAgICAgICAgICAgdGhpcy50b2dnbGVIaXN0b3J5VmlldygpO1xuICAgICAgICB9XG4gICAgfVxuICAgIC8qKlxuICAgICAqIFRvZ2dsZXMgYmV0d2VlbiBjaGF0IHZpZXcgYW5kIGhpc3Rvcnkgdmlld1xuICAgICAqL1xuICAgIHRvZ2dsZUhpc3RvcnlWaWV3KCkge1xuICAgICAgICB0aGlzLmlzSGlzdG9yeVZpZXdBY3RpdmUgPSAhdGhpcy5pc0hpc3RvcnlWaWV3QWN0aXZlO1xuICAgICAgICBpZiAodGhpcy5pc0hpc3RvcnlWaWV3QWN0aXZlKSB7XG4gICAgICAgICAgICAvLyBTaG93IGhpc3RvcnkgdmlldywgaGlkZSBtZXNzYWdlIHZpZXdcbiAgICAgICAgICAgIHRoaXMubWVzc2FnZUNvbnRhaW5lci5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnO1xuICAgICAgICAgICAgdGhpcy5oaXN0b3J5Q29udGFpbmVyLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snO1xuICAgICAgICAgICAgdGhpcy5pbnB1dENvbnRhaW5lci5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnO1xuICAgICAgICAgICAgdGhpcy50aXRsZUlucHV0LnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7XG4gICAgICAgICAgICAvLyBQb3B1bGF0ZSBoaXN0b3J5XG4gICAgICAgICAgICB0aGlzLnJlbmRlckNoYXRIaXN0b3J5KCk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAvLyBTaG93IG1lc3NhZ2UgdmlldywgaGlkZSBoaXN0b3J5IHZpZXdcbiAgICAgICAgICAgIHRoaXMubWVzc2FnZUNvbnRhaW5lci5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJztcbiAgICAgICAgICAgIHRoaXMuaGlzdG9yeUNvbnRhaW5lci5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnO1xuICAgICAgICAgICAgdGhpcy5pbnB1dENvbnRhaW5lci5zdHlsZS5kaXNwbGF5ID0gJ2ZsZXgnO1xuICAgICAgICAgICAgdGhpcy50aXRsZUlucHV0LnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snO1xuICAgICAgICB9XG4gICAgfVxuICAgIC8qKlxuICAgICAqIFJlbmRlcnMgdGhlIGNoYXQgaGlzdG9yeSBpbiB0aGUgaGlzdG9yeSBjb250YWluZXJcbiAgICAgKi9cbiAgICByZW5kZXJDaGF0SGlzdG9yeSgpIHtcbiAgICAgICAgdGhpcy5oaXN0b3J5Q29udGFpbmVyLmlubmVySFRNTCA9ICcnO1xuICAgICAgICBpZiAodGhpcy5jaGF0SGlzdG9yeS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIGNvbnN0IGVtcHR5TWVzc2FnZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xuICAgICAgICAgICAgZW1wdHlNZXNzYWdlLmNsYXNzTmFtZSA9ICdlbXB0eS1oaXN0b3J5LW1lc3NhZ2UnO1xuICAgICAgICAgICAgZW1wdHlNZXNzYWdlLnRleHRDb250ZW50ID0gJ05vIGNoYXQgaGlzdG9yeSB5ZXQnO1xuICAgICAgICAgICAgdGhpcy5oaXN0b3J5Q29udGFpbmVyLmFwcGVuZENoaWxkKGVtcHR5TWVzc2FnZSk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgLy8gQ3JlYXRlIGEgbGlzdCBvZiBjaGF0IGhpc3RvcnkgaXRlbXNcbiAgICAgICAgdGhpcy5jaGF0SGlzdG9yeS5mb3JFYWNoKGNoYXQgPT4ge1xuICAgICAgICAgICAgY29uc3QgaGlzdG9yeUl0ZW0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcbiAgICAgICAgICAgIGhpc3RvcnlJdGVtLmNsYXNzTmFtZSA9ICdoaXN0b3J5LWl0ZW0nO1xuICAgICAgICAgICAgaWYgKGNoYXQuaWQgPT09IHRoaXMuY3VycmVudENoYXRJZCkge1xuICAgICAgICAgICAgICAgIGhpc3RvcnlJdGVtLmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gQWRkIHRpdGxlXG4gICAgICAgICAgICBjb25zdCB0aXRsZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xuICAgICAgICAgICAgdGl0bGUuY2xhc3NOYW1lID0gJ2hpc3RvcnktdGl0bGUnO1xuICAgICAgICAgICAgdGl0bGUudGV4dENvbnRlbnQgPSBjaGF0LnRpdGxlO1xuICAgICAgICAgICAgLy8gQWRkIG1lc3NhZ2UgcHJldmlld1xuICAgICAgICAgICAgY29uc3QgcHJldmlldyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xuICAgICAgICAgICAgcHJldmlldy5jbGFzc05hbWUgPSAnaGlzdG9yeS1wcmV2aWV3JztcbiAgICAgICAgICAgIGNvbnN0IGxhc3RNZXNzYWdlID0gY2hhdC5tZXNzYWdlc1tjaGF0Lm1lc3NhZ2VzLmxlbmd0aCAtIDFdO1xuICAgICAgICAgICAgcHJldmlldy50ZXh0Q29udGVudCA9IGxhc3RNZXNzYWdlXG4gICAgICAgICAgICAgICAgPyBgJHtsYXN0TWVzc2FnZS50ZXh0LnN1YnN0cmluZygwLCA0MCl9JHtsYXN0TWVzc2FnZS50ZXh0Lmxlbmd0aCA+IDQwID8gJy4uLicgOiAnJ31gXG4gICAgICAgICAgICAgICAgOiAnRW1wdHkgY2hhdCc7XG4gICAgICAgICAgICAvLyBBZGQgY2xpY2sgZXZlbnRcbiAgICAgICAgICAgIGhpc3RvcnlJdGVtLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4gdGhpcy5sb2FkQ2hhdChjaGF0LmlkKSk7XG4gICAgICAgICAgICBoaXN0b3J5SXRlbS5hcHBlbmRDaGlsZCh0aXRsZSk7XG4gICAgICAgICAgICBoaXN0b3J5SXRlbS5hcHBlbmRDaGlsZChwcmV2aWV3KTtcbiAgICAgICAgICAgIHRoaXMuaGlzdG9yeUNvbnRhaW5lci5hcHBlbmRDaGlsZChoaXN0b3J5SXRlbSk7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICAvKipcbiAgICAgKiBMb2FkcyBhIGNoYXQgZnJvbSBoaXN0b3J5XG4gICAgICovXG4gICAgbG9hZENoYXQoY2hhdElkKSB7XG4gICAgICAgIGNvbnN0IGNoYXQgPSB0aGlzLmNoYXRIaXN0b3J5LmZpbmQoYyA9PiBjLmlkID09PSBjaGF0SWQpO1xuICAgICAgICBpZiAoIWNoYXQpXG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIC8vIFNldCBhcyBjdXJyZW50IGNoYXRcbiAgICAgICAgdGhpcy5jdXJyZW50Q2hhdElkID0gY2hhdElkO1xuICAgICAgICAvLyBVcGRhdGUgdGl0bGVcbiAgICAgICAgdGhpcy50aXRsZUlucHV0LnZhbHVlID0gY2hhdC50aXRsZTtcbiAgICAgICAgLy8gQ2xlYXIgYW5kIHJlLXBvcHVsYXRlIG1lc3NhZ2UgY29udGFpbmVyXG4gICAgICAgIHRoaXMubWVzc2FnZUNvbnRhaW5lci5pbm5lckhUTUwgPSAnJztcbiAgICAgICAgY2hhdC5tZXNzYWdlcy5mb3JFYWNoKG1zZyA9PiB7XG4gICAgICAgICAgICB0aGlzLmFkZE1lc3NhZ2UobXNnLnRleHQsIG1zZy5zZW5kZXIsIG1zZy5pc01hcmtkb3duLCBmYWxzZSk7XG4gICAgICAgIH0pO1xuICAgICAgICAvLyBTd2l0Y2ggYmFjayB0byBjaGF0IHZpZXdcbiAgICAgICAgaWYgKHRoaXMuaXNIaXN0b3J5Vmlld0FjdGl2ZSkge1xuICAgICAgICAgICAgdGhpcy50b2dnbGVIaXN0b3J5VmlldygpO1xuICAgICAgICB9XG4gICAgfVxuICAgIC8qKlxuICAgICAqIFVwZGF0ZXMgdGhlIHRpdGxlIG9mIHRoZSBjdXJyZW50IGNoYXRcbiAgICAgKi9cbiAgICB1cGRhdGVDdXJyZW50Q2hhdFRpdGxlKCkge1xuICAgICAgICBjb25zdCBjaGF0ID0gdGhpcy5jaGF0SGlzdG9yeS5maW5kKGMgPT4gYy5pZCA9PT0gdGhpcy5jdXJyZW50Q2hhdElkKTtcbiAgICAgICAgaWYgKGNoYXQpIHtcbiAgICAgICAgICAgIGNoYXQudGl0bGUgPSB0aGlzLnRpdGxlSW5wdXQudmFsdWU7XG4gICAgICAgIH1cbiAgICB9XG4gICAgLyoqXG4gICAgICogQ3JlYXRlcyB0aGUgY29udHJvbHMgY29udGFpbmVyIHdpdGggdG9nZ2xlcyBhbmQgYWN0aW9uIGJ1dHRvbnNcbiAgICAgKi9cbiAgICBjcmVhdGVDb250cm9sc0NvbnRhaW5lcigpIHtcbiAgICAgICAgY29uc3QgY29udHJvbHNDb250YWluZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcbiAgICAgICAgY29udHJvbHNDb250YWluZXIuY2xhc3NOYW1lID0gJ2NvbnRyb2xzLWNvbnRhaW5lcic7XG4gICAgICAgIC8vIENyZWF0ZSBtYXJrZG93biB0b2dnbGUgY29udGFpbmVyXG4gICAgICAgIGNvbnN0IHRvZ2dsZUNvbnRhaW5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xuICAgICAgICB0b2dnbGVDb250YWluZXIuY2xhc3NOYW1lID0gJ3RvZ2dsZS1jb250YWluZXInO1xuICAgICAgICAvLyBDcmVhdGUgbWFya2Rvd24gdG9nZ2xlXG4gICAgICAgIGNvbnN0IG1hcmtkb3duVG9nZ2xlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaW5wdXQnKTtcbiAgICAgICAgbWFya2Rvd25Ub2dnbGUudHlwZSA9ICdjaGVja2JveCc7XG4gICAgICAgIG1hcmtkb3duVG9nZ2xlLmlkID0gJ21hcmtkb3duLXRvZ2dsZSc7XG4gICAgICAgIG1hcmtkb3duVG9nZ2xlLnN0eWxlLm1hcmdpblJpZ2h0ID0gJzVweCc7XG4gICAgICAgIG1hcmtkb3duVG9nZ2xlLmFkZEV2ZW50TGlzdGVuZXIoJ2NoYW5nZScsIChlKSA9PiB7XG4gICAgICAgICAgICBjb25zdCB0YXJnZXQgPSBlLnRhcmdldDtcbiAgICAgICAgICAgIHRoaXMuaXNNYXJrZG93bk1vZGUgPSB0YXJnZXQuY2hlY2tlZDtcbiAgICAgICAgICAgIHRoaXMuaW5wdXRGaWVsZC5wbGFjZWhvbGRlciA9IHRoaXMuaXNNYXJrZG93bk1vZGUgP1xuICAgICAgICAgICAgICAgICdXcml0ZSBtYXJrZG93biBoZXJlLi4uXFxuXFxuIyBFeGFtcGxlIGhlYWRpbmdcXG4tIExpc3QgaXRlbVxcblxcbmBgYGNvZGUgYmxvY2tgYGAnIDpcbiAgICAgICAgICAgICAgICAnQXNrIG1lIGFueXRoaW5nLi4uJztcbiAgICAgICAgfSk7XG4gICAgICAgIC8vIENyZWF0ZSB0b2dnbGUgbGFiZWxcbiAgICAgICAgY29uc3QgdG9nZ2xlTGFiZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdsYWJlbCcpO1xuICAgICAgICB0b2dnbGVMYWJlbC5odG1sRm9yID0gJ21hcmtkb3duLXRvZ2dsZSc7XG4gICAgICAgIHRvZ2dsZUxhYmVsLnRleHRDb250ZW50ID0gJ01hcmtkb3duIG1vZGUnO1xuICAgICAgICB0b2dnbGVMYWJlbC5zdHlsZS5mb250U2l6ZSA9ICcxMnB4JztcbiAgICAgICAgLy8gQWRkIHRvZ2dsZSBlbGVtZW50cyB0byBjb250YWluZXJcbiAgICAgICAgdG9nZ2xlQ29udGFpbmVyLmFwcGVuZENoaWxkKG1hcmtkb3duVG9nZ2xlKTtcbiAgICAgICAgdG9nZ2xlQ29udGFpbmVyLmFwcGVuZENoaWxkKHRvZ2dsZUxhYmVsKTtcbiAgICAgICAgLy8gQ3JlYXRlIGFjdGlvbiBidXR0b25zIGNvbnRhaW5lclxuICAgICAgICBjb25zdCBhY3Rpb25CdXR0b25zQ29udGFpbmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XG4gICAgICAgIGFjdGlvbkJ1dHRvbnNDb250YWluZXIuY2xhc3NOYW1lID0gJ2FjdGlvbi1idXR0b25zLWNvbnRhaW5lcic7XG4gICAgICAgIC8vIENyZWF0ZSBhbGwgYWN0aW9uIGJ1dHRvbnNcbiAgICAgICAgY29uc3QgYnV0dG9ucyA9IFtcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICB0ZXh0OiAnQCcsXG4gICAgICAgICAgICAgICAgdGl0bGU6ICdDb21tYW5kIGxpc3QnLFxuICAgICAgICAgICAgICAgIGFjdGlvbjogKGV2ZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCByZWN0ID0gZXZlbnQuY3VycmVudFRhcmdldC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93Q29tbWFuZE1lbnUocmVjdC5sZWZ0LCByZWN0LmJvdHRvbSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHsgdGV4dDogJ/Cfk44nLCB0aXRsZTogJ1VwbG9hZCBmaWxlJywgYWN0aW9uOiAoKSA9PiB7IH0gfSxcbiAgICAgICAgICAgIHsgdGV4dDogJ/CflI0nLCB0aXRsZTogJ0Jyb3dzZSBmaWxlcycsIGFjdGlvbjogKCkgPT4geyB9IH0sXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgdGV4dDogJ+KkoicsXG4gICAgICAgICAgICAgICAgdGl0bGU6ICdFeHBhbmQgaW5wdXQnLFxuICAgICAgICAgICAgICAgIGFjdGlvbjogKCkgPT4gdGhpcy50b2dnbGVJbnB1dEV4cGFuc2lvbihhY3Rpb25CdXR0b25zQ29udGFpbmVyLmNoaWxkcmVuWzNdKVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHsgdGV4dDogJ+Kame+4jycsIHRpdGxlOiAnU2V0dGluZ3MnLCBhY3Rpb246ICgpID0+IHsgfSB9LFxuICAgICAgICAgICAgeyB0ZXh0OiAn8J+TgScsIHRpdGxlOiAnTGlzdCBEaXJlY3RvcnkgQ29udGVudHMnLCBhY3Rpb246ICgpID0+IHRoaXMubGlzdEN1cnJlbnREaXJlY3RvcnlDb250ZW50cygpIH1cbiAgICAgICAgXTtcbiAgICAgICAgLy8gQWRkIGFsbCBidXR0b25zIHRvIHRoZSBjb250YWluZXJcbiAgICAgICAgYnV0dG9ucy5mb3JFYWNoKGJ1dHRvbiA9PiB7XG4gICAgICAgICAgICBjb25zdCBidG4gPSB0aGlzLmNyZWF0ZUJ1dHRvbihidXR0b24udGV4dCwgYnV0dG9uLnRpdGxlKTtcbiAgICAgICAgICAgIGJ0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiBidXR0b24uYWN0aW9uKGUpKTtcbiAgICAgICAgICAgIGFjdGlvbkJ1dHRvbnNDb250YWluZXIuYXBwZW5kQ2hpbGQoYnRuKTtcbiAgICAgICAgfSk7XG4gICAgICAgIC8vIEFkZCB0b2dnbGUgYW5kIGFjdGlvbiBidXR0b25zIHRvIHRoZSBjb250cm9scyBjb250YWluZXJcbiAgICAgICAgY29udHJvbHNDb250YWluZXIuYXBwZW5kQ2hpbGQodG9nZ2xlQ29udGFpbmVyKTtcbiAgICAgICAgY29udHJvbHNDb250YWluZXIuYXBwZW5kQ2hpbGQoYWN0aW9uQnV0dG9uc0NvbnRhaW5lcik7XG4gICAgICAgIHJldHVybiBjb250cm9sc0NvbnRhaW5lcjtcbiAgICB9XG4gICAgLyoqXG4gICAgICogVG9nZ2xlcyB0aGUgZXhwYW5zaW9uIHN0YXRlIG9mIHRoZSBpbnB1dCBmaWVsZFxuICAgICAqL1xuICAgIHRvZ2dsZUlucHV0RXhwYW5zaW9uKGJ1dHRvbikge1xuICAgICAgICB0aGlzLmlzSW5wdXRFeHBhbmRlZCA9ICF0aGlzLmlzSW5wdXRFeHBhbmRlZDtcbiAgICAgICAgaWYgKHRoaXMuaXNJbnB1dEV4cGFuZGVkKSB7XG4gICAgICAgICAgICB0aGlzLmlucHV0RmllbGQuc3R5bGUuaGVpZ2h0ID0gJzEwMHB4JztcbiAgICAgICAgICAgIHRoaXMuaW5wdXRGaWVsZC5zdHlsZS5yZXNpemUgPSAndmVydGljYWwnO1xuICAgICAgICAgICAgYnV0dG9uLnRleHRDb250ZW50ID0gJ+KkoSc7XG4gICAgICAgICAgICBidXR0b24udGl0bGUgPSAnQ29sbGFwc2UgaW5wdXQnO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5pbnB1dEZpZWxkLnN0eWxlLmhlaWdodCA9ICdhdXRvJztcbiAgICAgICAgICAgIHRoaXMuaW5wdXRGaWVsZC5zdHlsZS5yZXNpemUgPSAnbm9uZSc7XG4gICAgICAgICAgICBidXR0b24udGV4dENvbnRlbnQgPSAn4qSiJztcbiAgICAgICAgICAgIGJ1dHRvbi50aXRsZSA9ICdFeHBhbmQgaW5wdXQnO1xuICAgICAgICB9XG4gICAgfVxuICAgIC8qKlxuICAgICAqIEhlbHBlciBmdW5jdGlvbiB0byBjcmVhdGUgYSBidXR0b24gd2l0aCBnaXZlbiB0ZXh0IGFuZCB0b29sdGlwXG4gICAgICovXG4gICAgY3JlYXRlQnV0dG9uKHRleHQsIHRvb2x0aXApIHtcbiAgICAgICAgY29uc3QgYnV0dG9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYnV0dG9uJyk7XG4gICAgICAgIGJ1dHRvbi50ZXh0Q29udGVudCA9IHRleHQ7XG4gICAgICAgIGJ1dHRvbi50aXRsZSA9IHRvb2x0aXA7XG4gICAgICAgIGJ1dHRvbi5jbGFzc05hbWUgPSAnanAtQnV0dG9uIGFjdGlvbi1idXR0b24nO1xuICAgICAgICByZXR1cm4gYnV0dG9uO1xuICAgIH1cbiAgICAvKipcbiAgICAgKiBIYW5kbGVzIHNlbmRpbmcgYSBtZXNzYWdlIGZyb20gdGhlIGlucHV0IGZpZWxkXG4gICAgICovXG4gICAgaGFuZGxlU2VuZE1lc3NhZ2UoKSB7XG4gICAgICAgIGNvbnN0IG1lc3NhZ2UgPSB0aGlzLmlucHV0RmllbGQudmFsdWUudHJpbSgpO1xuICAgICAgICBpZiAobWVzc2FnZSkge1xuICAgICAgICAgICAgLy8gQWRkIHVzZXIgbWVzc2FnZSB0byBVSVxuICAgICAgICAgICAgdGhpcy5hZGRNZXNzYWdlKG1lc3NhZ2UsICd1c2VyJywgdGhpcy5pc01hcmtkb3duTW9kZSk7XG4gICAgICAgICAgICB0aGlzLmlucHV0RmllbGQudmFsdWUgPSAnJztcbiAgICAgICAgICAgIC8vIFJlc2V0IGV4cGFuZGVkIHN0YXRlIGlmIG5lZWRlZCBhZnRlciBzZW5kaW5nXG4gICAgICAgICAgICBpZiAodGhpcy5pc0lucHV0RXhwYW5kZWQpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmlucHV0RmllbGQuc3R5bGUuaGVpZ2h0ID0gJzEwMHB4JztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMuaW5wdXRGaWVsZC5zdHlsZS5oZWlnaHQgPSAnYXV0byc7XG4gICAgICAgICAgICAgICAgdGhpcy5pbnB1dEZpZWxkLnJvd3MgPSAxO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gQ3JlYXRlIGEgdGVtcG9yYXJ5IG1lc3NhZ2UgY29udGFpbmVyIGZvciB0aGUgYm90J3Mgc3RyZWFtaW5nIHJlc3BvbnNlXG4gICAgICAgICAgICBjb25zdCBib3RNZXNzYWdlRGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XG4gICAgICAgICAgICBib3RNZXNzYWdlRGl2LmNsYXNzTmFtZSA9ICdib3QtbWVzc2FnZSc7XG4gICAgICAgICAgICBjb25zdCBtYXJrZG93bkluZGljYXRvciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xuICAgICAgICAgICAgbWFya2Rvd25JbmRpY2F0b3IudGV4dENvbnRlbnQgPSBcIk1EXCI7XG4gICAgICAgICAgICBtYXJrZG93bkluZGljYXRvci5jbGFzc05hbWUgPSAnbWFya2Rvd24taW5kaWNhdG9yJztcbiAgICAgICAgICAgIGJvdE1lc3NhZ2VEaXYuYXBwZW5kQ2hpbGQobWFya2Rvd25JbmRpY2F0b3IpO1xuICAgICAgICAgICAgLy8gQ3JlYXRlIHNlcGFyYXRlIGRpdnMgZm9yIHN0cmVhbWluZyB0ZXh0IGFuZCBmaW5hbCBtYXJrZG93blxuICAgICAgICAgICAgY29uc3Qgc3RyZWFtaW5nRGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XG4gICAgICAgICAgICBzdHJlYW1pbmdEaXYuY2xhc3NOYW1lID0gJ3N0cmVhbWluZy1jb250ZW50JztcbiAgICAgICAgICAgIHN0cmVhbWluZ0Rpdi5zdHlsZS53aGl0ZVNwYWNlID0gJ3ByZS13cmFwJztcbiAgICAgICAgICAgIHN0cmVhbWluZ0Rpdi5zdHlsZS5mb250RmFtaWx5ID0gJ21vbm9zcGFjZSc7XG4gICAgICAgICAgICBzdHJlYW1pbmdEaXYuc3R5bGUuZm9udFNpemUgPSAnMC45ZW0nO1xuICAgICAgICAgICAgYm90TWVzc2FnZURpdi5hcHBlbmRDaGlsZChzdHJlYW1pbmdEaXYpO1xuICAgICAgICAgICAgY29uc3QgY29udGVudERpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xuICAgICAgICAgICAgY29udGVudERpdi5jbGFzc05hbWUgPSAnbWFya2Rvd24tY29udGVudCc7XG4gICAgICAgICAgICBjb250ZW50RGl2LnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7IC8vIEluaXRpYWxseSBoaWRkZW5cbiAgICAgICAgICAgIGJvdE1lc3NhZ2VEaXYuYXBwZW5kQ2hpbGQoY29udGVudERpdik7XG4gICAgICAgICAgICB0aGlzLm1lc3NhZ2VDb250YWluZXIuYXBwZW5kQ2hpbGQoYm90TWVzc2FnZURpdik7XG4gICAgICAgICAgICAvLyBWYXJpYWJsZSB0byBjb2xsZWN0IHRoZSBjb21wbGV0ZSByZXNwb25zZVxuICAgICAgICAgICAgbGV0IGNvbXBsZXRlUmVzcG9uc2UgPSAnJztcbiAgICAgICAgICAgIC8vIEdldCBjZWxsIGNvbnRleHQgaWYgYXZhaWxhYmxlXG4gICAgICAgICAgICBjb25zdCBjZWxsQ29udGV4dCA9IGdsb2JhbHNfMS5nbG9iYWxzLmNlbGxDb250ZXh0VHJhY2tlciA/XG4gICAgICAgICAgICAgICAgZ2xvYmFsc18xLmdsb2JhbHMuY2VsbENvbnRleHRUcmFja2VyLmdldEN1cnJlbnRDZWxsQ29udGV4dCgpIDogbnVsbDtcbiAgICAgICAgICAgIC8vIFN0cmVhbSByZXNwb25zZSBmcm9tIEFQSVxuICAgICAgICAgICAgdGhpcy5hcGlDbGllbnQuc3RyZWFtQ2hhdChtZXNzYWdlLCB7IGNlbGxDb250ZXh0IH0sIFxuICAgICAgICAgICAgLy8gT24gZWFjaCBjaHVuayByZWNlaXZlZFxuICAgICAgICAgICAgKGNodW5rKSA9PiB7XG4gICAgICAgICAgICAgICAgY29tcGxldGVSZXNwb25zZSArPSBjaHVuaztcbiAgICAgICAgICAgICAgICBzdHJlYW1pbmdEaXYudGV4dENvbnRlbnQgPSBjb21wbGV0ZVJlc3BvbnNlO1xuICAgICAgICAgICAgICAgIHRoaXMubWVzc2FnZUNvbnRhaW5lci5zY3JvbGxUb3AgPSB0aGlzLm1lc3NhZ2VDb250YWluZXIuc2Nyb2xsSGVpZ2h0O1xuICAgICAgICAgICAgfSwgXG4gICAgICAgICAgICAvLyBPbiBjb21wbGV0ZVxuICAgICAgICAgICAgKCkgPT4ge1xuICAgICAgICAgICAgICAgIC8vIEhpZGUgc3RyZWFtaW5nIGRpdiwgc2hvdyBtYXJrZG93biBkaXZcbiAgICAgICAgICAgICAgICBzdHJlYW1pbmdEaXYuc3R5bGUuZGlzcGxheSA9ICdub25lJztcbiAgICAgICAgICAgICAgICBjb250ZW50RGl2LnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snO1xuICAgICAgICAgICAgICAgIC8vIFByZS1wcm9jZXNzIGFuZCByZW5kZXIgbWFya2Rvd25cbiAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICAvLyBQcmUtcHJvY2VzcyB0aGUgbWFya2Rvd24gdG8gZml4IGFueSBpc3N1ZXMgd2l0aCBjb2RlIGJsb2Nrc1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBwcm9jZXNzZWRNYXJrZG93biA9ICgwLCBtYXJrZG93bl9jb25maWdfMS5wcmVwcm9jZXNzTWFya2Rvd24pKGNvbXBsZXRlUmVzcG9uc2UpO1xuICAgICAgICAgICAgICAgICAgICAvLyBQYXJzZSBhbmQgc2FuaXRpemVcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmF3SHRtbCA9IG1hcmtlZF8xLm1hcmtlZC5wYXJzZShwcm9jZXNzZWRNYXJrZG93bik7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHNhbml0aXplZEh0bWwgPSBkb21wdXJpZnlfMS5kZWZhdWx0LnNhbml0aXplKHJhd0h0bWwpO1xuICAgICAgICAgICAgICAgICAgICAvLyBBcHBseSB0aGUgSFRNTCB3aXRoIHByb3BlciBjb2RlIGJsb2NrIHN0eWxpbmdcbiAgICAgICAgICAgICAgICAgICAgY29udGVudERpdi5pbm5lckhUTUwgPSBzYW5pdGl6ZWRIdG1sO1xuICAgICAgICAgICAgICAgICAgICAvLyBBZGQgc3ludGF4IGhpZ2hsaWdodGluZyBjbGFzc2VzIHRvIGNvZGUgYmxvY2tzXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvZGVCbG9ja3MgPSBjb250ZW50RGl2LnF1ZXJ5U2VsZWN0b3JBbGwoJ3ByZSBjb2RlJyk7XG4gICAgICAgICAgICAgICAgICAgIGNvZGVCbG9ja3MuZm9yRWFjaChibG9jayA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgX2E7XG4gICAgICAgICAgICAgICAgICAgICAgICBibG9jay5jbGFzc0xpc3QuYWRkKCdqcC1SZW5kZXJlZFRleHQnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIChfYSA9IGJsb2NrLnBhcmVudEVsZW1lbnQpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5jbGFzc0xpc3QuYWRkKCdqcC1SZW5kZXJlZEhUTUxDb21tb24nKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIC8vIEFkZCBhY3Rpb24gYnV0dG9ucyB0byB0aGUgYm90IG1lc3NhZ2VcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ0FkZGluZyBhY3Rpb24gYnV0dG9ucyB0byBzdHJlYW1lZCBib3QgbWVzc2FnZScpO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBhY3Rpb25zRGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XG4gICAgICAgICAgICAgICAgICAgIGFjdGlvbnNEaXYuY2xhc3NOYW1lID0gJ21lc3NhZ2UtYWN0aW9ucyc7XG4gICAgICAgICAgICAgICAgICAgIGFjdGlvbnNEaXYuc3R5bGUuZGlzcGxheSA9ICdmbGV4JzsgLy8gRW5zdXJlIGRpc3BsYXkgaXMgc2V0XG4gICAgICAgICAgICAgICAgICAgIC8vIENvcHkgYnV0dG9uIHdpdGggaWNvblxuICAgICAgICAgICAgICAgICAgICBjb25zdCBjb3B5QnV0dG9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYnV0dG9uJyk7XG4gICAgICAgICAgICAgICAgICAgIGNvcHlCdXR0b24uY2xhc3NOYW1lID0gJ21lc3NhZ2UtYWN0aW9uLWJ1dHRvbic7XG4gICAgICAgICAgICAgICAgICAgIGNvcHlCdXR0b24uaW5uZXJIVE1MID0gJzxzdmcgeG1sbnM9XCJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Z1wiIHdpZHRoPVwiMTZcIiBoZWlnaHQ9XCIxNlwiIHZpZXdCb3g9XCIwIDAgMjQgMjRcIiBmaWxsPVwibm9uZVwiIHN0cm9rZT1cImN1cnJlbnRDb2xvclwiIHN0cm9rZS13aWR0aD1cIjJcIiBzdHJva2UtbGluZWNhcD1cInJvdW5kXCIgc3Ryb2tlLWxpbmVqb2luPVwicm91bmRcIj48cmVjdCB4PVwiOVwiIHk9XCI5XCIgd2lkdGg9XCIxM1wiIGhlaWdodD1cIjEzXCIgcng9XCIyXCIgcnk9XCIyXCI+PC9yZWN0PjxwYXRoIGQ9XCJNNSAxNUg0YTIgMiAwIDAgMS0yLTJWNGEyIDIgMCAwIDEgMi0yaDlhMiAyIDAgMCAxIDIgMnYxXCI+PC9wYXRoPjwvc3ZnPic7XG4gICAgICAgICAgICAgICAgICAgIGNvcHlCdXR0b24udGl0bGUgPSAnQ29weSBtZXNzYWdlIHRvIGNsaXBib2FyZCc7XG4gICAgICAgICAgICAgICAgICAgIGNvcHlCdXR0b24uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jb3B5TWVzc2FnZVRvQ2xpcGJvYXJkKGNvbXBsZXRlUmVzcG9uc2UpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgYWN0aW9uc0Rpdi5hcHBlbmRDaGlsZChjb3B5QnV0dG9uKTtcbiAgICAgICAgICAgICAgICAgICAgLy8gQWRkIHRvIGJ1dHRvbiB3aXRoIGljb25cbiAgICAgICAgICAgICAgICAgICAgY29uc3QgYWRkVG9CdXR0b24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdidXR0b24nKTtcbiAgICAgICAgICAgICAgICAgICAgYWRkVG9CdXR0b24uY2xhc3NOYW1lID0gJ21lc3NhZ2UtYWN0aW9uLWJ1dHRvbic7XG4gICAgICAgICAgICAgICAgICAgIGFkZFRvQnV0dG9uLmlubmVySFRNTCA9ICc8c3ZnIHhtbG5zPVwiaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmdcIiB3aWR0aD1cIjE2XCIgaGVpZ2h0PVwiMTZcIiB2aWV3Qm94PVwiMCAwIDI0IDI0XCIgZmlsbD1cIm5vbmVcIiBzdHJva2U9XCJjdXJyZW50Q29sb3JcIiBzdHJva2Utd2lkdGg9XCIyXCIgc3Ryb2tlLWxpbmVjYXA9XCJyb3VuZFwiIHN0cm9rZS1saW5lam9pbj1cInJvdW5kXCI+PHBhdGggZD1cIk0xNiA0aDJhMiAyIDAgMCAxIDIgMnYxNGEyIDIgMCAwIDEtMiAySDZhMiAyIDAgMCAxLTItMlY2YTIgMiAwIDAgMSAyLTJoMlwiPjwvcGF0aD48cmVjdCB4PVwiOFwiIHk9XCIyXCIgd2lkdGg9XCI4XCIgaGVpZ2h0PVwiNFwiIHJ4PVwiMVwiIHJ5PVwiMVwiPjwvcmVjdD48cGF0aCBkPVwiTTEyIDExdjZcIj48L3BhdGg+PHBhdGggZD1cIk05IDE0aDZcIj48L3BhdGg+PC9zdmc+JztcbiAgICAgICAgICAgICAgICAgICAgYWRkVG9CdXR0b24udGl0bGUgPSAnQWRkIG1lc3NhZ2UgdG8gY3VycmVudCBjZWxsJztcbiAgICAgICAgICAgICAgICAgICAgYWRkVG9CdXR0b24uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hZGRNZXNzYWdlVG9DZWxsKGNvbXBsZXRlUmVzcG9uc2UpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgYWN0aW9uc0Rpdi5hcHBlbmRDaGlsZChhZGRUb0J1dHRvbik7XG4gICAgICAgICAgICAgICAgICAgIC8vIEFkZCBidXR0b25zIHRvIG1lc3NhZ2VcbiAgICAgICAgICAgICAgICAgICAgYm90TWVzc2FnZURpdi5hcHBlbmRDaGlsZChhY3Rpb25zRGl2KTtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ0FjdGlvbiBidXR0b25zIGFkZGVkIHRvIGJvdCBtZXNzYWdlOicsIGFjdGlvbnNEaXYpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgICAgICAgICAgY29udGVudERpdi50ZXh0Q29udGVudCA9IGNvbXBsZXRlUmVzcG9uc2U7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0ZhaWxlZCB0byByZW5kZXIgbWFya2Rvd246JywgZXJyb3IpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAvLyBTYXZlIHRvIGNoYXQgaGlzdG9yeVxuICAgICAgICAgICAgICAgIGNvbnN0IGNoYXQgPSB0aGlzLmNoYXRIaXN0b3J5LmZpbmQoYyA9PiBjLmlkID09PSB0aGlzLmN1cnJlbnRDaGF0SWQpO1xuICAgICAgICAgICAgICAgIGlmIChjaGF0KSB7XG4gICAgICAgICAgICAgICAgICAgIGNoYXQubWVzc2FnZXMucHVzaCh7XG4gICAgICAgICAgICAgICAgICAgICAgICB0ZXh0OiBjb21wbGV0ZVJlc3BvbnNlLFxuICAgICAgICAgICAgICAgICAgICAgICAgc2VuZGVyOiAnYm90JyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGlzTWFya2Rvd246IHRydWVcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHRoaXMubWVzc2FnZUNvbnRhaW5lci5zY3JvbGxUb3AgPSB0aGlzLm1lc3NhZ2VDb250YWluZXIuc2Nyb2xsSGVpZ2h0O1xuICAgICAgICAgICAgfSwgXG4gICAgICAgICAgICAvLyBPbiBlcnJvclxuICAgICAgICAgICAgKGVycm9yKSA9PiB7XG4gICAgICAgICAgICAgICAgc3RyZWFtaW5nRGl2LnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7XG4gICAgICAgICAgICAgICAgY29udGVudERpdi5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJztcbiAgICAgICAgICAgICAgICBjb250ZW50RGl2LmlubmVySFRNTCA9IGA8ZGl2IGNsYXNzPVwiZXJyb3ItbWVzc2FnZVwiPkVycm9yOiAke2Vycm9yLm1lc3NhZ2V9PC9kaXY+YDtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCdBUEkgRXJyb3I6JywgZXJyb3IpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgLyoqXG4gICAgICogQWRkcyBhIG1lc3NhZ2UgdG8gdGhlIGNoYXQgaW50ZXJmYWNlXG4gICAgICovXG4gICAgYWRkTWVzc2FnZSh0ZXh0LCBzZW5kZXIsIGlzTWFya2Rvd24gPSBmYWxzZSwgc2F2ZVRvSGlzdG9yeSA9IHRydWUpIHtcbiAgICAgICAgY29uc29sZS5sb2coJ0FkZGluZyBtZXNzYWdlOicsIHsgc2VuZGVyLCBpc01hcmtkb3duIH0pOyAvLyBEZWJ1ZyBsb2dcbiAgICAgICAgY29uc3QgbWVzc2FnZURpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xuICAgICAgICBtZXNzYWdlRGl2LmNsYXNzTmFtZSA9IHNlbmRlciA9PT0gJ3VzZXInID8gJ3VzZXItbWVzc2FnZScgOiAnYm90LW1lc3NhZ2UnO1xuICAgICAgICAvLyBBZGQgbWVzc2FnZSBjb250ZW50XG4gICAgICAgIGlmIChpc01hcmtkb3duIHx8IHNlbmRlciA9PT0gJ2JvdCcpIHtcbiAgICAgICAgICAgIC8vIEJvdCBtZXNzYWdlcyBhcmUgYWx3YXlzIHJlbmRlcmVkIGFzIG1hcmtkb3duXG4gICAgICAgICAgICBjb25zdCBtYXJrZG93bkluZGljYXRvciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xuICAgICAgICAgICAgbWFya2Rvd25JbmRpY2F0b3IudGV4dENvbnRlbnQgPSBcIk1EXCI7XG4gICAgICAgICAgICBtYXJrZG93bkluZGljYXRvci5jbGFzc05hbWUgPSAnbWFya2Rvd24taW5kaWNhdG9yJztcbiAgICAgICAgICAgIG1lc3NhZ2VEaXYuYXBwZW5kQ2hpbGQobWFya2Rvd25JbmRpY2F0b3IpO1xuICAgICAgICAgICAgLy8gQ3JlYXRlIGEgY29udGFpbmVyIGZvciB0aGUgcmVuZGVyZWQgbWFya2Rvd25cbiAgICAgICAgICAgIGNvbnN0IGNvbnRlbnREaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcbiAgICAgICAgICAgIGNvbnRlbnREaXYuY2xhc3NOYW1lID0gJ21hcmtkb3duLWNvbnRlbnQnO1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAvLyBQcmUtcHJvY2VzcyB0aGUgbWFya2Rvd24gdGV4dFxuICAgICAgICAgICAgICAgIGNvbnN0IHByb2Nlc3NlZFRleHQgPSAoMCwgbWFya2Rvd25fY29uZmlnXzEucHJlcHJvY2Vzc01hcmtkb3duKSh0ZXh0KTtcbiAgICAgICAgICAgICAgICAvLyBQYXJzZSBhbmQgcmVuZGVyIG1hcmtkb3duXG4gICAgICAgICAgICAgICAgY29uc3QgcmF3SHRtbCA9IG1hcmtlZF8xLm1hcmtlZC5wYXJzZShwcm9jZXNzZWRUZXh0KTtcbiAgICAgICAgICAgICAgICBjb25zdCBzYW5pdGl6ZWRIdG1sID0gZG9tcHVyaWZ5XzEuZGVmYXVsdC5zYW5pdGl6ZShyYXdIdG1sKTtcbiAgICAgICAgICAgICAgICBjb250ZW50RGl2LmlubmVySFRNTCA9IHNhbml0aXplZEh0bWw7XG4gICAgICAgICAgICAgICAgLy8gQWRkIHN5bnRheCBoaWdobGlnaHRpbmcgY2xhc3NlcyB0byBjb2RlIGJsb2Nrc1xuICAgICAgICAgICAgICAgIGNvbnN0IGNvZGVCbG9ja3MgPSBjb250ZW50RGl2LnF1ZXJ5U2VsZWN0b3JBbGwoJ3ByZSBjb2RlJyk7XG4gICAgICAgICAgICAgICAgY29kZUJsb2Nrcy5mb3JFYWNoKGJsb2NrID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIF9hO1xuICAgICAgICAgICAgICAgICAgICBibG9jay5jbGFzc0xpc3QuYWRkKCdqcC1SZW5kZXJlZFRleHQnKTtcbiAgICAgICAgICAgICAgICAgICAgKF9hID0gYmxvY2sucGFyZW50RWxlbWVudCkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmNsYXNzTGlzdC5hZGQoJ2pwLVJlbmRlcmVkSFRNTENvbW1vbicpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgY29udGVudERpdi50ZXh0Q29udGVudCA9IHRleHQ7XG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignRmFpbGVkIHRvIHJlbmRlciBtYXJrZG93bjonLCBlcnJvcik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBtZXNzYWdlRGl2LmFwcGVuZENoaWxkKGNvbnRlbnREaXYpO1xuICAgICAgICAgICAgLy8gQWRkIGFjdGlvbiBidXR0b25zIGZvciBib3QgbWVzc2FnZXNcbiAgICAgICAgICAgIGlmIChzZW5kZXIgPT09ICdib3QnKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ0FkZGluZyBhY3Rpb24gYnV0dG9ucyB0byBib3QgbWVzc2FnZScpOyAvLyBEZWJ1ZyBsb2dcbiAgICAgICAgICAgICAgICBjb25zdCBhY3Rpb25zRGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XG4gICAgICAgICAgICAgICAgYWN0aW9uc0Rpdi5jbGFzc05hbWUgPSAnbWVzc2FnZS1hY3Rpb25zJztcbiAgICAgICAgICAgICAgICAvLyBDb3B5IGJ1dHRvbiB3aXRoIGljb25cbiAgICAgICAgICAgICAgICBjb25zdCBjb3B5QnV0dG9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYnV0dG9uJyk7XG4gICAgICAgICAgICAgICAgY29weUJ1dHRvbi5jbGFzc05hbWUgPSAnbWVzc2FnZS1hY3Rpb24tYnV0dG9uJztcbiAgICAgICAgICAgICAgICBjb3B5QnV0dG9uLmlubmVySFRNTCA9ICc8c3ZnIHhtbG5zPVwiaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmdcIiB3aWR0aD1cIjE2XCIgaGVpZ2h0PVwiMTZcIiB2aWV3Qm94PVwiMCAwIDI0IDI0XCIgZmlsbD1cIm5vbmVcIiBzdHJva2U9XCJjdXJyZW50Q29sb3JcIiBzdHJva2Utd2lkdGg9XCIyXCIgc3Ryb2tlLWxpbmVjYXA9XCJyb3VuZFwiIHN0cm9rZS1saW5lam9pbj1cInJvdW5kXCI+PHJlY3QgeD1cIjlcIiB5PVwiOVwiIHdpZHRoPVwiMTNcIiBoZWlnaHQ9XCIxM1wiIHJ4PVwiMlwiIHJ5PVwiMlwiPjwvcmVjdD48cGF0aCBkPVwiTTUgMTVINGEyIDIgMCAwIDEtMi0yVjRhMiAyIDAgMCAxIDItMmg5YTIgMiAwIDAgMSAyIDJ2MVwiPjwvcGF0aD48L3N2Zz4nO1xuICAgICAgICAgICAgICAgIGNvcHlCdXR0b24udGl0bGUgPSAnQ29weSBtZXNzYWdlIHRvIGNsaXBib2FyZCc7XG4gICAgICAgICAgICAgICAgY29weUJ1dHRvbi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChldmVudCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb3B5TWVzc2FnZVRvQ2xpcGJvYXJkKHRleHQpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIGFjdGlvbnNEaXYuYXBwZW5kQ2hpbGQoY29weUJ1dHRvbik7XG4gICAgICAgICAgICAgICAgLy8gQWRkIHRvIGJ1dHRvbiB3aXRoIGljb25cbiAgICAgICAgICAgICAgICBjb25zdCBhZGRUb0J1dHRvbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2J1dHRvbicpO1xuICAgICAgICAgICAgICAgIGFkZFRvQnV0dG9uLmNsYXNzTmFtZSA9ICdtZXNzYWdlLWFjdGlvbi1idXR0b24nO1xuICAgICAgICAgICAgICAgIGFkZFRvQnV0dG9uLmlubmVySFRNTCA9ICc8c3ZnIHhtbG5zPVwiaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmdcIiB3aWR0aD1cIjE2XCIgaGVpZ2h0PVwiMTZcIiB2aWV3Qm94PVwiMCAwIDI0IDI0XCIgZmlsbD1cIm5vbmVcIiBzdHJva2U9XCJjdXJyZW50Q29sb3JcIiBzdHJva2Utd2lkdGg9XCIyXCIgc3Ryb2tlLWxpbmVjYXA9XCJyb3VuZFwiIHN0cm9rZS1saW5lam9pbj1cInJvdW5kXCI+PHBhdGggZD1cIk0xNiA0aDJhMiAyIDAgMCAxIDIgMnYxNGEyIDIgMCAwIDEtMiAySDZhMiAyIDAgMCAxLTItMlY2YTIgMiAwIDAgMSAyLTJoMlwiPjwvcGF0aD48cmVjdCB4PVwiOFwiIHk9XCIyXCIgd2lkdGg9XCI4XCIgaGVpZ2h0PVwiNFwiIHJ4PVwiMVwiIHJ5PVwiMVwiPjwvcmVjdD48cGF0aCBkPVwiTTEyIDExdjZcIj48L3BhdGg+PHBhdGggZD1cIk05IDE0aDZcIj48L3BhdGg+PC9zdmc+JztcbiAgICAgICAgICAgICAgICBhZGRUb0J1dHRvbi50aXRsZSA9ICdBZGQgbWVzc2FnZSB0byBjdXJyZW50IGNlbGwnO1xuICAgICAgICAgICAgICAgIGFkZFRvQnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGV2ZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmFkZE1lc3NhZ2VUb0NlbGwodGV4dCk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgYWN0aW9uc0Rpdi5hcHBlbmRDaGlsZChhZGRUb0J1dHRvbik7XG4gICAgICAgICAgICAgICAgLy8gQWRkIGJ1dHRvbnMgdG8gbWVzc2FnZVxuICAgICAgICAgICAgICAgIG1lc3NhZ2VEaXYuYXBwZW5kQ2hpbGQoYWN0aW9uc0Rpdik7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ0FjdGlvbiBidXR0b25zIGFkZGVkIHRvIG1lc3NhZ2U6JywgYWN0aW9uc0Rpdik7IC8vIERlYnVnIGxvZ1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgbWVzc2FnZURpdi50ZXh0Q29udGVudCA9IHRleHQ7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5tZXNzYWdlQ29udGFpbmVyLmFwcGVuZENoaWxkKG1lc3NhZ2VEaXYpO1xuICAgICAgICB0aGlzLm1lc3NhZ2VDb250YWluZXIuc2Nyb2xsVG9wID0gdGhpcy5tZXNzYWdlQ29udGFpbmVyLnNjcm9sbEhlaWdodDtcbiAgICAgICAgLy8gU2F2ZSB0byBjaGF0IGhpc3RvcnlcbiAgICAgICAgaWYgKHNhdmVUb0hpc3RvcnkpIHtcbiAgICAgICAgICAgIGNvbnN0IGNoYXQgPSB0aGlzLmNoYXRIaXN0b3J5LmZpbmQoYyA9PiBjLmlkID09PSB0aGlzLmN1cnJlbnRDaGF0SWQpO1xuICAgICAgICAgICAgaWYgKGNoYXQpIHtcbiAgICAgICAgICAgICAgICBjaGF0Lm1lc3NhZ2VzLnB1c2goe1xuICAgICAgICAgICAgICAgICAgICB0ZXh0LFxuICAgICAgICAgICAgICAgICAgICBzZW5kZXIsXG4gICAgICAgICAgICAgICAgICAgIGlzTWFya2Rvd246IGlzTWFya2Rvd24gfHwgc2VuZGVyID09PSAnYm90J1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIC8qKlxuICAgICAqIENvcGllcyBtZXNzYWdlIGNvbnRlbnQgdG8gY2xpcGJvYXJkXG4gICAgICovXG4gICAgY29weU1lc3NhZ2VUb0NsaXBib2FyZCh0ZXh0KSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBuYXZpZ2F0b3IuY2xpcGJvYXJkLndyaXRlVGV4dCh0ZXh0KS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnQ29udGVudCBjb3BpZWQgdG8gY2xpcGJvYXJkJyk7XG4gICAgICAgICAgICAgICAgLy8gRmluZCB0aGUgYnV0dG9uIGVsZW1lbnQgdGhhdCB3YXMgY2xpY2tlZFxuICAgICAgICAgICAgICAgIGNvbnN0IGJ1dHRvbnMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCcubWVzc2FnZS1hY3Rpb24tYnV0dG9uJyk7XG4gICAgICAgICAgICAgICAgbGV0IGNsaWNrZWRCdXR0b24gPSBudWxsO1xuICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYnV0dG9ucy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBidXR0b24gPSBidXR0b25zW2ldO1xuICAgICAgICAgICAgICAgICAgICBpZiAoYnV0dG9uLnRpdGxlID09PSAnQ29weSBtZXNzYWdlIHRvIGNsaXBib2FyZCcgJiYgYnV0dG9uID09PSBkb2N1bWVudC5hY3RpdmVFbGVtZW50KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjbGlja2VkQnV0dG9uID0gYnV0dG9uO1xuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgLy8gU2hvdyB2aXN1YWwgZmVlZGJhY2sgaWYgd2UgZm91bmQgdGhlIGJ1dHRvblxuICAgICAgICAgICAgICAgIGlmIChjbGlja2VkQnV0dG9uKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IG9yaWdpbmFsSFRNTCA9IGNsaWNrZWRCdXR0b24uaW5uZXJIVE1MO1xuICAgICAgICAgICAgICAgICAgICBjbGlja2VkQnV0dG9uLmlubmVySFRNTCA9ICc8c3ZnIHhtbG5zPVwiaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmdcIiB3aWR0aD1cIjE2XCIgaGVpZ2h0PVwiMTZcIiB2aWV3Qm94PVwiMCAwIDI0IDI0XCIgZmlsbD1cIm5vbmVcIiBzdHJva2U9XCJjdXJyZW50Q29sb3JcIiBzdHJva2Utd2lkdGg9XCIyXCIgc3Ryb2tlLWxpbmVjYXA9XCJyb3VuZFwiIHN0cm9rZS1saW5lam9pbj1cInJvdW5kXCI+PHBhdGggZD1cIk0yMCA2TDkgMTdsLTUtNVwiPjwvcGF0aD48L3N2Zz4nO1xuICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNsaWNrZWRCdXR0b24uaW5uZXJIVE1MID0gb3JpZ2luYWxIVE1MO1xuICAgICAgICAgICAgICAgICAgICB9LCAyMDAwKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KS5jYXRjaChlcnIgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0ZhaWxlZCB0byBjb3B5IHRleHQ6ICcsIGVycik7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGNvcHlpbmcgdG8gY2xpcGJvYXJkOicsIGVycm9yKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICAvKipcbiAgICAgKiBBZGRzIG1lc3NhZ2UgY29udGVudCB0byB0aGUgY3VycmVudCBjZWxsXG4gICAgICovXG4gICAgYWRkTWVzc2FnZVRvQ2VsbCh0ZXh0KSB7XG4gICAgICAgIHZhciBfYTtcbiAgICAgICAgY29uc3QgY2VsbCA9IChfYSA9IGdsb2JhbHNfMS5nbG9iYWxzLm5vdGVib29rVHJhY2tlcikgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmFjdGl2ZUNlbGw7XG4gICAgICAgIGlmICghY2VsbCB8fCAhY2VsbC5lZGl0b3IpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgZWRpdG9yID0gY2VsbC5lZGl0b3I7XG4gICAgICAgICAgICBjb25zdCB2aWV3ID0gZWRpdG9yLmVkaXRvcjtcbiAgICAgICAgICAgIGlmICghdmlldykge1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vIEdldCBjdXJyZW50IGN1cnNvciBwb3NpdGlvblxuICAgICAgICAgICAgY29uc3Qgc3RhdGUgPSB2aWV3LnN0YXRlO1xuICAgICAgICAgICAgY29uc3Qgc2VsZWN0aW9uID0gc3RhdGUuc2VsZWN0aW9uO1xuICAgICAgICAgICAgY29uc3QgY3Vyc29yUG9zID0gc2VsZWN0aW9uLm1haW4uaGVhZDtcbiAgICAgICAgICAgIC8vIEluc2VydCBuZXdsaW5lIGFuZCBtZXNzYWdlIGNvbnRlbnQgYXQgY3Vyc29yIHBvc2l0aW9uXG4gICAgICAgICAgICBjb25zdCB0cmFuc2FjdGlvbiA9IHN0YXRlLnVwZGF0ZSh7XG4gICAgICAgICAgICAgICAgY2hhbmdlczoge1xuICAgICAgICAgICAgICAgICAgICBmcm9tOiBjdXJzb3JQb3MsXG4gICAgICAgICAgICAgICAgICAgIGluc2VydDogYFxcbiR7dGV4dH1gXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBzZWxlY3Rpb246IHsgYW5jaG9yOiBjdXJzb3JQb3MgKyB0ZXh0Lmxlbmd0aCArIDEgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB2aWV3LmRpc3BhdGNoKHRyYW5zYWN0aW9uKTtcbiAgICAgICAgfVxuICAgICAgICBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGFkZGluZyBtZXNzYWdlIHRvIGNlbGw6JywgZXJyb3IpO1xuICAgICAgICB9XG4gICAgfVxuICAgIC8qKlxuICAgICAqIExpc3RzIHRoZSBjb250ZW50cyBvZiB0aGUgY3VycmVudCBkaXJlY3RvcnlcbiAgICAgKi9cbiAgICBhc3luYyBsaXN0Q3VycmVudERpcmVjdG9yeUNvbnRlbnRzKCkge1xuICAgICAgICBsZXQgZGlyUGF0aCA9IG51bGw7XG4gICAgICAgIGxldCBzb3VyY2UgPSBudWxsO1xuICAgICAgICAvLyBUcnkgdG8gZ2V0IGRpcmVjdG9yeSBwYXRoIGZyb20gY3VycmVudCB3aWRnZXRcbiAgICAgICAgY29uc3QgYXBwID0gZ2xvYmFsc18xLmdsb2JhbHMuYXBwO1xuICAgICAgICBpZiAoIWFwcCkge1xuICAgICAgICAgICAgdGhpcy5hZGRNZXNzYWdlKCdFcnJvcjogQXBwbGljYXRpb24gcmVmZXJlbmNlIG5vdCBhdmFpbGFibGUnLCAnYm90JywgZmFsc2UpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGN1cnJlbnRTaGVsbFdpZGdldCA9IGFwcC5zaGVsbC5jdXJyZW50V2lkZ2V0O1xuICAgICAgICBpZiAoY3VycmVudFNoZWxsV2lkZ2V0KSB7XG4gICAgICAgICAgICBjb25zdCB3aWRnZXRDb250ZXh0ID0gdGhpcy5kb2NNYW5hZ2VyLmNvbnRleHRGb3JXaWRnZXQoY3VycmVudFNoZWxsV2lkZ2V0KTtcbiAgICAgICAgICAgIGlmICh3aWRnZXRDb250ZXh0KSB7XG4gICAgICAgICAgICAgICAgY29uc3QgcGF0aCA9IHdpZGdldENvbnRleHQucGF0aDtcbiAgICAgICAgICAgICAgICBjb25zdCBsYXN0U2xhc2ggPSBwYXRoLmxhc3RJbmRleE9mKCcvJyk7XG4gICAgICAgICAgICAgICAgZGlyUGF0aCA9IGxhc3RTbGFzaCA9PT0gLTEgPyAnJyA6IHBhdGguc3Vic3RyaW5nKDAsIGxhc3RTbGFzaCk7XG4gICAgICAgICAgICAgICAgc291cmNlID0gJ3dpZGdldCBjb250ZXh0JztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICAvLyBGYWxsYmFjayB0byBub3RlYm9vayB0cmFja2VyIGlmIG5vIGNvbnRleHQgZnJvbSB3aWRnZXRcbiAgICAgICAgaWYgKGRpclBhdGggPT09IG51bGwgJiYgZ2xvYmFsc18xLmdsb2JhbHMubm90ZWJvb2tUcmFja2VyKSB7XG4gICAgICAgICAgICBjb25zdCBjdXJyZW50Tm90ZWJvb2tQYW5lbCA9IGdsb2JhbHNfMS5nbG9iYWxzLm5vdGVib29rVHJhY2tlci5jdXJyZW50V2lkZ2V0O1xuICAgICAgICAgICAgaWYgKGN1cnJlbnROb3RlYm9va1BhbmVsIGluc3RhbmNlb2Ygbm90ZWJvb2tfMS5Ob3RlYm9va1BhbmVsKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgbmJQYXRoID0gY3VycmVudE5vdGVib29rUGFuZWwuY29udGV4dC5wYXRoO1xuICAgICAgICAgICAgICAgIGNvbnN0IGxhc3RTbGFzaCA9IG5iUGF0aC5sYXN0SW5kZXhPZignLycpO1xuICAgICAgICAgICAgICAgIGRpclBhdGggPSBsYXN0U2xhc2ggPT09IC0xID8gJycgOiBuYlBhdGguc3Vic3RyaW5nKDAsIGxhc3RTbGFzaCk7XG4gICAgICAgICAgICAgICAgc291cmNlID0gJ2FjdGl2ZSBub3RlYm9vayc7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgLy8gTGlzdCBjb250ZW50cyBpZiBwYXRoIHdhcyBmb3VuZFxuICAgICAgICBpZiAoZGlyUGF0aCAhPT0gbnVsbCkge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBjb25zdCBjb250ZW50cyA9IGF3YWl0IHRoaXMuZG9jTWFuYWdlci5zZXJ2aWNlcy5jb250ZW50cy5nZXQoZGlyUGF0aCk7XG4gICAgICAgICAgICAgICAgaWYgKGNvbnRlbnRzLmNvbnRlbnQgJiYgY29udGVudHMuY29udGVudC5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IG1lc3NhZ2VDb250ZW50ID0gYERpcmVjdG9yeSBjb250ZW50cyAoJHtzb3VyY2V9KTpcXG4ke2NvbnRlbnRzLmNvbnRlbnQubWFwKChpdGVtKSA9PiBgLSAke2l0ZW0ubmFtZX0gKCR7aXRlbS50eXBlfSlgKS5qb2luKCdcXG4nKX1gO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmFkZE1lc3NhZ2UobWVzc2FnZUNvbnRlbnQsICdib3QnLCB0cnVlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYWRkTWVzc2FnZShgRGlyZWN0b3J5IFwiJHtkaXJQYXRoIHx8ICcvJ31cIiBpcyBlbXB0eS5gLCAnYm90JywgdHJ1ZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5hZGRNZXNzYWdlKGBFcnJvciBsaXN0aW5nIGRpcmVjdG9yeSBjb250ZW50cyBmb3IgXCIke2RpclBhdGh9XCI6ICR7ZXJyb3J9YCwgJ2JvdCcsIHRydWUpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5hZGRNZXNzYWdlKCdDb3VsZCBub3QgZGV0ZXJtaW5lIGN1cnJlbnQgZGlyZWN0b3J5IGNvbnRleHQuJywgJ2JvdCcsIHRydWUpO1xuICAgICAgICB9XG4gICAgfVxuICAgIC8qKlxuICAgICAqIFNob3dzIHRoZSBjb21tYW5kIG1lbnUgYXQgdGhlIHNwZWNpZmllZCBwb3NpdGlvblxuICAgICAqL1xuICAgIHNob3dDb21tYW5kTWVudSh4LCB5KSB7XG4gICAgICAgIGNvbnN0IGNvbW1hbmRzID0gW1xuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIGxhYmVsOiAnY29kZScsXG4gICAgICAgICAgICAgICAgZGVzY3JpcHRpb246ICdJbnNlcnQgc2VsZWN0ZWQgY29kZScsXG4gICAgICAgICAgICAgICAgYWN0aW9uOiAoKSA9PiB0aGlzLmhhbmRsZUNvZGVDb21tYW5kKClcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgbGFiZWw6ICdjZWxsJyxcbiAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogJ0luc2VydCBlbnRpcmUgY2VsbCBjb250ZW50JyxcbiAgICAgICAgICAgICAgICBhY3Rpb246ICgpID0+IHRoaXMuaGFuZGxlQ2VsbENvbW1hbmQoKVxuICAgICAgICAgICAgfVxuICAgICAgICBdO1xuICAgICAgICAvLyBDbGVhciBleGlzdGluZyBjb250ZW50XG4gICAgICAgIHRoaXMuY29tbWFuZE1lbnVDb250YWluZXIuaW5uZXJIVE1MID0gJyc7XG4gICAgICAgIC8vIENyZWF0ZSBtZW51IGl0ZW1zXG4gICAgICAgIGNvbW1hbmRzLmZvckVhY2goY21kID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGl0ZW0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcbiAgICAgICAgICAgIGl0ZW0uY2xhc3NOYW1lID0gJ2NvbW1hbmQtbWVudS1pdGVtJztcbiAgICAgICAgICAgIGNvbnN0IGxhYmVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XG4gICAgICAgICAgICBsYWJlbC5jbGFzc05hbWUgPSAnY29tbWFuZC1sYWJlbCc7XG4gICAgICAgICAgICBsYWJlbC50ZXh0Q29udGVudCA9IGNtZC5sYWJlbDtcbiAgICAgICAgICAgIGNvbnN0IGRlc2MgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcbiAgICAgICAgICAgIGRlc2MuY2xhc3NOYW1lID0gJ2NvbW1hbmQtZGVzY3JpcHRpb24nO1xuICAgICAgICAgICAgZGVzYy50ZXh0Q29udGVudCA9IGNtZC5kZXNjcmlwdGlvbjtcbiAgICAgICAgICAgIGl0ZW0uYXBwZW5kQ2hpbGQobGFiZWwpO1xuICAgICAgICAgICAgaXRlbS5hcHBlbmRDaGlsZChkZXNjKTtcbiAgICAgICAgICAgIGl0ZW0uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgY21kLmFjdGlvbigpO1xuICAgICAgICAgICAgICAgIHRoaXMuaGlkZUNvbW1hbmRNZW51KCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHRoaXMuY29tbWFuZE1lbnVDb250YWluZXIuYXBwZW5kQ2hpbGQoaXRlbSk7XG4gICAgICAgIH0pO1xuICAgICAgICAvLyBQb3NpdGlvbiBhbmQgc2hvdyBtZW51XG4gICAgICAgIHRoaXMuY29tbWFuZE1lbnVDb250YWluZXIuc3R5bGUucG9zaXRpb24gPSAnYWJzb2x1dGUnO1xuICAgICAgICB0aGlzLmNvbW1hbmRNZW51Q29udGFpbmVyLnN0eWxlLmxlZnQgPSBgJHt4fXB4YDtcbiAgICAgICAgdGhpcy5jb21tYW5kTWVudUNvbnRhaW5lci5zdHlsZS50b3AgPSBgJHt5fXB4YDtcbiAgICAgICAgdGhpcy5jb21tYW5kTWVudUNvbnRhaW5lci5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJztcbiAgICAgICAgLy8gQWRkIGNsaWNrIG91dHNpZGUgbGlzdGVuZXJcbiAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCB0aGlzLmhhbmRsZUNsaWNrT3V0c2lkZSk7XG4gICAgfVxuICAgIC8qKlxuICAgICAqIEhpZGVzIHRoZSBjb21tYW5kIG1lbnVcbiAgICAgKi9cbiAgICBoaWRlQ29tbWFuZE1lbnUoKSB7XG4gICAgICAgIHRoaXMuY29tbWFuZE1lbnVDb250YWluZXIuc3R5bGUuZGlzcGxheSA9ICdub25lJztcbiAgICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignY2xpY2snLCB0aGlzLmhhbmRsZUNsaWNrT3V0c2lkZSk7XG4gICAgfVxuICAgIC8qKlxuICAgICAqIEhhbmRsZXMgdGhlIGNvZGUgY29tbWFuZCAtIGluc2VydHMgc2VsZWN0ZWQgY29kZVxuICAgICAqL1xuICAgIGhhbmRsZUNvZGVDb21tYW5kKCkge1xuICAgICAgICB2YXIgX2E7XG4gICAgICAgIGNvbnN0IHNlbGVjdGVkVGV4dCA9IHRoaXMuZ2V0U2VsZWN0ZWRUZXh0KCk7XG4gICAgICAgIGlmIChzZWxlY3RlZFRleHQpIHtcbiAgICAgICAgICAgIHRoaXMuYXBwZW5kVG9JbnB1dChgQGNvZGVcXG4ke3NlbGVjdGVkVGV4dH1gKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIC8vIElmIG5vIHNlbGVjdGlvbiwgZ2V0IHRoZSBlbnRpcmUgY2VsbCBjb250ZW50XG4gICAgICAgICAgICBjb25zdCBjZWxsQ29udGV4dCA9IChfYSA9IGdsb2JhbHNfMS5nbG9iYWxzLmNlbGxDb250ZXh0VHJhY2tlcikgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmdldEN1cnJlbnRDZWxsQ29udGV4dCgpO1xuICAgICAgICAgICAgaWYgKGNlbGxDb250ZXh0KSB7XG4gICAgICAgICAgICAgICAgdGhpcy5hcHBlbmRUb0lucHV0KGBAY29kZVxcbiR7Y2VsbENvbnRleHQudGV4dH1gKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICAvKipcbiAgICAgKiBIYW5kbGVzIHRoZSBjZWxsIGNvbW1hbmQgLSBpbnNlcnRzIGVudGlyZSBjZWxsIGNvbnRlbnRcbiAgICAgKi9cbiAgICBoYW5kbGVDZWxsQ29tbWFuZCgpIHtcbiAgICAgICAgdmFyIF9hO1xuICAgICAgICBjb25zdCBjZWxsQ29udGV4dCA9IChfYSA9IGdsb2JhbHNfMS5nbG9iYWxzLmNlbGxDb250ZXh0VHJhY2tlcikgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmdldEN1cnJlbnRDZWxsQ29udGV4dCgpO1xuICAgICAgICBpZiAoY2VsbENvbnRleHQpIHtcbiAgICAgICAgICAgIHRoaXMuYXBwZW5kVG9JbnB1dChgQGNlbGxcXG4ke2NlbGxDb250ZXh0LnRleHR9YCk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgLyoqXG4gICAgICogQXBwZW5kcyB0ZXh0IHRvIHRoZSBpbnB1dCBmaWVsZCB3aXRoIHByb3BlciBzcGFjaW5nXG4gICAgICovXG4gICAgYXBwZW5kVG9JbnB1dCh0ZXh0KSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCBjdXJyZW50VmFsdWUgPSB0aGlzLmlucHV0RmllbGQudmFsdWU7XG4gICAgICAgICAgICBpZiAoY3VycmVudFZhbHVlKSB7XG4gICAgICAgICAgICAgICAgLy8gSWYgdGhlcmUncyBleGlzdGluZyBjb250ZW50LCBhZGQgYSBuZXdsaW5lIGJlZm9yZSBhcHBlbmRpbmdcbiAgICAgICAgICAgICAgICB0aGlzLmlucHV0RmllbGQudmFsdWUgPSBgJHtjdXJyZW50VmFsdWV9XFxuXFxuJHt0ZXh0fWA7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLmlucHV0RmllbGQudmFsdWUgPSB0ZXh0O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gRm9jdXMgdGhlIGlucHV0IGZpZWxkIGFuZCBtb3ZlIGN1cnNvciB0byBlbmRcbiAgICAgICAgICAgIHRoaXMuaW5wdXRGaWVsZC5mb2N1cygpO1xuICAgICAgICAgICAgdGhpcy5pbnB1dEZpZWxkLnNldFNlbGVjdGlvblJhbmdlKHRoaXMuaW5wdXRGaWVsZC52YWx1ZS5sZW5ndGgsIHRoaXMuaW5wdXRGaWVsZC52YWx1ZS5sZW5ndGgpO1xuICAgICAgICB9XG4gICAgICAgIGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcignRXJyb3IgYXBwZW5kaW5nIHRvIGlucHV0OicsIGVycm9yKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICAvKipcbiAgICAgKiBHZXRzIHRoZSBzZWxlY3RlZCB0ZXh0IGZyb20gY2VsbCBjb250ZXh0XG4gICAgICovXG4gICAgZ2V0U2VsZWN0ZWRUZXh0KCkge1xuICAgICAgICB2YXIgX2E7XG4gICAgICAgIC8vIEdldCB0aGUgY3VycmVudCBhY3RpdmUgY2VsbCBmcm9tIHRoZSB0cmFja2VyXG4gICAgICAgIGNvbnN0IGNlbGwgPSAoX2EgPSBnbG9iYWxzXzEuZ2xvYmFscy5ub3RlYm9va1RyYWNrZXIpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5hY3RpdmVDZWxsO1xuICAgICAgICBpZiAoIWNlbGwgfHwgIWNlbGwuZWRpdG9yKSB7XG4gICAgICAgICAgICByZXR1cm4gJyc7XG4gICAgICAgIH1cbiAgICAgICAgLy8gR2V0IHRoZSBDb2RlTWlycm9yIGVkaXRvciBpbnN0YW5jZVxuICAgICAgICBjb25zdCBlZGl0b3IgPSBjZWxsLmVkaXRvcjtcbiAgICAgICAgY29uc3QgdmlldyA9IGVkaXRvci5lZGl0b3I7XG4gICAgICAgIGlmICghdmlldykge1xuICAgICAgICAgICAgcmV0dXJuICcnO1xuICAgICAgICB9XG4gICAgICAgIC8vIEdldCB0aGUgc2VsZWN0aW9uIGZyb20gQ29kZU1pcnJvclxuICAgICAgICBjb25zdCBzdGF0ZSA9IHZpZXcuc3RhdGU7XG4gICAgICAgIGNvbnN0IHNlbGVjdGlvbiA9IHN0YXRlLnNlbGVjdGlvbjtcbiAgICAgICAgLy8gSWYgdGhlcmUncyBubyBzZWxlY3Rpb24sIHJldHVybiBlbXB0eSBzdHJpbmdcbiAgICAgICAgaWYgKHNlbGVjdGlvbi5tYWluLmVtcHR5KSB7XG4gICAgICAgICAgICByZXR1cm4gJyc7XG4gICAgICAgIH1cbiAgICAgICAgLy8gR2V0IHRoZSBzZWxlY3RlZCB0ZXh0XG4gICAgICAgIGNvbnN0IGZyb20gPSBzZWxlY3Rpb24ubWFpbi5mcm9tO1xuICAgICAgICBjb25zdCB0byA9IHNlbGVjdGlvbi5tYWluLnRvO1xuICAgICAgICByZXR1cm4gc3RhdGUuZG9jLnNsaWNlU3RyaW5nKGZyb20sIHRvKTtcbiAgICB9XG59XG5leHBvcnRzLlNpbXBsZVNpZGViYXJXaWRnZXQgPSBTaW1wbGVTaWRlYmFyV2lkZ2V0O1xuIl0sIm5hbWVzIjpbXSwic291cmNlUm9vdCI6IiJ9